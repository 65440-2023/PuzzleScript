if("function"!==typeof Blob||"undefined"===typeof URL)if("function"===typeof Blob&&"undefined"!==typeof webkitURL)var URL=webkitURL;else var Blob=function(a){var b=a.BlobBuilder||a.WebKitBlobBuilder||a.MozBlobBuilder||a.MSBlobBuilder||function(a){var b=function(a){return Object.prototype.toString.call(a).match(/^\[object\s(.*)\]$/)[1]},d=function(){this.data=[]},h=function(a,b,c){this.data=a;this.size=a.length;this.type=b;this.encoding=c},m=d.prototype,l=h.prototype,p=a.FileReaderSync,t=function(a){this.code=
this[this.name=a]},r="NOT_FOUND_ERR SECURITY_ERR ABORT_ERR NOT_READABLE_ERR ENCODING_ERR NO_MODIFICATION_ALLOWED_ERR INVALID_STATE_ERR SYNTAX_ERR".split(" "),v=r.length,w=a.URL||a.webkitURL||a,C=w.createObjectURL,A=w.revokeObjectURL,s=w,k=a.btoa,u=a.atob,D=!1,q=function(a){D=!a},z=a.ArrayBuffer,G=a.Uint8Array;for(h.fake=l.fake=!0;v--;)t.prototype[r[v]]=v+1;try{G&&q.apply(0,new G(1))}catch(V){}w.createObjectURL||(s=a.URL={});s.createObjectURL=function(a){var b=a.type;null===b&&(b="application/octet-stream");
if(a instanceof h)return b="data:"+b,"base64"===a.encoding?b+";base64,"+a.data:"URI"===a.encoding?b+","+decodeURIComponent(a.data):k?b+";base64,"+k(a.data):b+","+encodeURIComponent(a.data);if(C)return C.call(w,a)};s.revokeObjectURL=function(a){"data:"!==a.substring(0,5)&&A&&A.call(w,a)};m.append=function(a){var c=this.data;if(G&&(a instanceof z||a instanceof G))if(D)c.push(String.fromCharCode.apply(String,new G(a)));else{c="";a=new G(a);for(var d=0,k=a.length;d<k;d++)c+=String.fromCharCode(a[d])}else if("Blob"===
b(a)||"File"===b(a))if(p)d=new p,c.push(d.readAsBinaryString(a));else throw new t("NOT_READABLE_ERR");else a instanceof h?"base64"===a.encoding&&u?c.push(u(a.data)):"URI"===a.encoding?c.push(decodeURIComponent(a.data)):"raw"===a.encoding&&c.push(a.data):("string"!==typeof a&&(a+=""),c.push(unescape(encodeURIComponent(a))))};m.getBlob=function(a){arguments.length||(a=null);return new h(this.data.join(""),a,"raw")};m.toString=function(){return"[object BlobBuilder]"};l.slice=function(a,b,c){var f=arguments.length;
3>f&&(c=null);return new h(this.data.slice(a,1<f?b:this.data.length),c,this.encoding)};l.toString=function(){return"[object Blob]"};return d}(a);return function(a,f){var d=f?f.type||"":"",h=new b;if(a)for(var m=0,l=a.length;m<l;m++)h.append(a[m]);return h.getBlob(d)}}(self);
(function(a){var b=a.Uint8Array;a=a.HTMLCanvasElement;var c=/\s*;\s*base64\s*(?:;|$)/i,f;b&&(f=new b([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]));a&&!a.prototype.toBlob&&(a.prototype.toBlob=function(a,h){h||(h="image/png");if(this.mozGetAsFile)a(this.mozGetAsFile("canvas",h));else{var m=Array.prototype.slice.call(arguments,
1),l=this.toDataURL.apply(this,m),p=l.indexOf(","),m=l.substring(p+1),l=c.test(l.substring(0,p)),t;if(Blob.fake)t=new Blob,t.encoding=l?"base64":"URI",t.data=m,t.size=m.length;else if(b)if(l){t=Blob;for(var l=m.length,p=new b(3*(l/4)|0),r=0,v=0,w=[0,0],C=0,A=0,s,k;l--;)k=m.charCodeAt(r++),s=f[k-43],255!==s&&void 0!==s&&(w[1]=w[0],w[0]=k,A=A<<6|s,C++,4===C&&(p[v++]=A>>>16,61!==w[1]&&(p[v++]=A>>>8),61!==w[0]&&(p[v++]=A),C=0));t=new t([p.buffer],{type:h})}else t=new Blob([decodeURIComponent(m)],{type:h});
a(t)}})})(self);var saveAs=saveAs||navigator.msSaveBlob&&navigator.msSaveBlob.bind(navigator)||function(a){var b=a.document,c=a.URL||a.webkitURL||a,f=b.createElementNS("http://www.w3.org/1999/xhtml","a"),d="download"in f,h=function(c){var f=b.createEvent("MouseEvents");f.initMouseEvent("click",!0,!1,a,0,0,0,0,0,!1,!1,!1,!1,0,null);c.dispatchEvent(f)},m=a.webkitRequestFileSystem,l=a.requestFileSystem||m||a.mozRequestFileSystem,p=function(b){(a.setImmediate||a.setTimeout)(function(){throw b;},0)},t=0,r=[],v=function(a,
b,c){b=[].concat(b);for(var f=b.length;f--;){var d=a["on"+b[f]];if("function"===typeof d)try{d.call(a,c||a)}catch(h){p(h)}}},w=function(b,c){var k=this,p=b.type,w=!1,q,z,C=function(){var c=(a.URL||a.webkitURL||a).createObjectURL(b);r.push(c);return c},V=function(){v(k,["writestart","progress","write","writeend"])},O=function(){if(w||!q)q=C(b);z&&(z.location.href=q);k.readyState=k.DONE;V()},N=function(a){return function(){if(k.readyState!==k.DONE)return a.apply(this,arguments)}},U={create:!0,exclusive:!1},
W;k.readyState=k.INIT;c||(c="download");d?(q=C(b),f.href=q,f.download=c,h(f),k.readyState=k.DONE,V()):(a.chrome&&p&&"application/octet-stream"!==p&&(W=b.slice||b.webkitSlice,b=W.call(b,0,b.size,"application/octet-stream"),w=!0),m&&"download"!==c&&(c+=".download"),z="application/octet-stream"===p||m?a:a.open(),l?(t+=b.size,l(a.TEMPORARY,t,N(function(a){a.root.getDirectory("saved",U,N(function(a){var f=function(){a.getFile(c,U,N(function(a){a.createWriter(N(function(c){c.onwriteend=function(b){z.location.href=
a.toURL();r.push(a);k.readyState=k.DONE;v(k,"writeend",b)};c.onerror=function(){var a=c.error;a.code!==a.ABORT_ERR&&O()};["writestart","progress","write","abort"].forEach(function(a){c["on"+a]=k["on"+a]});c.write(b);k.abort=function(){c.abort();k.readyState=k.DONE};k.readyState=k.WRITING}),O)}),O)};a.getFile(c,{create:!1},N(function(a){a.remove();f()}),N(function(a){a.code===a.NOT_FOUND_ERR?f():O()}))}),O)}),O)):O())},C=w.prototype;C.abort=function(){this.readyState=this.DONE;v(this,"abort")};C.readyState=
C.INIT=0;C.WRITING=1;C.DONE=2;C.error=C.onwritestart=C.onprogress=C.onwrite=C.onabort=C.onerror=C.onwriteend=null;a.addEventListener("unload",function(){for(var a=r.length;a--;){var b=r[a];"string"===typeof b?c.revokeObjectURL(b):b.remove()}r.length=0},!1);return function(a,b){return new w(a,b)}}(self);function encode64(a){for(var b="",c=0,f=a.length,d,h,m,l,p,t;c<f;)d=a.charCodeAt(c++),h=a.charCodeAt(c++),m=a.charCodeAt(c++),l=d>>2,d=(d&3)<<4|h>>4,p=(h&15)<<2|m>>6,t=m&63,isNaN(h)?p=t=64:isNaN(m)&&(t=64),b=b+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(l)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(d)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(p)+"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".charAt(t);
return b};LZWEncoder=function(){var a={},b,c,f,d,h,m,l,p,t=[],r=[],v=0,w=!1,C,A,s,k=0,u=0,D=[0,1,3,7,15,31,63,127,255,511,1023,2047,4095,8191,16383,32767,65535],q,z=[],G=a.LZWEncoder=function(a,k,h,l){b=a;c=k;f=h;d=Math.max(2,l)},V=function(a){for(var b=0;b<a;++b)t[b]=-1},O=a.compress=function(a,b){var c,f,d,k,h,m;C=a;w=!1;l=C;p=(1<<l)-1;A=1<<a-1;s=A+1;v=A+2;q=0;k=U();m=0;for(c=5003;65536>c;c*=2)++m;m=8-m;V(5003);W(A,b);a:for(;-1!=(d=U());)if(c=(d<<12)+k,f=d<<m^k,t[f]==c)k=r[f];else{if(0<=t[f]){h=5003-f;0==
f&&(h=1);do if(0>(f-=h)&&(f+=5003),t[f]==c){k=r[f];continue a}while(0<=t[f])}W(k,b);k=d;4096>v?(r[f]=v++,t[f]=c):(c=b,V(5003),v=A+2,w=!0,W(A,c))}W(k,b);W(s,b)};a.encode=function(a){a.writeByte(d);h=b*c;m=0;O(d+1,a);a.writeByte(0)};var N=function(a){0<q&&(a.writeByte(q),a.writeBytes(z,0,q),q=0)},U=function(){if(0==h)return-1;--h;return f[m++]&255},W=function(a,b){k&=D[u];k=0<u?k|a<<u:a;for(u+=l;8<=u;){var c=k&255,f=b;z[q++]=c;254<=q&&N(f);k>>=8;u-=8}if(v>p||w)w?(p=(1<<(l=C))-1,w=!1):(++l,p=12==l?4096:
(1<<l)-1);if(a==s){for(;0<u;)c=k&255,f=b,z[q++]=c,254<=q&&N(f),k>>=8,u-=8;N(b)}};G.apply(this,arguments);return a};NeuQuant=function(){var a={},b,c,f,d,h,m=[],l=[],p=[],t=[],r=a.NeuQuant=function(a,b,m){c=a;f=b;d=m;h=Array(256);for(a=0;256>a;a++)h[a]=Array(4),b=h[a],b[0]=b[1]=b[2]=(a<<12)/256,p[a]=256,l[a]=0};a.map=function(a,b,c){var f,d,k,l,p,q,r;p=1E3;r=-1;f=m[b];for(d=f-1;256>f||0<=d;)256>f&&(q=h[f],k=q[1]-b,k>=p?f=256:(f++,0>k&&(k=-k),l=q[0]-a,0>l&&(l=-l),k+=l,k<p&&(l=q[2]-c,0>l&&(l=-l),k+=l,k<p&&(p=k,r=q[3])))),0<=d&&(q=h[d],k=b-q[1],k>=p?d=-1:(d--,0>k&&(k=-k),l=q[0]-a,0>l&&(l=-l),k+=l,k<p&&(l=q[2]-c,0>
l&&(l=-l),k+=l,k<p&&(p=k,r=q[3]))));return r};a.process=function(){var a,r,C,A,s,k,u,D,q,z,G,V,O,N;1509>f&&(d=1);b=30+(d-1)/3;V=c;O=0;N=f;G=f/(3*d);z=G/100|0;D=1024;k=2048;u=k>>6;1>=u&&(u=0);for(a=0;a<u;a++)t[a]=D*(256*(u*u-a*a)/(u*u));q=1509>f?3:0!=f%499?1497:0!=f%491?1473:0!=f%487?1461:1509;for(a=0;a<G;){C=(V[O+0]&255)<<4;A=(V[O+1]&255)<<4;s=(V[O+2]&255)<<4;r=C;for(var U=A,W=s,J=void 0,M=void 0,ia=void 0,Q=M=M=void 0,Y=void 0,ba=void 0,F=void 0,na=void 0,F=ba=2147483647,Y=Q=-1,J=0;256>J;J++)na=
h[J],M=na[0]-r,0>M&&(M=-M),ia=na[1]-U,0>ia&&(ia=-ia),M+=ia,ia=na[2]-W,0>ia&&(ia=-ia),M+=ia,M<ba&&(ba=M,Q=J),M-=l[J]>>12,M<F&&(F=M,Y=J),M=p[J]>>10,p[J]-=M,l[J]+=M<<10;p[Q]+=64;l[Q]-=65536;r=Y;U=D;W=A;J=s;Q=h[r];Q[0]-=U*(Q[0]-C)/1024;Q[1]-=U*(Q[1]-W)/1024;Q[2]-=U*(Q[2]-J)/1024;if(0!=u)for(F=ba=Y=Q=J=W=U=void 0,J=r-u,-1>J&&(J=-1),Q=r+u,256<Q&&(Q=256),U=r+1,W=r-1,ba=1;U<Q||W>J;){Y=t[ba++];if(U<Q){F=h[U++];try{F[0]-=Y*(F[0]-C)/262144,F[1]-=Y*(F[1]-A)/262144,F[2]-=Y*(F[2]-s)/262144}catch(ga){}}if(W>J){F=
h[W--];try{F[0]-=Y*(F[0]-C)/262144,F[1]-=Y*(F[1]-A)/262144,F[2]-=Y*(F[2]-s)/262144}catch(Aa){}}}O+=q;O>=N&&(O-=f);a++;0==z&&(z=1);if(0==a%z)for(D-=D/b,k-=k/30,u=k>>6,1>=u&&(u=0),r=0;r<u;r++)t[r]=D*(256*(u*u-r*r)/(u*u))}for(a=0;256>a;a++)h[a][0]>>=4,h[a][1]>>=4,h[a][2]>>=4,h[a][3]=a;for(a=V=G=0;256>a;a++){q=h[a];u=a;D=q[1];for(k=a+1;256>k;k++)z=h[k],z[1]<D&&(u=k,D=z[1]);z=h[u];a!=u&&(k=z[0],z[0]=q[0],q[0]=k,k=z[1],z[1]=q[1],q[1]=k,k=z[2],z[2]=q[2],q[2]=k,k=z[3],z[3]=q[3],q[3]=k);if(D!=G){m[G]=V+a>>
1;for(k=G+1;k<D;k++)m[k]=a;G=D;V=a}}m[G]=V+255>>1;for(k=G+1;256>k;k++)m[k]=255;a=[];k=Array(256);for(u=0;256>u;u++)k[h[u][3]]=u;for(D=u=0;256>D;D++)q=k[D],a[u++]=h[q][0],a[u++]=h[q][1],a[u++]=h[q][2];return a};r.apply(this,arguments);return a};GIFEncoder=function(){function a(){this.bin=[]}for(var b=0,c={};256>b;b++)c[b]=String.fromCharCode(b);a.prototype.getData=function(){for(var a="",b=this.bin.length,f=0;f<b;f++)a+=c[this.bin[f]];return a};a.prototype.writeByte=function(a){this.bin.push(a)};a.prototype.writeUTFBytes=function(a){for(var b=a.length,c=0;c<b;c++)this.writeByte(a.charCodeAt(c))};a.prototype.writeBytes=function(a,b,c){c=c||a.length;for(b=b||0;b<c;b++)this.writeByte(a[b])};var b={},f,d,h=null,m,l=-1,p=0,t=!1,r,v,w,C,A,s=[],
k=7,u=-1,D=!0,q=!1,z=10;b.setDelay=function(a){p=Math.round(a/10)};b.setDispose=function(a){0<=a&&(u=a)};b.setRepeat=function(a){0<=a&&(l=a)};b.setTransparent=function(a){h=a};b.addFrame=function(a,b){if(null==a||!t||null==r)throw Error("Please call start method before calling addFrame");var c=!0;try{b?v=a:(v=a.getImageData(0,0,a.canvas.width,a.canvas.height).data,q||V(a.canvas.width,a.canvas.height));var M=f,G=d;w=[];for(var Q=v,Y=0,ba=0;ba<G;ba++)for(var F=0;F<M;F++){var na=4*ba*M+4*F;w[Y++]=Q[na];
w[Y++]=Q[na+1];w[Y++]=Q[na+2]}var ga=w.length,M=ga/3;C=[];var Aa=new NeuQuant(w,ga,z);A=Aa.process();for(G=ga=0;G<M;G++){var ha=Aa.map(w[ga++]&255,w[ga++]&255,w[ga++]&255);s[ha]=!0;C[G]=ha}w=null;k=7;if(null!=h)if(null==A)m=-1;else{for(var Aa=(h&16711680)>>16,ha=(h&65280)>>8,ga=h&255,M=0,G=16777216,Ba=A.length,Q=0;Q<Ba;){var Ca=Aa-(A[Q++]&255),Da=ha-(A[Q++]&255),ja=ga-(A[Q]&255),Y=Ca*Ca+Da*Da+ja*ja,ba=Q/3;s[ba]&&Y<G&&(G=Y,M=ba);Q++}m=M}D&&(N(f),N(d),r.writeByte(240|k),r.writeByte(0),r.writeByte(0),
O(),0<=l&&(r.writeByte(33),r.writeByte(255),r.writeByte(11),r.writeUTFBytes("NETSCAPE2.0"),r.writeByte(3),r.writeByte(1),N(l),r.writeByte(0)));r.writeByte(33);r.writeByte(249);r.writeByte(4);var wa,X;null==h?X=wa=0:(wa=1,X=2);0<=u&&(X=u&7);r.writeByte(X<<2|0|wa);N(p);r.writeByte(m);r.writeByte(0);r.writeByte(44);N(0);N(0);N(f);N(d);D?r.writeByte(0):r.writeByte(128|k);D||O();(new LZWEncoder(f,d,C,8)).encode(r);D=!1}catch(tb){c=!1}return c};b.finish=function(){if(!t)return!1;var a=!0;t=!1;try{r.writeByte(59)}catch(b){a=
!1}return a};var G=function(){m=0;A=C=w=v=null;D=!0};b.setFrameRate=function(a){15!=a&&(p=Math.round(100/a))};b.setQuality=function(a){1>a&&(a=1);z=a};var V=b.setSize=function(a,b){if(!t||D)f=a,d=b,1>f&&(f=320),1>d&&(d=240),q=!0};b.start=function(){G();var b=!0;r=new a;try{r.writeUTFBytes("GIF89a")}catch(c){b=!1}return t=b};b.cont=function(){G();r=new a;return t=!0};var O=function(){r.writeBytes(A);for(var a=768-A.length,b=0;b<a;b++)r.writeByte(0)},N=function(a){r.writeByte(a&255);r.writeByte(a>>
8&255)};b.stream=function(){return r};b.setProperties=function(a,b){t=a;D=b};return b};var canDump=!0;inputHistory=[];var compiledText;function convertLevelToString(){return JSON.stringify(level)}function dumpTestCase(){var a=compiledText,b=inputHistory.concat([]),c=convertLevelToString(),a=JSON.stringify([a,b,c]);consolePrint("<br><br><br>"+a+"<br><br><br>")};var unitTesting=!1,curlevel=0,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,textImages={},level={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2]};var font={a:[[0,1,1,0,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,
0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,1,0,0],[1,0,1,0,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,
1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,1,0],[0,0,1,0,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,
0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[0,0,0,0,0],[1,0,1,0,0],[1,1,1,0,0],[0,0,1,0,0],[1,1,0,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],
[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[1,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,
0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,
1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],
[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],
[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"\u00a3":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,
1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],
[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],
[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,
0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]]};String.prototype.getBytes=function(){for(var a=[],b=0;b<this.length;b++){var c=this.charCodeAt(b),f=[];do f.push(c&255),c>>=8;while(0<c);a=a.concat(f.reverse())}return a};function RC4(a){this.s=Array(256);for(var b=this.j=this.i=0;256>b;b++)this.s[b]=b;a&&this.mix(a)}RC4.prototype._swap=function(a,b){var c=this.s[a];this.s[a]=this.s[b];this.s[b]=c};RC4.prototype.mix=function(a){a=a.getBytes();for(var b=0,c=0;c<this.s.length;c++)b+=this.s[c]+a[c%a.length],b%=256,this._swap(c,b)};
RC4.prototype.next=function(){this.i=(this.i+1)%256;this.j=(this.j+this.s[this.i])%256;this._swap(this.i,this.j);return this.s[(this.s[this.i]+this.s[this.j])%256]};function RNG(a){null==a?a=(Math.random()+Date.now()).toString():"function"===typeof a?(this.uniform=a,this.nextByte=function(){return~~(256*this.uniform())},a=null):"[object String]"!==Object.prototype.toString.call(a)&&(a=JSON.stringify(a));this._normal=null;this._state=a?new RC4(a):null}RNG.prototype.nextByte=function(){return this._state.next()};
RNG.prototype.uniform=function(){for(var a=0,b=0;7>b;b++)a*=256,a+=this.nextByte();return a/(Math.pow(2,56)-1)};RNG.prototype.random=function(a,b){if(null==a)return this.uniform();null==b&&(b=a,a=0);return a+Math.floor(this.uniform()*(b-a))};
RNG.prototype.normal=function(){if(null!==this._normal){var a=this._normal;this._normal=null;return a}var a=this.uniform()||Math.pow(2,-53),b=this.uniform();this._normal=Math.sqrt(-2*Math.log(a))*Math.sin(2*Math.PI*b);return Math.sqrt(-2*Math.log(a))*Math.cos(2*Math.PI*b)};RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))};RNG.prototype.poisson=function(a){a=Math.exp(-(a||1));var b=0,c=1;do b++,c*=this.uniform();while(c>a);return b-1};
RNG.prototype.gamma=function(a){var b=(1>a?1+a:a)-1/3,c=1/Math.sqrt(9*b);do{do var f=this.normal(),d=Math.pow(c*f+1,3);while(0>=d);var h=this.uniform(),f=Math.pow(f,2)}while(h>=1-0.0331*f*f&&Math.log(h)>=0.5*f+b*(1-d+Math.log(d)));return 1>a?b*d*Math.exp(this.exponential()/-a):b*d};RNG.roller=function(a,b){var c=a.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),f=parseFloat(c[0])||1,d=parseFloat(c[1]),h=parseFloat(c[2])||0;b=b||new RNG;return function(){for(var a=f+h,c=0;c<f;c++)a+=b.random(d);return a}};
RNG.$=new RNG;var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];function FastBase64_Init(){for(var a=0;4096>a;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[a&63]}
function FastBase64_Encode(a){for(var b=a.length,c="",f=0;2<b;)n=a[f]<<16|a[f+1]<<8|a[f+2],c+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[n&4095],b-=3,f+=3;if(0<b){var d=(a[f]&252)>>2,h=(a[f]&3)<<4;1<b&&(h|=(a[++f]&240)>>4);c+=FastBase64_chars[d];c+=FastBase64_chars[h];2==b&&(d=(a[f++]&15)<<2,d|=(a[f]&192)>>6,c+=FastBase64_chars[d]);1==b&&(c+="=");c+="="}return c}FastBase64_Init();function u32ToArray(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}
function u16ToArray(a){return[a&255,a>>8&255]}
function MakeRiff(a,b,c){var f=[],d=[];a={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:b,subChunk2Id:[100,97,116,97],subChunk2Size:0};a.byteRate=a.sampleRate*a.numChannels*a.bitsPerSample>>3;a.blockAlign=a.numChannels*a.bitsPerSample>>3;a.subChunk2Size=c.length;a.chunkSize=36+a.subChunk2Size;f=a.chunkId.concat(u32ToArray(a.chunkSize),a.format,a.subChunk1Id,u32ToArray(a.subChunk1Size),
u16ToArray(a.audioFormat),u16ToArray(a.numChannels),u32ToArray(a.sampleRate),u32ToArray(a.byteRate),u16ToArray(a.blockAlign),u16ToArray(a.bitsPerSample),a.subChunk2Id,u32ToArray(a.subChunk2Size),c);d="data:audio/wav;base64,"+FastBase64_Encode(f);return{dat:[],wav:f,header:a,dataURI:d}}"undefined"!=typeof exports&&(exports.RIFFWAVE=RIFFWAVE);var SOUND_VOL=0.25,SAMPLE_RATE=5512,SAMPLE_SIZE=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES="square sawtooth sine noise triangle breaker".split(" "),masterVolume=1;
function Params(){var a={};a.wave_type=SQUARE;a.p_env_attack=0;a.p_env_sustain=0.3;a.p_env_punch=0;a.p_env_decay=0.4;a.p_base_freq=0.3;a.p_freq_limit=0;a.p_freq_ramp=0;a.p_freq_dramp=0;a.p_vib_strength=0;a.p_vib_speed=0;a.p_arp_mod=0;a.p_arp_speed=0;a.p_duty=0;a.p_duty_ramp=0;a.p_repeat_speed=0;a.p_pha_offset=0;a.p_pha_ramp=0;a.p_lpf_freq=1;a.p_lpf_ramp=0;a.p_lpf_resonance=0;a.p_hpf_freq=0;a.p_hpf_ramp=0;a.sound_vol=0.5;a.sample_rate=44100;a.sample_size=8;return a}var rng,seeded=!1;
function frnd(a){return seeded?rng.uniform()*a:Math.random()*a}function rnd(a){return seeded?Math.floor(rng.uniform()*(a+1)):Math.floor(Math.random()*(a+1))}pickupCoin=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length));3==a.wave_type&&(a.wave_type=0);a.p_base_freq=0.4+frnd(0.5);a.p_env_attack=0;a.p_env_sustain=frnd(0.1);a.p_env_decay=0.1+frnd(0.4);a.p_env_punch=0.3+frnd(0.3);if(rnd(1)){a.p_arp_speed=0.5+frnd(0.2);var b=(frnd(7)|1)+1,c=b+(frnd(7)|1)+2;a.p_arp_mod=+b/+c}return a};
laserShoot=function(){var a=Params();a.wave_type=rnd(2);a.wave_type==SINE&&rnd(1)&&(a.wave_type=rnd(1));a.wave_type=Math.floor(frnd(SHAPES.length));3==a.wave_type&&(a.wave_type=SQUARE);a.p_base_freq=0.5+frnd(0.5);a.p_freq_limit=a.p_base_freq-0.2-frnd(0.6);0.2>a.p_freq_limit&&(a.p_freq_limit=0.2);a.p_freq_ramp=-0.15-frnd(0.2);0==rnd(2)&&(a.p_base_freq=0.3+frnd(0.6),a.p_freq_limit=frnd(0.1),a.p_freq_ramp=-0.35-frnd(0.3));rnd(1)?(a.p_duty=frnd(0.5),a.p_duty_ramp=frnd(0.2)):(a.p_duty=0.4+frnd(0.5),a.p_duty_ramp=
-frnd(0.7));a.p_env_attack=0;a.p_env_sustain=0.1+frnd(0.2);a.p_env_decay=frnd(0.4);rnd(1)&&(a.p_env_punch=frnd(0.3));0==rnd(2)&&(a.p_pha_offset=frnd(0.2),a.p_pha_ramp=-frnd(0.2));rnd(1)&&(a.p_hpf_freq=frnd(0.3));return a};
explosion=function(){var a=Params();rnd(1)?(a.p_base_freq=0.1+frnd(0.4),a.p_freq_ramp=-0.1+frnd(0.4)):(a.p_base_freq=0.2+frnd(0.7),a.p_freq_ramp=-0.2-frnd(0.2));a.p_base_freq*=a.p_base_freq;0==rnd(4)&&(a.p_freq_ramp=0);0==rnd(2)&&(a.p_repeat_speed=0.3+frnd(0.5));a.p_env_attack=0;a.p_env_sustain=0.1+frnd(0.3);a.p_env_decay=frnd(0.5);0==rnd(1)&&(a.p_pha_offset=-0.3+frnd(0.9),a.p_pha_ramp=-frnd(0.3));a.p_env_punch=0.2+frnd(0.6);rnd(1)&&(a.p_vib_strength=frnd(0.7),a.p_vib_speed=frnd(0.6));0==rnd(2)&&
(a.p_arp_speed=0.6+frnd(0.3),a.p_arp_mod=0.8-frnd(1.6));return a};
birdSound=function(){var a=Params();if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3==a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.4304400932967592+frnd(0.2)-0.1,a.p_env_sustain=0.15739346034252394+frnd(0.2)-0.1,a.p_env_punch=0.004488201744871758+frnd(0.2)-0.1,a.p_env_decay=0.07478075528212291+frnd(0.2)-0.1,a.p_base_freq=0.9865265720147687+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.2995018224359539+frnd(0.2)-0.1,0.5>frnd(1)&&(a.p_freq_ramp=0.1+frnd(0.15)),
a.p_freq_dramp=0.004598608156964473+frnd(0.1)-0.05,a.p_vib_strength=-0.2202799497929496+frnd(0.2)-0.1,a.p_vib_speed=0.8084998703158364+frnd(0.2)-0.1,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=-0.9031808754347107+frnd(0.2)-0.1,a.p_duty_ramp=-0.8128699999808343+frnd(0.2)-0.1,a.p_repeat_speed=0.601486018931999+frnd(0.2)-0.1,a.p_pha_offset=-0.9424902314367765+frnd(0.2)-0.1,a.p_pha_ramp=-0.1055482222272056+frnd(0.2)-0.1,a.p_lpf_freq=0.9989765717851521+frnd(0.2)-0.1,a.p_lpf_ramp=-0.25051720626043017+frnd(0.2)-
0.1,a.p_lpf_resonance=0.32777871505494693+frnd(0.2)-0.1,a.p_hpf_freq=0.0023548750981756753+frnd(0.2)-0.1,a.p_hpf_ramp=-0.002375673204842568+frnd(0.2)-0.1,a;if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3==a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.5277795946672003+frnd(0.2)-0.1,a.p_env_sustain=0.18243733568468432+frnd(0.2)-0.1,a.p_env_punch=-0.020159754546840117+frnd(0.2)-0.1,a.p_env_decay=0.1561353422051903+frnd(0.2)-0.1,a.p_base_freq=0.9028855606533718+frnd(0.2)-0.1,a.p_freq_limit=
-0.008842787837148716,a.p_freq_ramp=-0.1,a.p_freq_dramp=-0.012891241489551925,a.p_vib_strength=-0.17923136138403065+frnd(0.2)-0.1,a.p_vib_speed=0.908263385610142+frnd(0.2)-0.1,a.p_arp_mod=0.41690153355414894+frnd(0.2)-0.1,a.p_arp_speed=0.0010766233195860704+frnd(0.2)-0.1,a.p_duty=-0.8735363011184684+frnd(0.2)-0.1,a.p_duty_ramp=-0.7397985366747507+frnd(0.2)-0.1,a.p_repeat_speed=0.0591789344172107+frnd(0.2)-0.1,a.p_pha_offset=-0.9961184222777699+frnd(0.2)-0.1,a.p_pha_ramp=-0.08234769395850523+frnd(0.2)-
0.1,a.p_lpf_freq=0.9412475115697335+frnd(0.2)-0.1,a.p_lpf_ramp=-0.18261358925834958+frnd(0.2)-0.1,a.p_lpf_resonance=0.24541438107389477+frnd(0.2)-0.1,a.p_hpf_freq=-0.01831940280978611+frnd(0.2)-0.1,a.p_hpf_ramp=-0.03857383633171346+frnd(0.2)-0.1,a;if(1>frnd(10))return a.wave_type=Math.floor(frnd(SHAPES.length)),3==a.wave_type&&(a.wave_type=SQUARE),a.p_env_attack=0.4304400932967592+frnd(0.2)-0.1,a.p_env_sustain=0.15739346034252394+frnd(0.2)-0.1,a.p_env_punch=0.004488201744871758+frnd(0.2)-0.1,a.p_env_decay=
0.07478075528212291+frnd(0.2)-0.1,a.p_base_freq=0.9865265720147687+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.2995018224359539+frnd(0.2)-0.1,a.p_freq_dramp=0.004598608156964473+frnd(0.2)-0.1,a.p_vib_strength=-0.2202799497929496+frnd(0.2)-0.1,a.p_vib_speed=0.8084998703158364+frnd(0.2)-0.1,a.p_arp_mod=-0.46410459213693644+frnd(0.2)-0.1,a.p_arp_speed=-0.10955361249587248+frnd(0.2)-0.1,a.p_duty=-0.9031808754347107+frnd(0.2)-0.1,a.p_duty_ramp=-0.8128699999808343+frnd(0.2)-0.1,a.p_repeat_speed=
0.7014860189319991+frnd(0.2)-0.1,a.p_pha_offset=-0.9424902314367765+frnd(0.2)-0.1,a.p_pha_ramp=-0.1055482222272056+frnd(0.2)-0.1,a.p_lpf_freq=0.9989765717851521+frnd(0.2)-0.1,a.p_lpf_ramp=-0.25051720626043017+frnd(0.2)-0.1,a.p_lpf_resonance=0.32777871505494693+frnd(0.2)-0.1,a.p_hpf_freq=0.0023548750981756753+frnd(0.2)-0.1,a.p_hpf_ramp=-0.002375673204842568+frnd(0.2)-0.1,a;if(1<frnd(5))return a.wave_type=Math.floor(frnd(SHAPES.length)),3==a.wave_type&&(a.wave_type=SQUARE),rnd(1)?(a.p_arp_mod=0.2697849293151393+
frnd(0.2)-0.1,a.p_arp_speed=-0.3131172257760948+frnd(0.2)-0.1,a.p_base_freq=0.8090588299313949+frnd(0.2)-0.1,a.p_duty=-0.6210022920964955+frnd(0.2)-0.1,a.p_duty_ramp=-4.3441813553182567E-4+frnd(0.2)-0.1,a.p_env_attack=0.004321877246874195+frnd(0.2)-0.1,a.p_env_decay=0.1+frnd(0.2)-0.1,a.p_env_punch=0.061737781504416146+frnd(0.2)-0.1,a.p_env_sustain=0.4987252564798832+frnd(0.2)-0.1,a.p_freq_dramp=0.31700340314222614+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.163380391341416+frnd(0.2)-
0.1,a.p_hpf_freq=0.4709005021145149+frnd(0.2)-0.1,a.p_hpf_ramp=0.6924667290539194+frnd(0.2)-0.1,a.p_lpf_freq=0.8351398631384511+frnd(0.2)-0.1,a.p_lpf_ramp=0.36616557192873134+frnd(0.2)-0.1,a.p_lpf_resonance=-0.08685777111664439+frnd(0.2)-0.1,a.p_pha_offset=-0.036084571580025544+frnd(0.2)-0.1,a.p_pha_ramp=-0.014806445085568108+frnd(0.2)-0.1,a.p_repeat_speed=-0.8094368475518489+frnd(0.2)-0.1,a.p_vib_speed=0.4496665457171294+frnd(0.2)-0.1,a.p_vib_strength=0.23413762515532424+frnd(0.2)-0.1):(a.p_arp_mod=
-0.35697118026766184+frnd(0.2)-0.1,a.p_arp_speed=0.3581140690559588+frnd(0.2)-0.1,a.p_base_freq=1.3260897696157528+frnd(0.2)-0.1,a.p_duty=-0.30984900436710694+frnd(0.2)-0.1,a.p_duty_ramp=-0.0014374759133411626+frnd(0.2)-0.1,a.p_env_attack=0.3160357835682254+frnd(0.2)-0.1,a.p_env_decay=0.1+frnd(0.2)-0.1,a.p_env_punch=0.24323114016870148+frnd(0.2)-0.1,a.p_env_sustain=0.4+frnd(0.2)-0.1,a.p_freq_dramp=0.2866475886237244+frnd(0.2)-0.1,a.p_freq_limit=0+frnd(0.2)-0.1,a.p_freq_ramp=-0.10956352368742976+frnd(0.2)-
0.1,a.p_hpf_freq=0.20772718017889846+frnd(0.2)-0.1,a.p_hpf_ramp=0.1564090637378835+frnd(0.2)-0.1,a.p_lpf_freq=0.6021372770637031+frnd(0.2)-0.1,a.p_lpf_ramp=0.24016227139979027+frnd(0.2)-0.1,a.p_lpf_resonance=-0.08787383821160144+frnd(0.2)-0.1,a.p_pha_offset=-0.381597686151701+frnd(0.2)-0.1,a.p_pha_ramp=-2.481687661373495E-4+frnd(0.2)-0.1,a.p_repeat_speed=0.07812112809425686+frnd(0.2)-0.1,a.p_vib_speed=-0.13648848579133943+frnd(0.2)-0.1,a.p_vib_strength=0.0018874158972302657+frnd(0.2)-0.1),a;a.wave_type=
Math.floor(frnd(SHAPES.length));if(1==a.wave_type||3==a.wave_type)a.wave_type=2;a.p_base_freq=0.85+frnd(0.15);a.p_freq_ramp=0.3+frnd(0.15);a.p_env_attack=0+frnd(0.09);a.p_env_sustain=0.2+frnd(0.3);a.p_env_decay=0+frnd(0.1);a.p_duty=frnd(2)-1;a.p_duty_ramp=Math.pow(frnd(2)-1,3);a.p_repeat_speed=0.5+frnd(0.1);a.p_pha_offset=-0.3+frnd(0.9);a.p_pha_ramp=-frnd(0.3);a.p_arp_speed=0.4+frnd(0.6);a.p_arp_mod=0.8+frnd(0.1);a.p_lpf_resonance=frnd(2)-1;a.p_lpf_freq=1-Math.pow(frnd(1),3);a.p_lpf_ramp=Math.pow(frnd(2)-
1,3);0.1>a.p_lpf_freq&&-0.05>a.p_lpf_ramp&&(a.p_lpf_ramp=-a.p_lpf_ramp);a.p_hpf_freq=Math.pow(frnd(1),5);a.p_hpf_ramp=Math.pow(frnd(2)-1,5);return a};
pushSound=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length));2==a.wave_type&&a.wave_type++;0==a.wave_type&&(a.wave_type=NOISE);a.p_base_freq=0.1+frnd(0.4);a.p_freq_ramp=0.05+frnd(0.2);a.p_env_attack=0.01+frnd(0.09);a.p_env_sustain=0.01+frnd(0.09);a.p_env_decay=0.01+frnd(0.09);a.p_repeat_speed=0.3+frnd(0.5);a.p_pha_offset=-0.3+frnd(0.9);a.p_pha_ramp=-frnd(0.3);a.p_arp_speed=0.6+frnd(0.3);a.p_arp_mod=0.8-frnd(1.6);return a};
powerUp=function(){var a=Params();rnd(1)?a.wave_type=SAWTOOTH:a.p_duty=frnd(0.6);a.wave_type=Math.floor(frnd(SHAPES.length));3==a.wave_type&&(a.wave_type=SQUARE);rnd(1)?(a.p_base_freq=0.2+frnd(0.3),a.p_freq_ramp=0.1+frnd(0.4),a.p_repeat_speed=0.4+frnd(0.4)):(a.p_base_freq=0.2+frnd(0.3),a.p_freq_ramp=0.05+frnd(0.2),rnd(1)&&(a.p_vib_strength=frnd(0.7),a.p_vib_speed=frnd(0.6)));a.p_env_attack=0;a.p_env_sustain=frnd(0.4);a.p_env_decay=0.1+frnd(0.4);return a};
hitHurt=function(){result=Params();result.wave_type=rnd(2);result.wave_type==SINE&&(result.wave_type=NOISE);result.wave_type==SQUARE&&(result.p_duty=frnd(0.6));result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=0.2+frnd(0.6);result.p_freq_ramp=-0.3-frnd(0.4);result.p_env_attack=0;result.p_env_sustain=frnd(0.1);result.p_env_decay=0.1+frnd(0.2);rnd(1)&&(result.p_hpf_freq=frnd(0.3));return result};
jump=function(){result=Params();result.wave_type=SQUARE;result.wave_type=Math.floor(frnd(SHAPES.length));3==result.wave_type&&(result.wave_type=SQUARE);result.p_duty=frnd(0.6);result.p_base_freq=0.3+frnd(0.3);result.p_freq_ramp=0.1+frnd(0.2);result.p_env_attack=0;result.p_env_sustain=0.1+frnd(0.3);result.p_env_decay=0.1+frnd(0.2);rnd(1)&&(result.p_hpf_freq=frnd(0.3));rnd(1)&&(result.p_lpf_freq=1-frnd(0.6));return result};
blipSelect=function(){result=Params();result.wave_type=rnd(1);result.wave_type=Math.floor(frnd(SHAPES.length));3==result.wave_type&&(result.wave_type=rnd(1));result.wave_type==SQUARE&&(result.p_duty=frnd(0.6));result.p_base_freq=0.2+frnd(0.4);result.p_env_attack=0;result.p_env_sustain=0.1+frnd(0.1);result.p_env_decay=frnd(0.2);result.p_hpf_freq=0.1;return result};
random=function(){result=Params();result.wave_type=Math.floor(frnd(SHAPES.length));result.p_base_freq=Math.pow(frnd(2)-1,2);rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+0.5);result.p_freq_limit=0;result.p_freq_ramp=Math.pow(frnd(2)-1,5);0.7<result.p_base_freq&&0.2<result.p_freq_ramp&&(result.p_freq_ramp=-result.p_freq_ramp);0.2>result.p_base_freq&&-0.05>result.p_freq_ramp&&(result.p_freq_ramp=-result.p_freq_ramp);result.p_freq_dramp=Math.pow(frnd(2)-1,3);result.p_duty=frnd(2)-1;result.p_duty_ramp=
Math.pow(frnd(2)-1,3);result.p_vib_strength=Math.pow(frnd(2)-1,3);result.p_vib_speed=frnd(2)-1;result.p_env_attack=Math.pow(frnd(2)-1,3);result.p_env_sustain=Math.pow(frnd(2)-1,2);result.p_env_decay=frnd(2)-1;result.p_env_punch=Math.pow(frnd(0.8),2);0.2>result.p_env_attack+result.p_env_sustain+result.p_env_decay&&(result.p_env_sustain+=0.2+frnd(0.3),result.p_env_decay+=0.2+frnd(0.3));result.p_lpf_resonance=frnd(2)-1;result.p_lpf_freq=1-Math.pow(frnd(1),3);result.p_lpf_ramp=Math.pow(frnd(2)-1,3);0.1>
result.p_lpf_freq&&-0.05>result.p_lpf_ramp&&(result.p_lpf_ramp=-result.p_lpf_ramp);result.p_hpf_freq=Math.pow(frnd(1),5);result.p_hpf_ramp=Math.pow(frnd(2)-1,5);result.p_pha_offset=Math.pow(frnd(2)-1,3);result.p_pha_ramp=Math.pow(frnd(2)-1,3);result.p_repeat_speed=frnd(2)-1;result.p_arp_speed=frnd(2)-1;result.p_arp_mod=frnd(2)-1;return result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames="pickupCoin laserShoot explosion powerUp hitHurt jump blipSelect pushSound random birdSound".split(" ");
generateFromSeed=function(a){rng=new RNG(a/100|0);var b=generators[a%100%generators.length];seeded=!0;b=b();b.seed=a;seeded=!1;return b};
var generate=function(a){function b(){c=0;f=100/(a.p_base_freq*a.p_base_freq+0.0010);d=Math.floor(f);h=100/(a.p_freq_limit*a.p_freq_limit+0.0010);m=1-0.01*Math.pow(a.p_freq_ramp,3);l=1E-6*-Math.pow(a.p_freq_dramp,3);p=0.5-0.5*a.p_duty;t=5E-5*-a.p_duty_ramp;r=0<=a.p_arp_mod?1-0.9*Math.pow(a.p_arp_mod,2):1+10*Math.pow(a.p_arp_mod,2);v=Math.floor(2E4*Math.pow(1-a.p_arp_speed,2)+32);1==a.p_arp_speed&&(v=0)}var c,f,d,h,m,l,p,t,r,v;b();var w=0,C=0,A=0.1*Math.pow(a.p_lpf_freq,3),s=1+1E-4*a.p_lpf_ramp,k=
5/(1+20*Math.pow(a.p_lpf_resonance,2))*(0.01+A);0.8<k&&(k=0.8);var u=0,D=0.1*Math.pow(a.p_hpf_freq,2),q=1+3E-4*a.p_hpf_ramp,z=0,G=0.01*Math.pow(a.p_vib_speed,2),V=0.5*a.p_vib_strength,O=0,N=0,U=0,W=[Math.floor(1E5*a.p_env_attack*a.p_env_attack),Math.floor(1E5*a.p_env_sustain*a.p_env_sustain),Math.floor(1E5*a.p_env_decay*a.p_env_decay)],J=0,M=1020*Math.pow(a.p_pha_offset,2);0>a.p_pha_offset&&(M=-M);var ia=1*Math.pow(a.p_pha_ramp,2);0>a.p_pha_ramp&&(ia=-ia);for(var Q=Math.abs(Math.floor(M)),Y=0,ba=
[],F=0;1024>F;++F)ba[F]=0;for(var na=[],F=0;32>F;++F)na[F]=2*Math.random()-1;var ga=Math.floor(2E4*Math.pow(1-a.p_repeat_speed,2)+32);0==a.p_repeat_speed&&(ga=0);for(var Aa=2*a.sound_vol,Aa=Math.exp(a.sound_vol)-1,ha=0,Ba=[],Ca=0,Da=0,ja=Math.floor(44100/a.sample_rate),wa=0;;++wa){0!=ga&&++c>=ga&&b();0!=v&&wa>=v&&(v=0,f*=r);m+=l;f*=m;if(f>h&&(f=h,0<a.p_freq_limit))break;O=f;0<V&&(z+=G,O=f*(1+Math.sin(z)*V));d=Math.floor(O);8>d&&(d=8);p+=t;0>p&&(p=0);0.5<p&&(p=0.5);U++;if(U>W[N]&&(U=0,N++,3==N))break;
O=0==N?U/W[0]:1==N?1+2*Math.pow(1-U/W[1],1)*a.p_env_punch:1-U/W[2];M+=ia;Q=Math.abs(Math.floor(M));1023<Q&&(Q=1023);0!=q&&(D*=q,1E-5>D&&(D=1E-5),0.1<D&&(D=0.1));for(var X=0,tb=0;8>tb;++tb){F=0;J++;if(J>=d&&(J%=d,a.wave_type==NOISE))for(F=0;32>F;++F)na[F]=2*Math.random()-1;F=J/d;if(a.wave_type==SQUARE)F=F<p?0.5:-0.5;else if(a.wave_type==SAWTOOTH)F=1-2*F;else if(a.wave_type==SINE)F=Math.sin(2*F*Math.PI);else if(a.wave_type==NOISE)F=na[Math.floor(32*J/d)];else if(a.wave_type==TRIANGLE)F=Math.abs(1-2*
F)-1;else if(a.wave_type==BREAKER)F=Math.abs(1-2*F*F)-1;else throw new Exception("bad wave type! "+a.wave_type);var Na=w,A=A*s;0>A&&(A=0);0.1<A&&(A=0.1);1!=a.p_lpf_freq?(C+=(F-w)*A,C-=C*k):(w=F,C=0);w+=C;u+=w-Na;F=u-=u*D;ba[Y&1023]=F;F+=ba[Y-Q+1024&1023];Y=Y+1&1023;X+=F*O}Ca+=X;++Da>=ja&&(Da=0,X=Ca/ja,Ca=0,X=X/8*masterVolume,X*=Aa,8==a.sample_size?(X=Math.floor(128*(X+1)),255<X?(X=255,++ha):0>X&&(X=0,++ha),Ba.push(X)):(X=Math.floor(32768*X),32768<=X?(X=32767,++ha):-32768>X&&(X=-32768,++ha),Ba.push(X&
255),Ba.push(X>>8&255)))}w=MakeRiff(a.sample_rate,a.sample_size,Ba);w.clipping=ha;return w};if("undefined"!=typeof exports){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params;exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50;
function cacheSeed(a){if(!(a in sfxCache)){var b=generateFromSeed(a);b.sound_vol=SOUND_VOL;b.sample_rate=SAMPLE_RATE;b.sample_size=SAMPLE_SIZE;var b=generate(b),c=new Audio;c.src=b.dataURI;sfxCache[a]=c;for(cachedSeeds.push(a);cachedSeeds.length>CACHE_MAX;)a=cachedSeeds[0],cachedSeeds=cachedSeeds.slice(1),delete sfxCache[a]}}function playSeed(a){unitTesting||(cacheSeed(a),sfxCache[a].cloneNode().play())};window.CodeMirror=function(){function a(g,E){if(!(this instanceof a))return new a(g,E);this.options=E=E||{};for(var e in rc)!E.hasOwnProperty(e)&&rc.hasOwnProperty(e)&&(E[e]=rc[e]);v(E);e=this.display=b(g,"string"==typeof E.value?0:E.value.first);e.wrapper.CodeMirror=this;p(this);E.autofocus&&!sc&&sa(this);this.state={keyMaps:[],overlays:[],modeGen:0,overwrite:!1,focused:!1,suppressEdits:!1,pasteIncoming:!1,draggingText:!1,highlight:new tc};m(this);E.lineWrapping&&(this.display.wrapper.className+=
" CodeMirror-wrap");var H=E.value;"string"==typeof H&&(H=new oa(E.value,E.mode));R(this,Zc)(this,H);da&&setTimeout(ta(Ha,this,!0),20);Yd(this);var B;try{B=document.activeElement==e.input}catch(c){}B||E.autofocus&&!sc?setTimeout(ta(Sa,this),20):uc(this);R(this,function(){for(var g in bb)if(bb.propertyIsEnumerable(g))bb[g](this,E[g],$c);for(g=0;g<vc.length;++g)vc[g](this)})()}function b(g,a){var e={},H=e.input=K("textarea",null,null,"position: absolute; padding: 0; width: 1px; height: 1em; outline: none; font-size: 4px;");
ka?H.style.width="1000px":H.setAttribute("wrap","off");ub&&(H.style.border="1px solid black");H.setAttribute("autocorrect","off");H.setAttribute("autocapitalize","off");H.setAttribute("spellcheck","false");e.inputDiv=K("div",[H],null,"overflow: hidden; position: relative; width: 3px; height: 0px;");e.scrollbarH=K("div",[K("div",null,null,"height: 1px")],"CodeMirror-hscrollbar");e.scrollbarV=K("div",[K("div",null,null,"width: 1px")],"CodeMirror-vscrollbar");e.scrollbarFiller=K("div",null,"CodeMirror-scrollbar-filler");
e.gutterFiller=K("div",null,"CodeMirror-gutter-filler");e.lineDiv=K("div",null,"CodeMirror-code");e.selectionDiv=K("div",null,null,"position: relative; z-index: 1");e.cursor=K("div","\u00a0","CodeMirror-cursor");e.otherCursor=K("div","\u00a0","CodeMirror-cursor CodeMirror-secondarycursor");e.measure=K("div",null,"CodeMirror-measure");e.lineSpace=K("div",[e.measure,e.selectionDiv,e.lineDiv,e.cursor,e.otherCursor],null,"position: relative; outline: none");e.mover=K("div",[K("div",[e.lineSpace],"CodeMirror-lines")],
null,"position: relative");e.sizer=K("div",[e.mover],"CodeMirror-sizer");e.heightForcer=K("div",null,null,"position: absolute; height: "+cb+"px; width: 1px;");e.gutters=K("div",null,"CodeMirror-gutters");e.lineGutter=null;e.scroller=K("div",[e.sizer,e.heightForcer,e.gutters],"CodeMirror-scroll");e.scroller.setAttribute("tabIndex","-1");e.wrapper=K("div",[e.inputDiv,e.scrollbarH,e.scrollbarV,e.scrollbarFiller,e.gutterFiller,e.scroller],"CodeMirror");db&&(e.gutters.style.zIndex=-1,e.scroller.style.paddingRight=
0);g.appendChild?g.appendChild(e.wrapper):g(e.wrapper);ub&&(H.style.width="0px");ka||(e.scroller.draggable=!0);wc?(e.inputDiv.style.height="1px",e.inputDiv.style.position="absolute"):db&&(e.scrollbarH.style.minWidth=e.scrollbarV.style.minWidth="18px");e.viewOffset=e.lastSizeC=0;e.showingFrom=e.showingTo=a;e.lineNumWidth=e.lineNumInnerWidth=e.lineNumChars=null;e.prevInput="";e.alignWidgets=!1;e.pollingFast=!1;e.poll=new tc;e.cachedCharWidth=e.cachedTextHeight=null;e.measureLineCache=[];e.measureLineCachePos=
0;e.inaccurateSelection=!1;e.maxLine=null;e.maxLineLength=0;e.maxLineChanged=!1;e.wheelDX=e.wheelDY=e.wheelStartX=e.wheelStartY=null;return e}function c(g){g.doc.mode=a.getMode(g.options,g.doc.modeOption);g.doc.iter(function(g){g.stateAfter&&(g.stateAfter=null);g.styles&&(g.styles=null)});g.doc.frontier=g.doc.first;M(g,100);g.state.modeGen++;g.curOp&&ea(g)}function f(g){var a=Na(g.display),e=g.options.lineWrapping,H=e&&Math.max(5,g.display.scroller.clientWidth/ad(g.display)-3);return function(b){return Ta(g.doc,
b)?0:e?(Math.ceil(b.text.length/H)||1)*a:a}}function d(g){var a=g.doc,e=f(g);a.iter(function(g){var a=e(g);a!=g.height&&xa(g,a)})}function h(g){var a=Ia[g.options.keyMap],e=a.style;g.display.wrapper.className=g.display.wrapper.className.replace(/\s*cm-keymap-\S+/g,"")+(e?" cm-keymap-"+e:"");g.state.disableInput=a.disableInput}function m(g){g.display.wrapper.className=g.display.wrapper.className.replace(/\s*cm-s-\S+/g,"")+g.options.theme.replace(/(^|\s)\s*/g," cm-s-");ha(g)}function l(g){p(g);ea(g);
setTimeout(function(){A(g)},20)}function p(g){var a=g.display.gutters,e=g.options.gutters;vb(a);for(var H=0;H<e.length;++H){var b=e[H],c=a.appendChild(K("div",null,"CodeMirror-gutter "+b));"CodeMirror-linenumbers"==b&&(g.display.lineGutter=c,c.style.width=(g.display.lineNumWidth||1)+"px")}a.style.display=H?"":"none"}function t(g,a){if(0==a.height)return 0;for(var e=a.text.length,H,b=a;H=eb(b,-1);)H=H.find(),b=L(g,H.from.line),e+=H.from.ch-H.to.ch;for(b=a;H=Ub(b);)H=H.find(),e-=b.text.length-H.from.ch,
b=L(g,H.to.line),e+=b.text.length-H.to.ch;return e}function r(g){var a=g.display,e=g.doc;a.maxLine=L(e,e.first);a.maxLineLength=t(e,a.maxLine);a.maxLineChanged=!0;e.iter(function(g){var b=t(e,g);b>a.maxLineLength&&(a.maxLineLength=b,a.maxLine=g)})}function v(g){for(var a=!1,e=0;e<g.gutters.length;++e)"CodeMirror-linenumbers"==g.gutters[e]&&(g.lineNumbers?a=!0:g.gutters.splice(e--,1));!a&&g.lineNumbers&&g.gutters.push("CodeMirror-linenumbers")}function w(g){var a=g.display,e=g.doc.height+(a.mover.offsetHeight-
a.lineSpace.offsetHeight);a.sizer.style.minHeight=a.heightForcer.style.top=e+"px";a.gutters.style.height=Math.max(e,a.scroller.clientHeight-cb)+"px";var e=Math.max(e,a.scroller.scrollHeight),H=a.scroller.scrollWidth>a.scroller.clientWidth+1,b=e>a.scroller.clientHeight+1;b?(a.scrollbarV.style.display="block",a.scrollbarV.style.bottom=H?wb(a.measure)+"px":"0",a.scrollbarV.firstChild.style.height=e-a.scroller.clientHeight+a.scrollbarV.clientHeight+"px"):(a.scrollbarV.style.display="",a.scrollbarV.firstChild.style.height=
"0");H?(a.scrollbarH.style.display="block",a.scrollbarH.style.right=b?wb(a.measure)+"px":"0",a.scrollbarH.firstChild.style.width=a.scroller.scrollWidth-a.scroller.clientWidth+a.scrollbarH.clientWidth+"px"):(a.scrollbarH.style.display="",a.scrollbarH.firstChild.style.width="0");H&&b?(a.scrollbarFiller.style.display="block",a.scrollbarFiller.style.height=a.scrollbarFiller.style.width=wb(a.measure)+"px"):a.scrollbarFiller.style.display="";H&&g.options.coverGutterNextToScrollbar&&g.options.fixedGutter?
(a.gutterFiller.style.display="block",a.gutterFiller.style.height=wb(a.measure)+"px",a.gutterFiller.style.width=a.gutters.offsetWidth+"px"):a.gutterFiller.style.display="";Zd&&0===wb(a.measure)&&(a.scrollbarV.style.minWidth=a.scrollbarH.style.minHeight=$d?"18px":"12px")}function C(g,a,e){var H=g.scroller.scrollTop,b=g.wrapper.clientHeight;"number"==typeof e?H=e:e&&(H=e.top,b=e.bottom-e.top);H=Math.floor(H-g.lineSpace.offsetTop);g=Math.ceil(H+b);return{from:xb(a,H),to:xb(a,g)}}function A(g){var a=
g.display;if(a.alignWidgets||a.gutters.firstChild&&g.options.fixedGutter){for(var e=k(a)-a.scroller.scrollLeft+g.doc.scrollLeft,H=a.gutters.offsetWidth,b=e+"px",c=a.lineDiv.firstChild;c;c=c.nextSibling)if(c.alignable)for(var f=0,d=c.alignable;f<d.length;++f)d[f].style.left=b;g.options.fixedGutter&&(a.gutters.style.left=e+H+"px")}}function s(g){if(!g.options.lineNumbers)return!1;var a=g.doc,a=String(g.options.lineNumberFormatter(a.first+a.size-1+g.options.firstLineNumber));g=g.display;if(a.length!=
g.lineNumChars){var e=g.measure.appendChild(K("div",[K("div",a)],"CodeMirror-linenumber CodeMirror-gutter-elt")),H=e.firstChild.offsetWidth,e=e.offsetWidth-H;g.lineGutter.style.width="";g.lineNumInnerWidth=Math.max(H,g.lineGutter.offsetWidth-e);g.lineNumWidth=g.lineNumInnerWidth+e;g.lineNumChars=g.lineNumInnerWidth?a.length:-1;g.lineGutter.style.width=g.lineNumWidth+"px";return!0}return!1}function k(g){return ca(g.scroller).left-ca(g.sizer).left}function u(g,a,e,H){for(var b=g.display.showingFrom,
c=g.display.showingTo,f,d=C(g.display,g.doc,e);D(g,a,d,H);){H=!1;f=!0;U(g);w(g);e&&(e=Math.min(g.display.scroller.scrollHeight-g.display.scroller.clientHeight,"number"==typeof e?e:e.top));d=C(g.display,g.doc,e);if(d.from>=g.display.showingFrom&&d.to<=g.display.showingTo)break;a=[]}f&&(ra(g,"update",g),g.display.showingFrom==b&&g.display.showingTo==c||ra(g,"viewportChange",g,g.display.showingFrom,g.display.showingTo));return f}function D(g,a,e,H){var b=g.display,c=g.doc;if(!b.wrapper.clientWidth)b.showingFrom=
b.showingTo=c.first,b.viewOffset=0;else if(H||!(0==a.length&&e.from>b.showingFrom&&e.to<b.showingTo)){s(g)&&(a=[{from:c.first,to:c.first+c.size}]);var f=b.sizer.style.marginLeft=b.gutters.offsetWidth+"px";b.scrollbarH.style.left=g.options.fixedGutter?f:"0";f=Infinity;if(g.options.lineNumbers)for(var d=0;d<a.length;++d)a[d].diff&&a[d].from<f&&(f=a[d].from);var d=c.first+c.size,k=Math.max(e.from-g.options.viewportMargin,c.first);e=Math.min(d,e.to+g.options.viewportMargin);b.showingFrom<k&&20>k-b.showingFrom&&
(k=Math.max(c.first,b.showingFrom));b.showingTo>e&&20>b.showingTo-e&&(e=Math.min(d,b.showingTo));if(yb)for(k=ua(Ja(c,L(c,k)));e<d&&Ta(c,L(c,e));)++e;var h=[{from:Math.max(b.showingFrom,c.first),to:Math.min(b.showingTo,d)}],h=h[0].from>=h[0].to?[]:G(h,a);if(yb)for(d=0;d<h.length;++d){a=h[d];for(var l;l=Ub(L(c,a.to-1));)if(l=l.find().from.line,l>a.from)a.to=l;else{h.splice(d--,1);break}}for(d=c=0;d<h.length;++d)a=h[d],a.from<k&&(a.from=k),a.to>e&&(a.to=e),a.from>=a.to?h.splice(d--,1):c+=a.to-a.from;
if(H||c!=e-k||k!=b.showingFrom||e!=b.showingTo){h.sort(function(g,a){return g.from-a.from});try{var m=document.activeElement}catch(p){}c<0.7*(e-k)&&(b.lineDiv.style.display="none");O(g,k,e,h,f);b.lineDiv.style.display="";m&&document.activeElement!=m&&m.offsetHeight&&m.focus();if(k!=b.showingFrom||e!=b.showingTo||b.lastSizeC!=b.wrapper.clientHeight)b.lastSizeC=b.wrapper.clientHeight,M(g,400);b.showingFrom=k;b.showingTo=e;q(g);z(g);return!0}z(g)}}function q(g){g=g.display;for(var a=g.lineDiv.offsetTop,
e=g.lineDiv.firstChild,b;e;e=e.nextSibling)if(e.lineObj){if(db){var B=e.offsetTop+e.offsetHeight;b=B-a;a=B}else b=ca(e),b=b.bottom-b.top;B=e.lineObj.height-b;2>b&&(b=Na(g));if(0.0010<B||-0.0010>B)if(xa(e.lineObj,b),b=e.lineObj.widgets)for(B=0;B<b.length;++B)b[B].height=b[B].node.offsetHeight}}function z(g){var a=g.display.viewOffset=zb(g,L(g.doc,g.display.showingFrom));g.display.mover.style.top=a+"px"}function G(g,a){for(var e=0,b=a.length||0;e<b;++e){for(var B=a[e],c=[],f=B.diff||0,d=0,k=g.length;d<
k;++d){var h=g[d];B.to<=h.from&&B.diff?c.push({from:h.from+f,to:h.to+f}):B.to<=h.from||B.from>=h.to?c.push(h):(B.from>h.from&&c.push({from:h.from,to:B.from}),B.to<h.to&&c.push({from:B.to+f,to:h.to+f}))}g=c}return g}function V(g){for(var a=g.display,e={},b={},B=a.gutters.firstChild,c=0;B;B=B.nextSibling,++c)e[g.options.gutters[c]]=B.offsetLeft,b[g.options.gutters[c]]=B.offsetWidth;return{fixedPos:k(a),gutterTotalWidth:a.gutters.offsetWidth,gutterLeft:e,gutterWidth:b,wrapperWidth:a.wrapper.clientWidth}}
function O(g,a,e,b,B){function c(a){var E=a.nextSibling;ka&&fb&&g.display.currentWheelTarget==a?(a.style.display="none",a.lineObj=null):a.parentNode.removeChild(a);return E}var f=V(g),d=g.display,k=g.options.lineNumbers;b.length||ka&&g.display.currentWheelTarget||vb(d.lineDiv);var h=d.lineDiv,l=h.firstChild,m=b.shift(),p=a;for(g.doc.iter(a,e,function(a){m&&m.to==p&&(m=b.shift());if(Ta(g.doc,a)){if(0!=a.height&&xa(a,0),a.widgets&&l&&l.previousSibling)for(var E=0;E<a.widgets.length;++E){var e=a.widgets[E];
if(e.showIfHidden){var d=l.previousSibling;if(/pre/i.test(d.nodeName)){var aa=K("div",null,null,"position: relative");d.parentNode.replaceChild(aa,d);aa.appendChild(d);d=aa}aa=d.appendChild(K("div",[e.node],"CodeMirror-linewidget"));e.handleMouseEvents||(aa.ignoreEvents=!0);N(e,aa,d,f)}}}else if(m&&m.from<=p&&m.to>p){for(;l.lineObj!=a;)l=c(l);k&&B<=p&&l.lineNumber&&bd(l.lineNumber,String(g.options.lineNumberFormatter(p+g.options.firstLineNumber)));l=l.nextSibling}else{if(a.widgets)for(var aa=0,r=
l;r&&20>aa;++aa,r=r.nextSibling)if(r.lineObj==a&&/div/i.test(r.nodeName)){E=r;break}var aa=g,q=p,s=E,r=xc(aa,a),t=a.gutterMarkers,u=aa.display;if(aa.options.lineNumbers||t||a.bgClass||a.wrapClass||a.widgets){if(s){s.alignable=null;for(var v=!0,z=0,A=null,w=s.firstChild,C;w;w=C)if(C=w.nextSibling,/\bCodeMirror-linewidget\b/.test(w.className)){for(var D=0;D<a.widgets.length;++D){var J=a.widgets[D];if(J.node==w.firstChild){J.above||A||(A=w);N(J,w,s,f);++z;break}}if(D==a.widgets.length){v=!1;break}}else s.removeChild(w);
s.insertBefore(r,A);v&&z==a.widgets.length&&(e=s,s.className=a.wrapClass||"")}e||(e=K("div",null,a.wrapClass,"position: relative"),e.appendChild(r));a.bgClass&&e.insertBefore(K("div",null,a.bgClass+" CodeMirror-linebackground"),e.firstChild);if(aa.options.lineNumbers||t)if(d=e.insertBefore(K("div",null,null,"position: absolute; left: "+(aa.options.fixedGutter?f.fixedPos:-f.gutterTotalWidth)+"px"),e.firstChild),aa.options.fixedGutter&&(e.alignable||(e.alignable=[])).push(d),!aa.options.lineNumbers||
t&&t["CodeMirror-linenumbers"]||(e.lineNumber=d.appendChild(K("div",String(aa.options.lineNumberFormatter(q+aa.options.firstLineNumber)),"CodeMirror-linenumber CodeMirror-gutter-elt","left: "+f.gutterLeft["CodeMirror-linenumbers"]+"px; width: "+u.lineNumInnerWidth+"px"))),t)for(D=0;D<aa.options.gutters.length;++D)J=aa.options.gutters[D],(q=t.hasOwnProperty(J)&&t[J])&&d.appendChild(K("div",[q],"CodeMirror-gutter-elt","left: "+f.gutterLeft[J]+"px; width: "+f.gutterWidth[J]+"px"));db&&(e.style.zIndex=
2);if(a.widgets&&e!=s)for(D=0,s=a.widgets;D<s.length;++D)J=s[D],t=K("div",[J.node],"CodeMirror-linewidget"),J.handleMouseEvents||(t.ignoreEvents=!0),N(J,t,e,f),J.above?e.insertBefore(t,aa.options.lineNumbers&&0!=a.height?d:r):e.appendChild(t),ra(J,"redraw")}else e=r;if(e!=E)h.insertBefore(e,l);else{for(;l!=E;)l=c(l);l=l.nextSibling}e.lineObj=a}++p});l;)l=c(l)}function N(g,a,e,b){g.noHScroll&&((e.alignable||(e.alignable=[])).push(a),e=b.wrapperWidth,a.style.left=b.fixedPos+"px",g.coverGutter||(e-=
b.gutterTotalWidth,a.style.paddingLeft=b.gutterTotalWidth+"px"),a.style.width=e+"px");g.coverGutter&&(a.style.zIndex=5,a.style.position="relative",g.noHScroll||(a.style.marginLeft=-b.gutterTotalWidth+"px"))}function U(g){var a=g.display,e=Z(g.doc.sel.from,g.doc.sel.to);if(e||g.options.showCursorWhenSelecting){var b=g.display,B=ja(g,g.doc.sel.head,"div");b.cursor.style.left=B.left+"px";b.cursor.style.top=B.top+"px";b.cursor.style.height=Math.max(0,B.bottom-B.top)*g.options.cursorHeight+"px";b.cursor.style.display=
"";B.other?(b.otherCursor.style.display="",b.otherCursor.style.left=B.other.left+"px",b.otherCursor.style.top=B.other.top+"px",b.otherCursor.style.height=0.85*(B.other.bottom-B.other.top)+"px"):b.otherCursor.style.display="none"}else a.cursor.style.display=a.otherCursor.style.display="none";e?a.selectionDiv.style.display="none":W(g);g.options.moveInputWithCursor&&(g=ja(g,g.doc.sel.head,"div"),e=ca(a.wrapper),b=ca(a.lineDiv),a.inputDiv.style.top=Math.max(0,Math.min(a.wrapper.clientHeight-10,g.top+
b.top-e.top))+"px",a.inputDiv.style.left=Math.max(0,Math.min(a.wrapper.clientWidth-10,g.left+b.left-e.left))+"px")}function W(g){function a(g,E,e,b){0>E&&(E=0);f.appendChild(K("div",null,"CodeMirror-selected","position: absolute; left: "+g+"px; top: "+E+"px; width: "+(null==e?d-g:e)+"px; height: "+(b-E)+"px"))}function e(e,b,H){var c=L(B,e),f=c.text.length,$a,ab;ae(Ea(c),b||0,null==H?f:H,function(B,h,l){var m=Da(g,I(e,B),"div",c,"left"),pa,r;B==h?(pa=m,l=r=m.left):(pa=Da(g,I(e,h-1),"div",c,"right"),
"rtl"==l&&(l=m,m=pa,pa=l),l=m.left,r=pa.right);null==b&&0==B&&(l=k);3<pa.top-m.top&&(a(l,m.top,null,m.bottom),l=k,m.bottom<pa.top&&a(l,m.bottom,null,pa.top));null==H&&h==f&&(r=d);if(!$a||m.top<$a.top||m.top==$a.top&&m.left<$a.left)$a=m;if(!ab||pa.bottom>ab.bottom||pa.bottom==ab.bottom&&pa.right>ab.right)ab=pa;l<k+1&&(l=k);a(l,pa.top,r-l,pa.bottom)});return{start:$a,end:ab}}var b=g.display,B=g.doc,c=g.doc.sel,f=document.createDocumentFragment(),d=b.lineSpace.offsetWidth,k=Fa(g.display.measure,K("pre",
null,null,"text-align: left")).appendChild(K("span","x")).offsetLeft;if(c.from.line==c.to.line)e(c.from.line,c.from.ch,c.to.ch);else{var h=L(B,c.from.line),l=L(B,c.to.line),l=Ja(B,h)==Ja(B,l),h=e(c.from.line,c.from.ch,l?h.text.length:null).end,c=e(c.to.line,l?0:null,c.to.ch).start;l&&(h.top<c.top-2?(a(h.right,h.top,null,h.bottom),a(k,c.top,c.left,c.bottom)):a(h.right,h.top,c.left-h.right,h.bottom));h.bottom<c.top&&a(k,h.bottom,null,c.top)}Fa(b.selectionDiv,f);b.selectionDiv.style.display=""}function J(g){if(g.state.focused){var a=
g.display;clearInterval(a.blinker);var e=!0;a.cursor.style.visibility=a.otherCursor.style.visibility="";0<g.options.cursorBlinkRate&&(a.blinker=setInterval(function(){a.cursor.style.visibility=a.otherCursor.style.visibility=(e=!e)?"":"hidden"},g.options.cursorBlinkRate))}}function M(g,a){g.doc.mode.startState&&g.doc.frontier<g.display.showingTo&&g.state.highlight.set(a,ta(ia,g))}function ia(g){var a=g.doc;a.frontier<a.first&&(a.frontier=a.first);if(!(a.frontier>=g.display.showingTo)){var e=+new Date+
g.options.workTime,b=gb(a.mode,Y(g,a.frontier)),B=[],c;a.iter(a.frontier,Math.min(a.first+a.size,g.display.showingTo+500),function(f){if(a.frontier>=g.display.showingFrom){var d=f.styles;f.styles=cd(g,f,b);for(var h=!d||d.length!=f.styles.length,k=0;!h&&k<d.length;++k)h=d[k]!=f.styles[k];h&&(c&&c.end==a.frontier?c.end++:B.push(c={start:a.frontier,end:a.frontier+1}));f.stateAfter=gb(a.mode,b)}else dd(g,f,b),f.stateAfter=0==a.frontier%5?gb(a.mode,b):null;++a.frontier;if(+new Date>e)return M(g,g.options.workDelay),
!0});B.length&&R(g,function(){for(var g=0;g<B.length;++g)ea(this,B[g].start,B[g].end)})()}}function Q(g,a,e){var b,B,c=g.doc,f=a;for(a-=g.doc.mode.innerMode?1E3:100;f>a;--f){if(f<=c.first)return c.first;var d=L(c,f-1);if(d.stateAfter&&(!e||f<=c.frontier))return f;d=hb(d.text,null,g.options.tabSize);if(null==B||b>d)B=f-1,b=d}return B}function Y(g,a,e){var b=g.doc,B=g.display;if(!b.mode.startState)return!0;var c=Q(g,a,e),f=c>b.first&&L(b,c-1).stateAfter,f=f?gb(b.mode,f):ed(b.mode);b.iter(c,a,function(e){dd(g,
e,f);e.stateAfter=c==a-1||0==c%5||c>=B.showingFrom&&c<B.showingTo?gb(b.mode,f):null;++c});return f}function ba(g,a,e,b,B){var c=-1;b=b||ga(g,a);for(g=e;;g+=c){var f=b[g];if(f)break;0>c&&0==g&&(c=1)}B=g>e?"left":g<e?"right":B;"left"==B&&f.leftSide?f=f.leftSide:"right"==B&&f.rightSide&&(f=f.rightSide);return{left:g<e?f.right:f.left,right:g>e?f.left:f.right,top:f.top,bottom:f.bottom}}function F(g,a){for(var e=g.display.measureLineCache,b=0;b<e.length;++b){var B=e[b];if(B.text==a.text&&B.markedSpans==
a.markedSpans&&g.display.scroller.clientWidth==B.width&&B.classes==a.textClass+"|"+a.bgClass+"|"+a.wrapClass)return B}}function na(g,a){var e=F(g,a);e&&(e.text=e.measure=e.markedSpans=null)}function ga(g,a){var e=F(g,a);if(e)return e.measure;var e=Aa(g,a),b=g.display.measureLineCache,B={text:a.text,width:g.display.scroller.clientWidth,markedSpans:a.markedSpans,measure:e,classes:a.textClass+"|"+a.bgClass+"|"+a.wrapClass};16==b.length?b[++g.display.measureLineCachePos%16]=B:b.push(B);return e}function Aa(g,
a){function e(g){var a=g.top-p.top,E=g.bottom-p.top;E>s&&(E=s);0>a&&(a=0);for(var e=q.length-2;0<=e;e-=2){var b=q[e],H=q[e+1];if(!(b>E||H<a)&&(b<=a&&H>=E||a<=b&&E>=H||Math.min(E,H)-Math.max(a,b)>=E-a>>1)){q[e]=Math.min(a,b);q[e+1]=Math.max(E,H);break}}0>e&&(e=q.length,q.push(a,E));return{left:g.left-p.left,right:g.right-p.left,top:e,bottom:null}}function b(g){g.bottom=q[g.top+1];g.top=q[g.top]}var B=g.display,c=fd(a.text.length),f=xc(g,a,c,!0);if(da&&!db&&!g.options.lineWrapping&&100<f.childNodes.length){for(var d=
document.createDocumentFragment(),h=f.childNodes.length,k=0,l=Math.ceil(h/10);k<l;++k){for(var m=K("div",null,null,"display: inline-block"),r=0;10>r&&h;++r)m.appendChild(f.firstChild),--h;d.appendChild(m)}f.appendChild(d)}Fa(B.measure,f);var p=ca(B.lineDiv),q=[],d=fd(a.text.length),s=f.offsetHeight;va&&B.measure.first!=f&&Fa(B.measure,f);for(k=0;k<c.length;++k)if(B=c[k])f=B,h=null,/\bCodeMirror-widget\b/.test(B.className)&&B.getClientRects&&(1==B.firstChild.nodeType&&(f=B.firstChild),l=f.getClientRects(),
1<l.length&&(h=d[k]=e(l[0]),h.rightSide=e(l[l.length-1]))),h||(h=d[k]=e(ca(f))),B.measureRight&&(h.right=ca(B.measureRight).left),B.leftSide&&(h.leftSide=e(ca(B.leftSide)));vb(g.display.measure);for(k=0;k<d.length;++k)if(B=d[k])b(B),B.leftSide&&b(B.leftSide),B.rightSide&&b(B.rightSide);return d}function ha(g){g.display.measureLineCache.length=g.display.measureLineCachePos=0;g.display.cachedCharWidth=g.display.cachedTextHeight=null;g.options.lineWrapping||(g.display.maxLineChanged=!0);g.display.lineNumChars=
null}function Ba(g,a,e,b){if(a.widgets)for(var B=0;B<a.widgets.length;++B)if(a.widgets[B].above){var c=Vb(a.widgets[B]);e.top+=c;e.bottom+=c}if("line"==b)return e;b||(b="local");a=zb(g,a);a="local"==b?a+g.display.lineSpace.offsetTop:a-g.display.viewOffset;if("page"==b||"window"==b)g=ca(g.display.lineSpace),a+=g.top+("window"==b?0:window.pageYOffset||(document.documentElement||document.body).scrollTop),b=g.left+("window"==b?0:window.pageXOffset||(document.documentElement||document.body).scrollLeft),
e.left+=b,e.right+=b;e.top+=a;e.bottom+=a;return e}function Ca(g,a,e){if("div"==e)return a;var b=a.left;a=a.top;"page"==e?(b-=window.pageXOffset||(document.documentElement||document.body).scrollLeft,a-=window.pageYOffset||(document.documentElement||document.body).scrollTop):"local"!=e&&e||(e=ca(g.display.sizer),b+=e.left,a+=e.top);g=ca(g.display.lineSpace);return{left:b-g.left,top:a-g.top}}function Da(g,a,e,b,B){b||(b=L(g.doc,a.line));return Ba(g,b,ba(g,b,a.ch,null,B),e)}function ja(g,a,e,b,B){function c(a,
E){var f=ba(g,b,a,B,E?"right":"left");E?f.left=f.right:f.right=f.left;return Ba(g,b,f,e)}function f(g,a){var E=d[a],e=E.level%2;g==(E.level%2?E.to:E.from)&&a&&E.level<d[a-1].level?(E=d[--a],g=yc(E)-(E.level%2?0:1),e=!0):g==yc(E)&&a<d.length-1&&E.level<d[a+1].level&&(E=d[++a],g=(E.level%2?E.to:E.from)-E.level%2,e=!1);return e&&g==E.to&&g>E.from?c(g-1):c(g,e)}b=b||L(g.doc,a.line);B||(B=ga(g,b));var d=Ea(b);a=a.ch;if(!d)return c(a);var k=zc(d,a),k=f(a,k);null!=ib&&(k.other=f(a,ib));return k}function wa(g,
a,e,b){g=new I(g,a);g.xRel=b;e&&(g.outside=!0);return g}function X(g,a,e){var b=g.doc;e+=g.display.viewOffset;if(0>e)return wa(b.first,0,!0,-1);var c=xb(b,e),f=b.first+b.size-1;if(c>f)return wa(b.first+b.size-1,L(b,f).text.length,!0,1);for(0>a&&(a=0);;){var f=L(b,c),c=tb(g,f,c,a,e),d=(f=Ub(f))&&f.find();if(f&&(c.ch>d.from.ch||c.ch==d.from.ch&&0<c.xRel))c=d.to.line;else return c}}function tb(g,a,e,b,c){function f(b){b=ja(g,I(e,b),"line",a,l);k=!0;if(d>b.bottom)return b.left-h;if(d<b.top)return b.left+
h;k=!1;return b.left}var d=c-zb(g,a),k=!1,h=2*g.display.wrapper.clientWidth,l=ga(g,a),m=Ea(a),r=a.text.length;c=Wb(a);var p=Xb(a),q=f(c),s=k,t=f(p),u=k;if(b>t)return wa(e,p,u,1);for(;;){if(m?p==c||p==Ac(a,c,1):1>=p-c){m=b<q||b-q<=t-b?c:p;for(b-=m==c?q:t;Bc.test(a.text.charAt(m));)++m;return wa(e,m,m==c?s:u,0>b?-1:b?1:0)}var v=Math.ceil(r/2),z=c+v;if(m)for(var z=c,w=0;w<v;++w)z=Ac(a,z,1);w=f(z);if(w>b){p=z;t=w;if(u=k)t+=1E3;r=v}else c=z,q=w,s=k,r-=v}}function Na(g){if(null!=g.cachedTextHeight)return g.cachedTextHeight;
if(null==Ua){Ua=K("pre");for(var a=0;49>a;++a)Ua.appendChild(document.createTextNode("x")),Ua.appendChild(K("br"));Ua.appendChild(document.createTextNode("x"))}Fa(g.measure,Ua);a=Ua.offsetHeight/50;3<a&&(g.cachedTextHeight=a);vb(g.measure);return a||1}function ad(g){if(null!=g.cachedCharWidth)return g.cachedCharWidth;var a=K("span","x"),e=K("pre",[a]);Fa(g.measure,e);a=a.offsetWidth;2<a&&(g.cachedCharWidth=a);return a||10}function jb(g){g.curOp={changes:[],forceUpdate:!1,updateInput:null,userSelChange:null,
textChanged:null,selectionChanged:!1,cursorActivity:!1,updateMaxLine:!1,updateScrollPos:!1,id:++be};Yb++||(Oa=[])}function kb(g){var a=g.curOp,e=g.doc,b=g.display;g.curOp=null;a.updateMaxLine&&r(g);if(b.maxLineChanged&&!g.options.lineWrapping&&b.maxLine){var c;c=b.maxLine;var f=!1;if(c.markedSpans)for(var d=0;d<c.markedSpans;++d){var k=c.markedSpans[d];!k.collapsed||null!=k.to&&k.to!=c.text.length||(f=!0)}(f=!f&&F(g,c))?c=ba(g,c,c.text.length,f.measure,"right").right:(c=xc(g,c,null,!0),f=c.appendChild(Ab(g.display.measure)),
Fa(g.display.measure,c),c=ca(f).right-ca(g.display.lineDiv).left);b.sizer.style.minWidth=Math.max(0,c+3+cb)+"px";b.maxLineChanged=!1;c=Math.max(0,b.sizer.offsetLeft+b.sizer.offsetWidth-b.scroller.clientWidth);c<e.scrollLeft&&!a.updateScrollPos&&lb(g,Math.min(b.scroller.scrollLeft,c),!0)}var h,l;a.updateScrollPos?h=a.updateScrollPos:a.selectionChanged&&b.scroller.clientHeight&&(h=ja(g,e.sel.head),h=Zb(g,h.left,h.top,h.left,h.bottom));if(a.changes.length||a.forceUpdate||h&&null!=h.scrollTop)l=u(g,a.changes,
h&&h.scrollTop,a.forceUpdate),g.display.scroller.offsetHeight&&(g.doc.scrollTop=g.display.scroller.scrollTop);!l&&a.selectionChanged&&U(g);if(a.updateScrollPos)b.scroller.scrollTop=b.scrollbarV.scrollTop=e.scrollTop=h.scrollTop,b.scroller.scrollLeft=b.scrollbarH.scrollLeft=e.scrollLeft=h.scrollLeft,A(g),a.scrollToPos&&gd(g,P(g.doc,a.scrollToPos),a.scrollToPosMargin);else if(h&&(e=gd(g,g.doc.sel.head,g.options.cursorScrollMargin),g.state.focused&&(b=g.display,h=ca(b.sizer),l=null,0>e.top+h.top?l=!0:
e.bottom+h.top>(window.innerHeight||document.documentElement.clientHeight)&&(l=!1),null!=l&&!ce))){if(h="none"==b.cursor.style.display)b.cursor.style.display="",b.cursor.style.left=e.left+"px",b.cursor.style.top=e.top-b.viewOffset+"px";b.cursor.scrollIntoView(l);h&&(b.cursor.style.display="none")}a.selectionChanged&&J(g);g.state.focused&&a.updateInput&&Ha(g,a.userSelChange);e=a.maybeHiddenMarkers;b=a.maybeUnhiddenMarkers;if(e)for(l=0;l<e.length;++l)e[l].lines.length||la(e[l],"hide");if(b)for(l=0;l<
b.length;++l)b[l].lines.length&&la(b[l],"unhide");var m;--Yb||(m=Oa,Oa=null);a.textChanged&&la(g,"change",g,a.textChanged);a.cursorActivity&&la(g,"cursorActivity",g);if(m)for(l=0;l<m.length;++l)m[l]()}function R(g,a){return function(){var e=g||this,b=!e.curOp;b&&jb(e);try{var c=a.apply(e,arguments)}finally{b&&kb(e)}return c}}function Bb(g){return function(){var a=this.cm&&!this.cm.curOp,e;a&&jb(this.cm);try{e=g.apply(this,arguments)}finally{a&&kb(this.cm)}return e}}function Cc(g,a){var e=!g.curOp,
b;e&&jb(g);try{b=a()}finally{e&&kb(g)}return b}function ea(g,a,e,b){null==a&&(a=g.doc.first);null==e&&(e=g.doc.first+g.doc.size);g.curOp.changes.push({from:a,to:e,diff:b})}function $b(g){g.display.pollingFast||g.display.poll.set(g.options.pollInterval,function(){Dc(g);g.state.focused&&$b(g)})}function Cb(g){function a(){Dc(g)||e?(g.display.pollingFast=!1,$b(g)):(e=!0,g.display.poll.set(60,a))}var e=!1;g.display.pollingFast=!0;g.display.poll.set(20,a)}function Dc(g){var a=g.display.input,e=g.display.prevInput,
b=g.doc,c=b.sel;if(!g.state.focused||de(a)||Db(g)||g.state.disableInput)return!1;g.state.pasteIncoming&&g.state.fakedLastChar&&(a.value=a.value.substring(0,a.value.length-1),g.state.fakedLastChar=!1);var f=a.value;if(f==e&&Z(c.from,c.to))return!1;if(da&&!va&&g.display.inputHasSelection===f)return Ha(g,!0),!1;var d=!g.curOp;d&&jb(g);c.shift=!1;for(var h=0,k=Math.min(e.length,f.length);h<k&&e.charCodeAt(h)==f.charCodeAt(h);)++h;k=c.from;c=c.to;h<e.length?k=I(k.line,k.ch-(e.length-h)):g.state.overwrite&&
Z(k,c)&&!g.state.pasteIncoming&&(c=I(c.line,Math.min(L(b,c.line).text.length,c.ch+(f.length-h))));e=g.curOp.updateInput;h={from:k,to:c,text:Va(f.slice(h)),origin:g.state.pasteIncoming?"paste":"+input"};mb(g.doc,h,"end");g.curOp.updateInput=e;ra(g,"inputRead",g,h);1E3<f.length||-1<f.indexOf("\n")?a.value=g.display.prevInput="":g.display.prevInput=f;d&&kb(g);g.state.pasteIncoming=!1;return!0}function Ha(g,a){var e,b,c=g.doc;Z(c.sel.from,c.sel.to)?a&&(g.display.prevInput=g.display.input.value="",da&&
!va&&(g.display.inputHasSelection=null)):(g.display.prevInput="",b=(e=hd&&(100<c.sel.to.line-c.sel.from.line||1E3<(b=g.getSelection()).length))?"-":b||g.getSelection(),g.display.input.value=b,g.state.focused&&id(g.display.input),da&&!va&&(g.display.inputHasSelection=b));g.display.inaccurateSelection=e}function sa(g){"nocursor"==g.options.readOnly||sc&&document.activeElement==g.display.input||g.display.input.focus()}function Db(g){return g.options.readOnly||g.doc.cantEdit}function Yd(g){function a(){g.state.focused&&
setTimeout(ta(sa,g),0)}function e(){null==h&&(h=setTimeout(function(){h=null;d.cachedCharWidth=d.cachedTextHeight=Eb=null;ha(g);Cc(g,ta(ea,g))},100))}function b(){for(var g=d.wrapper.parentNode;g&&g!=document.body;g=g.parentNode);g?setTimeout(b,5E3):Ka(window,"resize",e)}function c(a){Ga(g,a)||g.options.onDragEvent&&g.options.onDragEvent(g,Fb(a))||Gb(a)}function f(){d.inaccurateSelection&&(d.prevInput="",d.inaccurateSelection=!1,d.input.value=g.getSelection(),id(d.input))}var d=g.display;S(d.scroller,
"mousedown",R(g,ee));da?S(d.scroller,"dblclick",R(g,function(a){if(!Ga(g,a)){var E=nb(g,a);!E||jd(g,a)||Wa(g.display,a)||(fa(a),a=Ec(L(g.doc,E.line).text,E),ma(g.doc,a.from,a.to))}})):S(d.scroller,"dblclick",function(a){Ga(g,a)||fa(a)});S(d.lineSpace,"selectstart",function(g){Wa(d,g)||fa(g)});Fc||S(d.scroller,"contextmenu",function(a){kd(g,a)});S(d.scroller,"scroll",function(){d.scroller.clientHeight&&(Hb(g,d.scroller.scrollTop),lb(g,d.scroller.scrollLeft,!0),la(g,"scroll",g))});S(d.scrollbarV,"scroll",
function(){d.scroller.clientHeight&&Hb(g,d.scrollbarV.scrollTop)});S(d.scrollbarH,"scroll",function(){d.scroller.clientHeight&&lb(g,d.scrollbarH.scrollLeft)});S(d.scroller,"mousewheel",function(a){ld(g,a)});S(d.scroller,"DOMMouseScroll",function(a){ld(g,a)});S(d.scrollbarH,"mousedown",a);S(d.scrollbarV,"mousedown",a);S(d.wrapper,"scroll",function(){d.wrapper.scrollTop=d.wrapper.scrollLeft=0});var h;S(window,"resize",e);setTimeout(b,5E3);S(d.input,"keyup",R(g,function(a){Ga(g,a)||g.options.onKeyEvent&&
g.options.onKeyEvent(g,Fb(a))||16!=a.keyCode||(g.doc.sel.shift=!1)}));S(d.input,"input",ta(Cb,g));S(d.input,"keydown",R(g,md));S(d.input,"keypress",R(g,fe));S(d.input,"focus",ta(Sa,g));S(d.input,"blur",ta(uc,g));g.options.dragDrop&&(S(d.scroller,"dragstart",function(a){var E=g;if(da&&(!E.state.draggingText||100>+new Date-nd))Gb(a);else if(!Ga(E,a)&&!Wa(E.display,a)){var e=E.getSelection();a.dataTransfer.setData("Text",e);a.dataTransfer.setDragImage&&!Gc&&(e=K("img",null,null,"position: fixed; left: 0; top: 0;"),
ya&&(e.width=e.height=1,E.display.wrapper.appendChild(e),e._top=e.offsetTop),a.dataTransfer.setDragImage(e,0,0),ya&&e.parentNode.removeChild(e))}}),S(d.scroller,"dragenter",c),S(d.scroller,"dragover",c),S(d.scroller,"drop",R(g,ge)));S(d.scroller,"paste",function(a){Wa(d,a)||(sa(g),Cb(g))});S(d.input,"paste",function(){if(ka&&!(g.state.fakedLastChar||200>new Date-g.state.lastMiddleDown)){var a=d.input.selectionStart,E=d.input.selectionEnd;d.input.value+="$";d.input.selectionStart=a;d.input.selectionEnd=
E;g.state.fakedLastChar=!0}g.state.pasteIncoming=!0;Cb(g)});S(d.input,"cut",f);S(d.input,"copy",f);wc&&S(d.sizer,"mouseup",function(){document.activeElement==d.input&&d.input.blur();sa(g)})}function Wa(g,a){for(var e=a.target||a.srcElement;e!=g.wrapper;e=e.parentNode)if(!e||e.ignoreEvents||e.parentNode==g.sizer&&e!=g.mover)return!0}function nb(g,a,e){var b=g.display;if(!e&&(e=a.target||a.srcElement,e==b.scrollbarH||e==b.scrollbarH.firstChild||e==b.scrollbarV||e==b.scrollbarV.firstChild||e==b.scrollbarFiller||
e==b.gutterFiller))return null;var c,f,b=ca(b.lineSpace);try{c=a.clientX,f=a.clientY}catch(d){return null}return X(g,c-b.left,f-b.top)}function ee(g){function a(g){if(!Z(s,g))if(s=g,"single"==m)ma(c.doc,P(d,k),g);else if(p=P(d,p),q=P(d,q),"double"==m){var E=Ec(L(d,g.line).text,g);$(g,p)?ma(c.doc,E.from,q):ma(c.doc,p,E.to)}else"triple"==m&&($(g,p)?ma(c.doc,q,P(d,I(g.line,0))):ma(c.doc,p,P(d,I(g.line+1,0))))}function e(g){var b=++u,H=nb(c,g,!0);if(H)if(Z(H,r)){var h=g.clientY<t.top?-20:g.clientY>t.bottom?
20:0;h&&setTimeout(R(c,function(){u==b&&(f.scroller.scrollTop+=h,e(g))}),50)}else{c.state.focused||Sa(c);r=H;a(H);var k=C(f,d);(H.line>=k.to||H.line<k.from)&&setTimeout(R(c,function(){u==b&&e(g)}),150)}}function b(g){u=Infinity;fa(g);sa(c);Ka(document,"mousemove",v);Ka(document,"mouseup",z)}if(!Ga(this,g)){var c=this,f=c.display,d=c.doc,h=d.sel;h.shift=g.shiftKey;if(Wa(f,g))ka||(f.scroller.draggable=!1,setTimeout(function(){f.scroller.draggable=!0},100));else if(!jd(c,g)){var k=nb(c,g);switch(od(g)){case 3:Fc&&
kd.call(c,c,g);return;case 2:ka&&(c.state.lastMiddleDown=+new Date);k&&ma(c.doc,k);setTimeout(ta(sa,c),20);fa(g);return}if(k){c.state.focused||Sa(c);var l=+new Date,m="single";ac&&ac.time>l-400&&Z(ac.pos,k)?(m="triple",fa(g),setTimeout(ta(sa,c),20),he(c,k.line)):bc&&bc.time>l-400&&Z(bc.pos,k)?(m="double",ac={time:l,pos:k},fa(g),l=Ec(L(d,k.line).text,k),ma(c.doc,l.from,l.to)):bc={time:l,pos:k};var r=k;if(!c.options.dragDrop||!ie||Db(c)||Z(h.from,h.to)||$(k,h.from)||$(h.to,k)||"single"!=m){fa(g);"single"==
m&&ma(c.doc,P(d,k));var p=h.from,q=h.to,s=k,t=ca(f.wrapper),u=0,v=R(c,function(g){da||od(g)?e(g):b(g)}),z=R(c,b);S(document,"mousemove",v);S(document,"mouseup",z)}else{var w=R(c,function(a){ka&&(f.scroller.draggable=!1);c.state.draggingText=!1;Ka(document,"mouseup",w);Ka(f.scroller,"drop",w);10>Math.abs(g.clientX-a.clientX)+Math.abs(g.clientY-a.clientY)&&(fa(a),ma(c.doc,k),sa(c))});ka&&(f.scroller.draggable=!0);c.state.draggingText=w;f.scroller.dragDrop&&f.scroller.dragDrop();S(document,"mouseup",
w);S(f.scroller,"drop",w)}}else(g.target||g.srcElement)==f.scroller&&fa(g)}}}function jd(g,a){var e=g.display;try{var b=a.clientX,c=a.clientY}catch(f){return!1}if(b>=Math.floor(ca(e.gutters).right))return!1;fa(a);if(!La(g,"gutterClick"))return!0;var d=ca(e.lineDiv);if(c>d.bottom)return!0;c-=d.top-e.viewOffset;for(d=0;d<g.options.gutters.length;++d){var h=e.gutters.childNodes[d];if(h&&ca(h).right>=b){e=xb(g.doc,c);ra(g,"gutterClick",g,e,g.options.gutters[d],a);break}}return!0}function ge(g){var a=
this;if(!(Ga(a,g)||Wa(a.display,g)||a.options.onDragEvent&&a.options.onDragEvent(a,Fb(g)))){fa(g);da&&(nd=+new Date);var e=nb(a,g,!0),b=g.dataTransfer.files;if(e&&!Db(a))if(b&&b.length&&window.FileReader&&window.File){var c=b.length,f=Array(c),d=0;g=function(g,b){var H=new FileReader;H.onload=function(){f[b]=H.result;++d==c&&(e=P(a.doc,e),mb(a.doc,{from:e,to:e,text:Va(f.join("\n")),origin:"paste"},"around"))};H.readAsText(g)};for(var h=0;h<c;++h)g(b[h],h)}else if(!a.state.draggingText||$(e,a.doc.sel.from)||
$(a.doc.sel.to,e))try{if(f=g.dataTransfer.getData("Text")){var h=a.doc.sel.from,k=a.doc.sel.to;Pa(a.doc,e,e);a.state.draggingText&&Qa(a.doc,"",h,k,"paste");a.replaceSelection(f,null,"paste");sa(a);Sa(a)}}catch(l){}else a.state.draggingText(g),setTimeout(ta(sa,a),20)}}function Hb(g,a){2>Math.abs(g.doc.scrollTop-a)||(g.doc.scrollTop=a,ob||u(g,[],a),g.display.scroller.scrollTop!=a&&(g.display.scroller.scrollTop=a),g.display.scrollbarV.scrollTop!=a&&(g.display.scrollbarV.scrollTop=a),ob&&u(g,[]),M(g,
100))}function lb(g,a,e){(e?a==g.doc.scrollLeft:2>Math.abs(g.doc.scrollLeft-a))||(a=Math.min(a,g.display.scroller.scrollWidth-g.display.scroller.clientWidth),g.doc.scrollLeft=a,A(g),g.display.scroller.scrollLeft!=a&&(g.display.scroller.scrollLeft=a),g.display.scrollbarH.scrollLeft!=a&&(g.display.scrollbarH.scrollLeft=a))}function ld(g,a){var e=a.wheelDeltaX,b=a.wheelDeltaY;null==e&&a.detail&&a.axis==a.HORIZONTAL_AXIS&&(e=a.detail);null==b&&a.detail&&a.axis==a.VERTICAL_AXIS?b=a.detail:null==b&&(b=
a.wheelDelta);var c=g.display,f=c.scroller;if(e&&f.scrollWidth>f.clientWidth||b&&f.scrollHeight>f.clientHeight){if(b&&fb&&ka)for(var d=a.target;d!=f;d=d.parentNode)if(d.lineObj){g.display.currentWheelTarget=d;break}if(!e||ob||ya||null==za){if(b&&null!=za){var d=b*za,h=g.doc.scrollTop,k=h+c.wrapper.clientHeight;0>d?h=Math.max(0,h+d-50):k=Math.min(g.doc.height,k+d+50);u(g,[],{top:h,bottom:k})}20>cc&&(null==c.wheelStartX?(c.wheelStartX=f.scrollLeft,c.wheelStartY=f.scrollTop,c.wheelDX=e,c.wheelDY=b,setTimeout(function(){if(null!=
c.wheelStartX){var g=f.scrollLeft-c.wheelStartX,a=f.scrollTop-c.wheelStartY,g=a&&c.wheelDY&&a/c.wheelDY||g&&c.wheelDX&&g/c.wheelDX;c.wheelStartX=c.wheelStartY=null;g&&(za=(za*cc+g)/(cc+1),++cc)}},200)):(c.wheelDX+=e,c.wheelDY+=b))}else b&&Hb(g,Math.max(0,Math.min(f.scrollTop+b*za,f.scrollHeight-f.clientHeight))),lb(g,Math.max(0,Math.min(f.scrollLeft+e*za,f.scrollWidth-f.clientWidth))),fa(a),c.wheelStartX=null}}function dc(g,a,e){if("string"==typeof a&&(a=Hc[a],!a))return!1;g.display.pollingFast&&
Dc(g)&&(g.display.pollingFast=!1);var b=g.doc,c=b.sel.shift,f=!1;try{Db(g)&&(g.state.suppressEdits=!0),e&&(b.sel.shift=!1),f=a(g)!=pd}finally{b.sel.shift=c,g.state.suppressEdits=!1}return f}function qd(g){var a=g.state.keyMaps.slice(0);g.options.extraKeys&&a.push(g.options.extraKeys);a.push(g.options.keyMap);return a}function rd(g,a){var e=Ic(g.options.keyMap),b=e.auto;clearTimeout(sd);b&&!td(a)&&(sd=setTimeout(function(){Ic(g.options.keyMap)==e&&(g.options.keyMap=b.call?b.call(null,g):b,h(g))},50));
var c=ud(a,!0),f=!1;if(!c)return!1;f=qd(g);if(f=a.shiftKey?Ib("Shift-"+c,f,function(a){return dc(g,a,!0)})||Ib(c,f,function(a){if("string"==typeof a?/^go[A-Z]/.test(a):a.motion)return dc(g,a)}):Ib(c,f,function(a){return dc(g,a)}))fa(a),J(g),va&&(a.oldKeyCode=a.keyCode,a.keyCode=0),ra(g,"keyHandled",g,c,a);return f}function je(g,a,e){var b=Ib("'"+e+"'",qd(g),function(a){return dc(g,a,!0)});b&&(fa(a),J(g),ra(g,"keyHandled",g,"'"+e+"'",a));return b}function md(g){this.state.focused||Sa(this);if(!(Ga(this,
g)||this.options.onKeyEvent&&this.options.onKeyEvent(this,Fb(g)))){da&&27==g.keyCode&&(g.returnValue=!1);var a=g.keyCode;this.doc.sel.shift=16==a||g.shiftKey;var e=rd(this,g);ya&&(Jc=e?a:null,!e&&88==a&&!hd&&(fb?g.metaKey:g.ctrlKey)&&this.replaceSelection(""))}}function fe(g){var a=this;if(!(Ga(a,g)||a.options.onKeyEvent&&a.options.onKeyEvent(a,Fb(g)))){var e=g.keyCode,b=g.charCode;ya&&e==Jc?(Jc=null,fa(g)):(ya&&(!g.which||10>g.which)||wc)&&rd(a,g)||(e=String.fromCharCode(null==b?e:b),this.options.electricChars&&
this.doc.mode.electricChars&&this.options.smartIndent&&!Db(this)&&-1<this.doc.mode.electricChars.indexOf(e)&&setTimeout(R(a,function(){ec(a,a.doc.sel.to.line,"smart")}),75),je(a,g,e)||(da&&!va&&(a.display.inputHasSelection=null),Cb(a)))}}function Sa(g){"nocursor"!=g.options.readOnly&&(g.state.focused||(la(g,"focus",g),g.state.focused=!0,-1==g.display.wrapper.className.search(/\bCodeMirror-focused\b/)&&(g.display.wrapper.className+=" CodeMirror-focused"),g.curOp||(Ha(g,!0),ka&&setTimeout(ta(Ha,g,!0),
0))),$b(g),J(g))}function uc(g){g.state.focused&&(la(g,"blur",g),g.state.focused=!1,g.display.wrapper.className=g.display.wrapper.className.replace(" CodeMirror-focused",""));clearInterval(g.display.blinker);setTimeout(function(){g.state.focused||(g.doc.sel.shift=!1)},150)}function kd(g,a){function e(){if(null!=c.input.selectionStart){var g=c.input.value=" "+(Z(f.from,f.to)?"":c.input.value);c.prevInput=" ";c.input.selectionStart=1;c.input.selectionEnd=g.length}}function b(){c.inputDiv.style.position=
"relative";c.input.style.cssText=k;va&&(c.scrollbarV.scrollTop=c.scroller.scrollTop=h);$b(g);if(null!=c.input.selectionStart){da&&!va||e();clearTimeout(Kc);var a=0,E=function(){" "==c.prevInput&&0==c.input.selectionStart?R(g,Hc.selectAll)(g):10>a++?Kc=setTimeout(E,500):Ha(g)};Kc=setTimeout(E,200)}}if(!Ga(g,a,"contextmenu")){var c=g.display,f=g.doc.sel;if(!Wa(c,a)){var d=nb(g,a),h=c.scroller.scrollTop;if(d&&!ya){(Z(f.from,f.to)||$(d,f.from)||!$(d,f.to))&&R(g,Pa)(g.doc,d,d);var k=c.input.style.cssText;
c.inputDiv.style.position="absolute";c.input.style.cssText="position: fixed; width: 30px; height: 30px; top: "+(a.clientY-5)+"px; left: "+(a.clientX-5)+"px; z-index: 1000; background: white; outline: none;border-width: 0; outline: none; overflow: hidden; opacity: .05; -ms-opacity: .05; filter: alpha(opacity=5);";sa(g);Ha(g,!0);Z(f.from,f.to)&&(c.input.value=c.prevInput=" ");da&&!va&&e();if(Fc){Gb(a);var l=function(){Ka(window,"mouseup",l);setTimeout(b,20)};S(window,"mouseup",l)}else setTimeout(b,
50)}}}}function vd(g,a,e){if(!$(a.from,e))return P(g,e);var b=a.text.length-1-(a.to.line-a.from.line);if(e.line>a.to.line+b)return a=e.line-b,b=g.first+g.size-1,a>b?I(b,L(g,b).text.length):fc(e,L(g,a).text.length);if(e.line==a.to.line+b)return fc(e,qa(a.text).length+(1==a.text.length?a.from.ch:0)+L(g,a.to.line).text.length-a.to.ch);g=e.line-a.from.line;return fc(e,a.text[g].length+(g?0:a.from.ch))}function Lc(g,a,e){if(e&&"object"==typeof e)return{anchor:vd(g,a,e.anchor),head:vd(g,a,e.head)};if("start"==
e)return{anchor:a.from,head:a.from};var b=Mc(a);if("around"==e)return{anchor:a.from,head:b};if("end"==e)return{anchor:b,head:b};e=function(g){if($(g,a.from))return g;if(!$(a.to,g))return b;var e=g.line+a.text.length-(a.to.line-a.from.line)-1,c=g.ch;g.line==a.to.line&&(c+=b.ch-a.to.ch);return I(e,c)};return{anchor:e(g.sel.anchor),head:e(g.sel.head)}}function wd(g,a,e){a={canceled:!1,from:a.from,to:a.to,text:a.text,origin:a.origin,cancel:function(){this.canceled=!0}};e&&(a.update=function(a,e,E,b){a&&
(this.from=P(g,a));e&&(this.to=P(g,e));E&&(this.text=E);void 0!==b&&(this.origin=b)});la(g,"beforeChange",g,a);g.cm&&la(g.cm,"beforeChange",g.cm,a);return a.canceled?null:{from:a.from,to:a.to,text:a.text,origin:a.origin}}function mb(g,a,e,b){if(g.cm){if(!g.cm.curOp)return R(g.cm,mb)(g,a,e,b);if(g.cm.state.suppressEdits)return}if(La(g,"beforeChange")||g.cm&&La(g.cm,"beforeChange"))if(a=wd(g,a,!0),!a)return;if(b=xd&&!b&&ke(g,a.from,a.to)){for(var c=b.length-1;1<=c;--c)Nc(g,{from:b[c].from,to:b[c].to,
text:[""]});b.length&&Nc(g,{from:b[0].from,to:b[0].to,text:a.text},e)}else Nc(g,a,e)}function Nc(g,a,e){e=Lc(g,a,e);yd(g,a,e,g.cm?g.cm.curOp.id:NaN);Jb(g,a,e,Oc(g,a));var b=[];pb(g,function(g,e){e||-1!=Ma(b,g.history)||(zd(g.history,a),b.push(g.history));Jb(g,a,null,Oc(g,a))})}function Ad(g,a){if(!g.cm||!g.cm.state.suppressEdits){var e=g.history,b=("undo"==a?e.done:e.undone).pop();if(b){var c={changes:[],anchorBefore:b.anchorAfter,headBefore:b.headAfter,anchorAfter:b.anchorBefore,headAfter:b.headBefore,
generation:e.generation};("undo"==a?e.undone:e.done).push(c);e.generation=b.generation||++e.maxGeneration;for(var f=La(g,"beforeChange")||g.cm&&La(g.cm,"beforeChange"),d=b.changes.length-1;0<=d;--d){var h=b.changes[d];h.origin=a;if(f&&!wd(g,h,!1)){("undo"==a?e.done:e.undone).length=0;break}c.changes.push(Pc(g,h));var k=d?Lc(g,h,null):{anchor:b.anchorBefore,head:b.headBefore};Jb(g,h,k,Bd(g,h));var l=[];pb(g,function(g,a){a||-1!=Ma(l,g.history)||(zd(g.history,h),l.push(g.history));Jb(g,h,null,Bd(g,
h))})}}}}function Cd(g,a){function e(g){return I(g.line+a,g.ch)}g.first+=a;g.cm&&ea(g.cm,g.first,g.first,a);g.sel.head=e(g.sel.head);g.sel.anchor=e(g.sel.anchor);g.sel.from=e(g.sel.from);g.sel.to=e(g.sel.to)}function Jb(g,a,e,b){if(g.cm&&!g.cm.curOp)return R(g.cm,Jb)(g,a,e,b);if(a.to.line<g.first)Cd(g,a.text.length-1-(a.to.line-a.from.line));else if(!(a.from.line>g.lastLine())){if(a.from.line<g.first){var c=a.text.length-1-(g.first-a.from.line);Cd(g,c);a={from:I(g.first,0),to:I(a.to.line+c,a.to.ch),
text:[qa(a.text)],origin:a.origin}}c=g.lastLine();a.to.line>c&&(a={from:a.from,to:I(c,L(g,c).text.length),text:[a.text[0]],origin:a.origin});a.removed=Qc(g,a.from,a.to);e||(e=Lc(g,a,null));g.cm?le(g.cm,a,b,e):Rc(g,a,b,e)}}function le(g,a,e,b){var c=g.doc,d=g.display,h=a.from,k=a.to,l=!1,m=h.line;g.options.lineWrapping||(m=ua(Ja(c,L(c,h.line))),c.iter(m,k.line+1,function(g){if(g==d.maxLine)return l=!0}));$(c.sel.head,a.from)||$(a.to,c.sel.head)||(g.curOp.cursorActivity=!0);Rc(c,a,e,b,f(g));g.options.lineWrapping||
(c.iter(m,h.line+a.text.length,function(g){var a=t(c,g);a>d.maxLineLength&&(d.maxLine=g,d.maxLineLength=a,d.maxLineChanged=!0,l=!1)}),l&&(g.curOp.updateMaxLine=!0));c.frontier=Math.min(c.frontier,h.line);M(g,400);ea(g,h.line,k.line+1,a.text.length-(k.line-h.line)-1);if(La(g,"change"))if(a={from:h,to:k,text:a.text,removed:a.removed,origin:a.origin},g.curOp.textChanged){for(g=g.curOp.textChanged;g.next;g=g.next);g.next=a}else g.curOp.textChanged=a}function Qa(g,a,e,b,c){b||(b=e);if($(b,e)){var f=b;
b=e;e=f}"string"==typeof a&&(a=Va(a));mb(g,{from:e,to:b,text:a,origin:c},null)}function I(g,a){if(!(this instanceof I))return new I(g,a);this.line=g;this.ch=a}function Z(g,a){return g.line==a.line&&g.ch==a.ch}function $(g,a){return g.line<a.line||g.line==a.line&&g.ch<a.ch}function Xa(g){return I(g.line,g.ch)}function P(g,a){if(a.line<g.first)return I(g.first,0);var e=g.first+g.size-1;return a.line>e?I(e,L(g,e).text.length):fc(a,L(g,a.line).text.length)}function fc(g,a){var e=g.ch;return null==e||
e>a?I(g.line,a):0>e?I(g.line,0):g}function qb(g,a){return a>=g.first&&a<g.first+g.size}function ma(g,a,e,b){if(g.sel.shift||g.sel.extend){var c=g.sel.anchor;if(e){var f=$(a,c);f!=$(e,c)?(c=a,a=e):f!=$(a,e)&&(a=e)}Pa(g,c,a,b)}else Pa(g,a,e||a,b);g.cm&&(g.cm.curOp.userSelChange=!0)}function Pa(a,b,e,c,f){if(!f&&La(a,"beforeSelectionChange")||a.cm&&La(a.cm,"beforeSelectionChange"))b={anchor:b,head:e},la(a,"beforeSelectionChange",a,b),a.cm&&la(a.cm,"beforeSelectionChange",a.cm,b),b.anchor=P(a,b.anchor),
b.head=P(a,b.head),e=b.head,b=b.anchor;var d=a.sel;d.goalColumn=null;if(f||!Z(b,d.anchor))b=gc(a,b,c,"push"!=f);if(f||!Z(e,d.head))e=gc(a,e,c,"push"!=f);Z(d.anchor,b)&&Z(d.head,e)||(d.anchor=b,d.head=e,c=$(e,b),d.from=c?e:b,d.to=c?b:e,a.cm&&(a.cm.curOp.updateInput=a.cm.curOp.selectionChanged=a.cm.curOp.cursorActivity=!0),ra(a,"cursorActivity",a))}function Dd(a){Pa(a.doc,a.doc.sel.from,a.doc.sel.to,null,"push")}function gc(a,b,e,c){var f=!1,d=b,h=e||1;a.cantEdit=!1;a:for(;;){var k=L(a,d.line);if(k.markedSpans)for(var l=
0;l<k.markedSpans.length;++l){var m=k.markedSpans[l],p=m.marker;if((null==m.from||(p.inclusiveLeft?m.from<=d.ch:m.from<d.ch))&&(null==m.to||(p.inclusiveRight?m.to>=d.ch:m.to>d.ch))){if(c&&(la(p,"beforeCursorEnter"),p.explicitlyCleared))if(k.markedSpans){--l;continue}else break;if(p.atomic){l=p.find()[0>h?"from":"to"];if(Z(l,d)&&(l.ch+=h,0>l.ch?l=l.line>a.first?P(a,I(l.line-1)):null:l.ch>k.text.length&&(l=l.line<a.first+a.size-1?I(l.line+1,0):null),!l)){if(f){if(!c)return gc(a,b,e,!0);a.cantEdit=!0;
return I(a.first,0)}f=!0;l=b;h=-h}d=l;continue a}}}return d}}function gd(a,b,e){for(null==e&&(e=0);;){var c=!1,f=ja(a,b),d=Zb(a,f.left,f.top-e,f.left,f.bottom+e),h=a.doc.scrollTop,k=a.doc.scrollLeft;null!=d.scrollTop&&(Hb(a,d.scrollTop),1<Math.abs(a.doc.scrollTop-h)&&(c=!0));null!=d.scrollLeft&&(lb(a,d.scrollLeft),1<Math.abs(a.doc.scrollLeft-k)&&(c=!0));if(!c)return f}}function Zb(a,b,e,c,f){var d=a.display,h=Na(a.display);0>e&&(e=0);var k=d.scroller.clientHeight-cb,l=d.scroller.scrollTop,m={};a=
a.doc.height+(d.mover.offsetHeight-d.lineSpace.offsetHeight);var p=e<h,h=f>a-h;e<l?m.scrollTop=p?0:e:f>l+k&&(e=Math.min(e,(h?a:f)-k),e!=l&&(m.scrollTop=e));l=d.scroller.clientWidth-cb;e=d.scroller.scrollLeft;b+=d.gutters.offsetWidth;c+=d.gutters.offsetWidth;d=d.gutters.offsetWidth;f=b<d+10;b<e+d||f?(f&&(b=0),m.scrollLeft=Math.max(0,b-10-d)):c>l+e-3&&(m.scrollLeft=c+10-l);return m}function hc(a,b,e){a.curOp.updateScrollPos={scrollLeft:null==b?a.doc.scrollLeft:b,scrollTop:null==e?a.doc.scrollTop:e}}
function Sc(a,b,e){var c=a.curOp.updateScrollPos||(a.curOp.updateScrollPos={scrollLeft:a.doc.scrollLeft,scrollTop:a.doc.scrollTop});a=a.display.scroller;c.scrollTop=Math.max(0,Math.min(a.scrollHeight-a.clientHeight,c.scrollTop+e));c.scrollLeft=Math.max(0,Math.min(a.scrollWidth-a.clientWidth,c.scrollLeft+b))}function ec(a,b,e,c){var f=a.doc;null==e&&(e="add");if("smart"==e)if(a.doc.mode.indent)var d=Y(a,b);else e="prev";var h=a.options.tabSize,k=L(f,b),l=hb(k.text,null,h),m=k.text.match(/^\s*/)[0],
p;if("smart"==e&&(p=a.doc.mode.indent(d,k.text.slice(m.length),k.text),p==pd)){if(!c)return;e="prev"}"prev"==e?p=b>f.first?hb(L(f,b-1).text,null,h):0:"add"==e?p=l+a.options.indentUnit:"subtract"==e?p=l-a.options.indentUnit:"number"==typeof e&&(p=l+e);p=Math.max(0,p);e="";c=0;if(a.options.indentWithTabs)for(f=Math.floor(p/h);f;--f)c+=h,e+="\t";c<p&&(e+=Ed(p-c));e!=m&&Qa(a.doc,e,I(b,0),I(b,m.length),"+input");k.stateAfter=null}function ic(a,b,e){var c=b,f=b,d=a.doc;"number"==typeof b?f=L(d,Math.max(d.first,
Math.min(b,d.first+d.size-1))):c=ua(b);if(null!=c&&e(f,c))ea(a,c,c+1);else return null;return f}function Tc(a,b,e,c,f){function d(b){var E=(f?Ac:Fd)(l,k,e,!0);if(null==E){if(b=!b)b=h+e,b<a.first||b>=a.first+a.size?b=m=!1:(h=b,b=l=L(a,b));if(b)k=f?(0>e?Xb:Wb)(l):0>e?l.text.length:0;else return m=!1}else k=E;return!0}var h=b.line,k=b.ch;b=e;var l=L(a,h),m=!0;if("char"==c)d();else if("column"==c)d(!0);else if("word"==c||"group"==c){var p=null;c="group"==c;for(var r=!0;!(0>e)||d(!r);r=!1){var q=l.text.charAt(k)||
"\n",q=Kb(q)?"w":c?/\s/.test(q)?null:"p":null;if(p&&p!=q){0>e&&(e=1,d());break}q&&(p=q);if(0<e&&!d(!r))break}}b=gc(a,I(h,k),b,!0);m||(b.hitSide=!0);return b}function Gd(a,b,e,c){var f=a.doc,d=b.left,h;"page"==c?(c=Math.min(a.display.wrapper.clientHeight,window.innerHeight||document.documentElement.clientHeight),h=b.top+e*(c-(0>e?1.5:0.5)*Na(a.display))):"line"==c&&(h=0<e?b.bottom+3:b.top-3);for(;;){var k=X(a,d,h);if(!k.outside)break;if(0>e?0>=h:h>=f.height){k.hitSide=!0;break}h+=5*e}return k}function Ec(a,
b){var e=b.ch,c=b.ch;if(a){(0>b.xRel||c==a.length)&&e?--e:++c;for(var f=a.charAt(e),f=Kb(f)?Kb:/\s/.test(f)?function(a){return/\s/.test(a)}:function(a){return!/\s/.test(a)&&!Kb(a)};0<e&&f(a.charAt(e-1));)--e;for(;c<a.length&&f(a.charAt(c));)++c}return{from:I(b.line,e),to:I(b.line,c)}}function he(a,b){ma(a.doc,I(b,0),P(a.doc,I(b+1,0)))}function T(g,b,e,c){a.defaults[g]=b;e&&(bb[g]=c?function(a,g,b){b!=$c&&e(a,g,b)}:e)}function gb(a,b){if(!0===b)return b;if(a.copyState)return a.copyState(b);var e={},
c;for(c in b.objects)if(b.objects.hasOwnProperty(c)){var f=b.objects[c];e[c]={colors:f.colors.concat([]),lineNumber:f.lineNumber,spritematrix:f.spritematrix.concat([])}}f=[];for(c=0;c<b.collisionLayers.length;c++)f.push(b.collisionLayers[c].concat([]));var d=[],h=[],k=[],l=[],m=[];for(c=0;c<b.legend_synonyms.length;c++)d.push(b.legend_synonyms[c].concat([]));for(c=0;c<b.legend_aggregates.length;c++)h.push(b.legend_aggregates[c].concat([]));for(c=0;c<b.legend_properties.length;c++)k.push(b.legend_properties[c].concat([]));
for(c=0;c<b.sounds.length;c++)l.push(b.sounds[c].concat([]));for(c=0;c<b.levels.length;c++)m.push(b.levels[c].concat([]));return{lineNumber:b.lineNumber,objects:e,collisionLayers:f,commentLevel:b.commentLevel,section:b.section,visitedSections:b.visitedSections.concat([]),objects_candname:b.objects_candname,objects_section:b.objects_section,objects_spritematrix:b.objects_spritematrix.concat([]),tokenIndex:b.tokenIndex,legend_synonyms:d,legend_aggregates:h,legend_properties:k,sounds:l,rules:b.rules.concat([]),
names:b.names.concat([]),wincondition:b.wincondition.concat([]),abbrevNames:b.abbrevNames.concat([]),metadata:b.metadata.concat([]),levels:m}}function ed(a,b,e){return a.startState?a.startState(b,e):!0}function Ic(a){return"string"==typeof a?Ia[a]:a}function Ib(a,b,e){function c(b){b=Ic(b);var E=b[a];if(!1===E)return"stop";if(null!=E&&e(E))return!0;if(b.nofallthrough)return"stop";b=b.fallthrough;if(null==b)return!1;if("[object Array]"!=Object.prototype.toString.call(b))return c(b);for(var E=0,f=b.length;E<
f;++E){var d=c(b[E]);if(d)return d}return!1}for(var f=0;f<b.length;++f){var d=c(b[f]);if(d)return"stop"!=d}}function td(a){a=Ya[a.keyCode];return"Ctrl"==a||"Alt"==a||"Shift"==a||"Mod"==a}function ud(a,b){if(ya&&34==a.keyCode&&a["char"])return!1;var e=Ya[a.keyCode];if(null==e||a.altGraphKey)return!1;a.altKey&&(e="Alt-"+e);if(Hd?a.metaKey:a.ctrlKey)e="Ctrl-"+e;if(Hd?a.ctrlKey:a.metaKey)e="Cmd-"+e;!b&&a.shiftKey&&(e="Shift-"+e);return e}function Lb(a,b){this.pos=this.start=0;this.string=a;this.tabSize=
b||8;this.lastColumnPos=this.lastColumnValue=0}function Ra(a,b){this.lines=[];this.type=b;this.doc=a}function Mb(a,b,e,c,f){if(c&&c.shared)return me(a,b,e,c,f);if(a.cm&&!a.cm.curOp)return R(a.cm,Mb)(a,b,e,c,f);var d=new Ra(a,f);if("range"==f&&!$(b,e))return d;c&&jc(c,d);d.replacedWith&&(d.collapsed=!0,d.replacedWith=K("span",[d.replacedWith],"CodeMirror-widget"),c.handleMouseEvents||(d.replacedWith.ignoreEvents=!0));d.collapsed&&(yb=!0);d.addToHistory&&yd(a,{from:b,to:e,origin:"markText"},{head:a.sel.head,
anchor:a.sel.anchor},NaN);var h=b.line,k=0,l,m,p=a.cm,r;a.iter(h,e.line+1,function(c){p&&d.collapsed&&!p.options.lineWrapping&&Ja(a,c)==p.display.maxLine&&(r=!0);var f={from:null,to:null,marker:d};k+=c.text.length;h==b.line&&(f.from=b.ch,k-=b.ch);h==e.line&&(f.to=e.ch,k-=c.text.length-e.ch);d.collapsed&&(h==e.line&&(m=eb(c,e.ch)),h==b.line?l=eb(c,b.ch):xa(c,0));c.markedSpans=c.markedSpans?c.markedSpans.concat([f]):[f];f.marker.attachLine(c);++h});d.collapsed&&a.iter(b.line,e.line+1,function(b){Ta(a,
b)&&xa(b,0)});d.clearOnEnter&&S(d,"beforeCursorEnter",function(){d.clear()});d.readOnly&&(xd=!0,(a.history.done.length||a.history.undone.length)&&a.clearHistory());if(d.collapsed){if(l!=m)throw Error("Inserting collapsed marker overlapping an existing one");d.size=k;d.atomic=!0}p&&(r&&(p.curOp.updateMaxLine=!0),(d.className||d.title||d.startStyle||d.endStyle||d.collapsed)&&ea(p,b.line,e.line+1),d.atomic&&Dd(p));return d}function Nb(a,b){this.markers=a;this.primary=b;for(var e=0,c=this;e<a.length;++e)a[e].parent=
this,S(a[e],"clear",function(){c.clear()})}function me(a,b,e,c,f){c=jc(c);c.shared=!1;var d=[Mb(a,b,e,c,f)],h=d[0],k=c.replacedWith;pb(a,function(a){k&&(c.replacedWith=k.cloneNode(!0));d.push(Mb(a,P(a,b),P(a,e),c,f));for(var g=0;g<a.linked.length;++g)if(a.linked[g].isParent)return;h=qa(d)});return new Nb(d,h)}function Ob(a,b){if(a)for(var e=0;e<a.length;++e){var c=a[e];if(c.marker==b)return c}}function Oc(a,b){var e=qb(a,b.from.line)&&L(a,b.from.line).markedSpans,c=qb(a,b.to.line)&&L(a,b.to.line).markedSpans;
if(!e&&!c)return null;var f=b.from.ch,d=b.to.ch,h=Z(b.from,b.to);if(e)for(var k=0,l;k<e.length;++k){var m=e[k],p=m.marker;if(null==m.from||(p.inclusiveLeft?m.from<=f:m.from<f)||"bookmark"==p.type&&!(m.from!=f||h&&m.marker.insertLeft)){var r=null==m.to||(p.inclusiveRight?m.to>=f:m.to>f);(l||(l=[])).push({from:m.from,to:r?null:m.to,marker:p})}}e=l;if(c)for(var k=0,q;k<c.length;++k)if(l=c[k],m=l.marker,null==l.to||(m.inclusiveRight?l.to>=d:l.to>d)||"bookmark"==m.type&&l.from==d&&(!h||l.marker.insertLeft))p=
null==l.from||(m.inclusiveLeft?l.from<=d:l.from<d),(q||(q=[])).push({from:p?null:l.from-d,to:null==l.to?null:l.to-d,marker:m});c=q;h=1==b.text.length;q=qa(b.text).length+(h?f:0);if(e)for(d=0;d<e.length;++d)if(k=e[d],null==k.to)(l=Ob(c,k.marker),l)?h&&(k.to=null==l.to?null:l.to+q):k.to=f;if(c)for(d=0;d<c.length;++d)k=c[d],null!=k.to&&(k.to+=q),null==k.from?(l=Ob(e,k.marker),l||(k.from=q,h&&(e||(e=[])).push(k))):(k.from+=q,h&&(e||(e=[])).push(k));if(h&&e){for(d=0;d<e.length;++d)null!=e[d].from&&e[d].from==
e[d].to&&"bookmark"!=e[d].marker.type&&e.splice(d--,1);e.length||(e=null)}f=[e];if(!h){var h=b.text.length-2,s;if(0<h&&e)for(d=0;d<e.length;++d)null==e[d].to&&(s||(s=[])).push({from:null,to:null,marker:e[d].marker});for(d=0;d<h;++d)f.push(s);f.push(c)}return f}function Bd(a,b){var e;if(e=b["spans_"+a.id]){for(var c=0,d=[];c<b.text.length;++c)d.push(ne(e[c]));e=d}else e=null;c=Oc(a,b);if(!e)return c;if(!c)return e;for(d=0;d<e.length;++d){var f=e[d],h=c[d];if(f&&h){var k=0;a:for(;k<h.length;++k){for(var l=
h[k],m=0;m<f.length;++m)if(f[m].marker==l.marker)continue a;f.push(l)}}else h&&(e[d]=h)}return e}function ke(a,b,e){var c=null;a.iter(b.line,e.line+1,function(a){if(a.markedSpans)for(var g=0;g<a.markedSpans.length;++g){var b=a.markedSpans[g].marker;!b.readOnly||c&&-1!=Ma(c,b)||(c||(c=[])).push(b)}});if(!c)return null;a=[{from:b,to:e}];for(b=0;b<c.length;++b){e=c[b];for(var d=e.find(),f=0;f<a.length;++f){var h=a[f];if(!$(h.to,d.from)&&!$(d.to,h.from)){var k=[f,1];($(h.from,d.from)||!e.inclusiveLeft&&
Z(h.from,d.from))&&k.push({from:h.from,to:d.from});($(d.to,h.to)||!e.inclusiveRight&&Z(h.to,d.to))&&k.push({from:d.to,to:h.to});a.splice.apply(a,k);f+=k.length-1}}}return a}function eb(a,b){var e=yb&&a.markedSpans,c;if(e)for(var d,f=0;f<e.length;++f)d=e[f],d.marker.collapsed&&(null==d.from||d.from<b)&&(null==d.to||d.to>b)&&(!c||c.width<d.marker.width)&&(c=d.marker);return c}function Ub(a){return eb(a,a.text.length+1)}function Ja(a,b){for(var e;e=eb(b,-1);)b=L(a,e.find().from.line);return b}function Ta(a,
b){var e=yb&&b.markedSpans;if(e)for(var c,d=0;d<e.length;++d)if(c=e[d],c.marker.collapsed&&(null==c.from||!c.marker.replacedWith&&0==c.from&&c.marker.inclusiveLeft&&Uc(a,b,c)))return!0}function Uc(a,b,e){if(null==e.to)return b=e.marker.find().to,b=L(a,b.line),Uc(a,b,Ob(b.markedSpans,e.marker));if(e.marker.inclusiveRight&&e.to==b.text.length)return!0;for(var c,d=0;d<b.markedSpans.length;++d)if(c=b.markedSpans[d],c.marker.collapsed&&!c.marker.replacedWith&&c.from==e.to&&(c.marker.inclusiveLeft||e.marker.inclusiveRight)&&
Uc(a,b,c))return!0}function Id(a){var b=a.markedSpans;if(b){for(var e=0;e<b.length;++e)b[e].marker.detachLine(a);a.markedSpans=null}}function Jd(a,b){if(b){for(var e=0;e<b.length;++e)b[e].marker.attachLine(a);a.markedSpans=b}}function Kd(a){return function(){var b=!this.cm.curOp;b&&jb(this.cm);try{var e=a.apply(this,arguments)}finally{b&&kb(this.cm)}return e}}function Vb(a){if(null!=a.height)return a.height;a.node.parentNode&&1==a.node.parentNode.nodeType||Fa(a.cm.display.measure,K("div",[a.node],
null,"position: relative"));return a.height=a.node.offsetHeight}function oe(a,b,e,c){var d=new kc(a,e,c);d.noHScroll&&(a.display.alignWidgets=!0);ic(a,b,function(b){var e=b.widgets||(b.widgets=[]);null==d.insertAt?e.push(d):e.splice(Math.min(e.length-1,Math.max(0,d.insertAt)),0,d);d.line=b;if(!Ta(a.doc,b)||d.showIfHidden)e=zb(a,b)<a.doc.scrollTop,xa(b,b.height+Vb(d)),e&&Sc(a,0,d.height);return!0});return d}function Ld(a,b,e,c,d){var f=e.flattenSpans;null==f&&(f=a.options.flattenSpans);var h=0,k=null,
l=new Lb(b,a.options.tabSize),m;for(""==b&&e.blankLine&&e.blankLine(c);!l.eol();)l.pos>a.options.maxHighlightLength?(f=!1,l.pos=Math.min(b.length,l.start+5E4),m=null):m=e.token(l,c),f&&k==m||(h<l.start&&d(l.start,k),h=l.start,k=m),l.start=l.pos;h<l.pos&&d(l.pos,k)}function cd(a,b,e){var c=[a.state.modeGen];Ld(a,b.text,a.doc.mode,e,function(a,g){c.push(a,g)});for(e=0;e<a.state.overlays.length;++e){var d=a.state.overlays[e],f=1,h=0;Ld(a,b.text,d.mode,!0,function(a,g){for(var b=f;h<a;){var e=c[f];e>
a&&c.splice(f,1,a,c[f+1],e);f+=2;h=Math.min(a,e)}if(g)if(d.opaque)c.splice(b,f-b,a,g),f=b+2;else for(;b<f;b+=2)e=c[b+1],c[b+1]=e?e+" "+g:g})}return c}function Md(a,b){b.styles&&b.styles[0]==a.state.modeGen||(b.styles=cd(a,b,b.stateAfter=Y(a,ua(b))));return b.styles}function dd(a,b,e){var c=a.doc.mode,d=new Lb(b.text,a.options.tabSize);for(""==b.text&&c.blankLine&&c.blankLine(e);!d.eol()&&d.pos<=a.options.maxHighlightLength;)c.token(d,e),d.start=d.pos}function Nd(a){return a?Od[a]||(Od[a]="cm-"+a.replace(/ +/g,
" cm-")):null}function xc(a,b,e,c){for(var d,f=b,h=!0;d=eb(f,-1);)f=L(a.doc,d.find().from.line);c={pre:K("pre"),col:0,pos:0,measure:null,measuredSomething:!1,cm:a,copyWidgets:c};f.textClass&&(c.pre.className=f.textClass);do{f.text&&(h=!1);c.measure=f==b&&e;c.pos=0;c.addToken=c.measure?pe:Pd;(da||ka)&&a.getOption("lineWrapping")&&(c.addToken=qe(c.addToken));a:{d=c;var k=Md(a,f),l=f.markedSpans,m=f.text,p=0;if(l)for(var r=m.length,q=0,s=1,t="",u=void 0,v=0,w=void 0,z=void 0,A=void 0,D=void 0,C=void 0;;){if(v==
q){for(var w=z=A=D="",C=null,v=Infinity,J=[],W=0;W<l.length;++W){var F=l[W],G=F.marker;F.from<=q&&(null==F.to||F.to>q)?(null!=F.to&&v>F.to&&(v=F.to,z=""),G.className&&(w+=" "+G.className),G.startStyle&&F.from==q&&(A+=" "+G.startStyle),G.endStyle&&F.to==v&&(z+=" "+G.endStyle),G.title&&!D&&(D=G.title),G.collapsed&&(!C||C.marker.size<G.size)&&(C=F)):F.from>q&&v>F.from&&(v=F.from);"bookmark"==G.type&&F.from==q&&G.replacedWith&&J.push(G)}if(C&&(C.from||0)==q&&(Qd(d,(null==C.to?r:C.to)-q,C.marker,null==
C.from),null==C.to)){d=C.marker.find();break a}if(!C&&J.length)for(W=0;W<J.length;++W)Qd(d,0,J[W])}if(q>=r)break;for(J=Math.min(r,v);;){if(t){W=q+t.length;C||(F=W>J?t.slice(0,J-q):t,d.addToken(d,F,u?u+w:w,A,q+F.length==v?z:"",D));if(W>=J){t=t.slice(J-q);q=J;break}q=W;A=""}t=m.slice(p,p=k[s++]);u=Nd(k[s++])}}else for(var s=1;s<k.length;s+=2)d.addToken(d,m.slice(p,p=k[s]),Nd(k[s+1]));d=void 0}e&&f==b&&!c.measuredSomething&&(e[0]=c.pre.appendChild(Ab(a.display.measure)),c.measuredSomething=!0);d&&(f=
L(a.doc,d.to.line))}while(d);!e||c.measuredSomething||e[0]||(e[0]=c.pre.appendChild(h?K("span","\u00a0"):Ab(a.display.measure)));c.pre.firstChild||Ta(a.doc,b)||c.pre.appendChild(document.createTextNode("\u00a0"));var M;e&&da&&(M=Ea(f))&&(h=M.length-1,M[h].from==M[h].to&&--h,f=M[h],M=M[h-1],f.from+1==f.to&&M&&f.level<M.level&&(e=e[c.pos-1])&&e.parentNode.insertBefore(e.measureRight=Ab(a.display.measure),e.nextSibling));la(a,"renderLine",a,b,c.pre);return c.pre}function Pd(a,b,e,c,d,f){if(b){if(Vc.test(b))for(var h=
document.createDocumentFragment(),k=0;;){Vc.lastIndex=k;var l=Vc.exec(b),m=l?l.index-k:b.length-k;m&&(h.appendChild(document.createTextNode(b.slice(k,k+m))),a.col+=m);if(!l)break;k+=m+1;"\t"==l[0]?(l=a.cm.options.tabSize,l-=a.col%l,h.appendChild(K("span",Ed(l),"cm-tab")),a.col+=l):(m=K("span","\u2022","cm-invalidchar"),m.title="\\u"+l[0].charCodeAt(0).toString(16),h.appendChild(m),a.col+=1)}else{a.col+=b.length;var h=document.createTextNode(b)}if(e||c||d||a.measure)return b=e||"",c&&(b+=c),d&&(b+=
d),m=K("span",[h],b),f&&(m.title=f),a.pre.appendChild(m);a.pre.appendChild(h)}}function pe(a,b,e,c,d){for(var f=a.cm.options.lineWrapping,h=0;h<b.length;++h){var k=b.charAt(h),l=0==h;"\ud800"<=k&&"\udbff">k&&h<b.length-1?(k=b.slice(h,h+2),++h):h&&f&&lc(b,h)&&a.pre.appendChild(K("wbr"));var m=a.measure[a.pos],l=a.measure[a.pos]=Pd(a,k,e,l&&c,h==b.length-1&&d);m&&(l.leftSide=m.leftSide||m);da&&f&&" "==k&&h&&!/\s/.test(b.charAt(h-1))&&h<b.length-1&&!/\s/.test(b.charAt(h+1))&&(l.style.whiteSpace="normal");
a.pos+=k.length}b.length&&(a.measuredSomething=!0)}function qe(a){function b(a){for(var g=" ",c=0;c<a.length-2;++c)g+=c%2?" ":"\u00a0";return g+" "}return function(e,c,d,f,h,k){return a(e,c.replace(/ {3,}/,b),d,f,h,k)}}function Qd(a,b,e,c){if(c=!c&&e.replacedWith)if(a.copyWidgets&&(c=c.cloneNode(!0)),a.pre.appendChild(c),a.measure){if(b)a.measure[a.pos]=c;else{var d=Ab(a.cm.display.measure);if("bookmark"!=e.type||e.insertLeft){if(a.measure[a.pos])return;a.measure[a.pos]=a.pre.insertBefore(d,c)}else a.measure[a.pos]=
a.pre.appendChild(d)}a.measuredSomething=!0}a.pos+=b}function Rc(a,b,e,c,d){function f(a,g,e){var c=d;a.text=g;a.stateAfter&&(a.stateAfter=null);a.styles&&(a.styles=null);null!=a.order&&(a.order=null);Id(a);Jd(a,e);g=c?c(a):1;g!=a.height&&xa(a,g);ra(a,"change",a,b)}var h=b.from,k=b.to,l=b.text,m=L(a,h.line),p=L(a,k.line),q=qa(l),r=e?e[l.length-1]:null,s=k.line-h.line;if(0==h.ch&&0==k.ch&&""==q){for(var t=0,v=l.length-1,u=[];t<v;++t)u.push(new rb(l[t],e?e[t]:null,d));f(p,p.text,r);s&&a.remove(h.line,
s);u.length&&a.insert(h.line,u)}else if(m==p)if(1==l.length)f(m,m.text.slice(0,h.ch)+q+m.text.slice(k.ch),r);else{u=[];t=1;for(v=l.length-1;t<v;++t)u.push(new rb(l[t],e?e[t]:null,d));u.push(new rb(q+m.text.slice(k.ch),r,d));f(m,m.text.slice(0,h.ch)+l[0],e?e[0]:null);a.insert(h.line+1,u)}else if(1==l.length)f(m,m.text.slice(0,h.ch)+l[0]+p.text.slice(k.ch),e?e[0]:null),a.remove(h.line+1,s);else{f(m,m.text.slice(0,h.ch)+l[0],e?e[0]:null);f(p,q+p.text.slice(k.ch),r);t=1;v=l.length-1;for(u=[];t<v;++t)u.push(new rb(l[t],
e?e[t]:null,d));1<s&&a.remove(h.line+1,s-1);a.insert(h.line+1,u)}ra(a,"change",a,b);Pa(a,c.anchor,c.head,null,!0)}function mc(a){this.lines=a;this.parent=null;for(var b=0,e=a.length,c=0;b<e;++b)a[b].parent=this,c+=a[b].height;this.height=c}function Pb(a){this.children=a;for(var b=0,e=0,c=0,d=a.length;c<d;++c){var f=a[c],b=b+f.chunkSize(),e=e+f.height;f.parent=this}this.size=b;this.height=e;this.parent=null}function pb(a,b,e){function c(a,g,d){if(a.linked)for(var f=0;f<a.linked.length;++f){var h=a.linked[f];
if(h.doc!=g){var k=d&&h.sharedHist;if(!e||k)b(h.doc,k),c(h.doc,a,k)}}}c(a,null,!0)}function Zc(a,b){if(b.cm)throw Error("This document is already in use.");a.doc=b;b.cm=a;d(a);c(a);a.options.lineWrapping||r(a);a.options.mode=b.modeOption;ea(a)}function L(a,b){for(b-=a.first;!a.lines;)for(var e=0;;++e){var c=a.children[e],d=c.chunkSize();if(b<d){a=c;break}b-=d}return a.lines[b]}function Qc(a,b,e){var c=[],d=b.line;a.iter(b.line,e.line+1,function(a){a=a.text;d==e.line&&(a=a.slice(0,e.ch));d==b.line&&
(a=a.slice(b.ch));c.push(a);++d});return c}function Wc(a,b,e){var c=[];a.iter(b,e,function(a){c.push(a.text)});return c}function xa(a,b){for(var e=b-a.height,c=a;c;c=c.parent)c.height+=e}function ua(a){if(null==a.parent)return null;var b=a.parent;a=Ma(b.lines,a);for(var e=b.parent;e;b=e,e=e.parent)for(var c=0;e.children[c]!=b;++c)a+=e.children[c].chunkSize();return a+b.first}function xb(a,b){var e=a.first;a:do{for(var c=0,d=a.children.length;c<d;++c){var f=a.children[c],h=f.height;if(b<h){a=f;continue a}b-=
h;e+=f.chunkSize()}return e}while(!a.lines);c=0;for(d=a.lines.length;c<d;++c){f=a.lines[c].height;if(b<f)break;b-=f}return e+c}function zb(a,b){b=Ja(a.doc,b);for(var e=0,c=b.parent,d=0;d<c.lines.length;++d){var f=c.lines[d];if(f==b)break;else e+=f.height}for(f=c.parent;f;c=f,f=c.parent)for(d=0;d<f.children.length;++d){var h=f.children[d];if(h==c)break;else e+=h.height}return e}function Ea(a){var b=a.order;null==b&&(b=a.order=re(a.text));return b}function nc(a){return{done:[],undone:[],undoDepth:Infinity,
lastTime:0,lastOp:null,lastOrigin:null,generation:a||1,maxGeneration:a||1}}function Rd(a,b,e,c){var d=b["spans_"+a.id],f=0;a.iter(Math.max(a.first,e),Math.min(a.first+a.size,c),function(e){e.markedSpans&&((d||(d=b["spans_"+a.id]={}))[f]=e.markedSpans);++f})}function Pc(a,b){var e={from:{line:b.from.line,ch:b.from.ch},to:Mc(b),text:Qc(a,b.from,b.to)};Rd(a,e,b.from.line,b.to.line+1);pb(a,function(a){Rd(a,e,b.from.line,b.to.line+1)},!0);return e}function yd(a,b,e,c){var d=a.history;d.undone.length=0;
var f=+new Date,h=qa(d.done);if(h&&(d.lastOp==c||d.lastOrigin==b.origin&&b.origin&&("+"==b.origin.charAt(0)&&a.cm&&d.lastTime>f-a.cm.options.historyEventDelay||"*"==b.origin.charAt(0)))){var k=qa(h.changes);Z(b.from,b.to)&&Z(b.from,k.to)?k.to=Mc(b):h.changes.push(Pc(a,b));h.anchorAfter=e.anchor;h.headAfter=e.head}else for(h={changes:[Pc(a,b)],generation:d.generation,anchorBefore:a.sel.anchor,headBefore:a.sel.head,anchorAfter:e.anchor,headAfter:e.head},d.done.push(h),d.generation=++d.maxGeneration;d.done.length>
d.undoDepth;)d.done.shift();d.lastTime=f;d.lastOp=c;d.lastOrigin=b.origin}function ne(a){if(!a)return null;for(var b=0,e;b<a.length;++b)a[b].marker.explicitlyCleared?e||(e=a.slice(0,b)):e&&e.push(a[b]);return e?e.length?e:null:a}function oc(a,b){for(var e=0,c=[];e<a.length;++e){var d=a[e],f=d.changes,h=[];c.push({changes:h,anchorBefore:d.anchorBefore,headBefore:d.headBefore,anchorAfter:d.anchorAfter,headAfter:d.headAfter});for(d=0;d<f.length;++d){var k=f[d],l;h.push({from:k.from,to:k.to,text:k.text});
if(b)for(var m in k)(l=m.match(/^spans_(\d+)$/))&&-1<Ma(b,Number(l[1]))&&(qa(h)[m]=k[m],delete k[m])}}return c}function pc(a,b,e,c){e<a.line?a.line+=c:b<a.line&&(a.line=b,a.ch=0)}function Sd(a,b,e,c){for(var d=0;d<a.length;++d){for(var f=a[d],h=!0,k=0;k<f.changes.length;++k){var l=f.changes[k];f.copied||(l.from=Xa(l.from),l.to=Xa(l.to));if(e<l.from.line)l.from.line+=c,l.to.line+=c;else if(b<=l.to.line){h=!1;break}}f.copied||(f.anchorBefore=Xa(f.anchorBefore),f.headBefore=Xa(f.headBefore),f.anchorAfter=
Xa(f.anchorAfter),f.readAfter=Xa(f.headAfter),f.copied=!0);h?(pc(f.anchorBefore),pc(f.headBefore),pc(f.anchorAfter),pc(f.headAfter)):(a.splice(0,d+1),d=0)}}function zd(a,b){var e=b.from.line,c=b.to.line,d=b.text.length-(c-e)-1;Sd(a.done,e,c,d);Sd(a.undone,e,c,d)}function se(){Gb(this)}function Fb(a){a.stop||(a.stop=se);return a}function fa(a){a.preventDefault?a.preventDefault():a.returnValue=!1}function Td(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0}function Gb(a){fa(a);Td(a)}function od(a){var b=
a.which;null==b&&(a.button&1?b=1:a.button&2?b=3:a.button&4&&(b=2));fb&&a.ctrlKey&&1==b&&(b=3);return b}function S(a,b,e){a.addEventListener?a.addEventListener(b,e,!1):a.attachEvent?a.attachEvent("on"+b,e):(a=a._handlers||(a._handlers={}),(a[b]||(a[b]=[])).push(e))}function Ka(a,b,e){if(a.removeEventListener)a.removeEventListener(b,e,!1);else if(a.detachEvent)a.detachEvent("on"+b,e);else if(a=a._handlers&&a._handlers[b])for(b=0;b<a.length;++b)if(a[b]==e){a.splice(b,1);break}}function la(a,b){var e=
a._handlers&&a._handlers[b];if(e)for(var c=Array.prototype.slice.call(arguments,2),d=0;d<e.length;++d)e[d].apply(null,c)}function ra(a,b){function e(a){return function(){a.apply(null,d)}}var c=a._handlers&&a._handlers[b];if(c){var d=Array.prototype.slice.call(arguments,2);Oa||(++Yb,Oa=[],setTimeout(te,0));for(var f=0;f<c.length;++f)Oa.push(e(c[f]))}}function Ga(a,b,e){la(a,e||b.type,a,b);return(null!=b.defaultPrevented?b.defaultPrevented:!1==b.returnValue)||b.codemirrorIgnore}function te(){--Yb;var a=
Oa;Oa=null;for(var b=0;b<a.length;++b)a[b]()}function La(a,b){var e=a._handlers&&a._handlers[b];return e&&0<e.length}function sb(a){a.prototype.on=function(a,g){S(this,a,g)};a.prototype.off=function(a,g){Ka(this,a,g)}}function tc(){this.id=null}function hb(a,b,e,c,d){null==b&&(b=a.search(/[^\s\u00a0]/),-1==b&&(b=a.length));c=c||0;for(d=d||0;c<b;++c)"\t"==a.charAt(c)?d+=e-d%e:++d;return d}function Ed(a){for(;qc.length<=a;)qc.push(qa(qc)+" ");return qc[a]}function qa(a){return a[a.length-1]}function id(a){if(ub)a.selectionStart=
0,a.selectionEnd=a.value.length;else try{a.select()}catch(b){}}function Ma(a,b){if(a.indexOf)return a.indexOf(b);for(var e=0,c=a.length;e<c;++e)if(a[e]==b)return e;return-1}function Ud(a,b){function e(){}e.prototype=a;var c=new e;b&&jc(b,c);return c}function jc(a,b){b||(b={});for(var e in a)a.hasOwnProperty(e)&&(b[e]=a[e]);return b}function fd(a){for(var b=[],e=0;e<a;++e)b.push(void 0);return b}function ta(a){var b=Array.prototype.slice.call(arguments,1);return function(){return a.apply(null,b)}}
function Kb(a){return/\w/.test(a)||"\u0080"<a&&(a.toUpperCase()!=a.toLowerCase()||ue.test(a))}function Vd(a){for(var b in a)if(a.hasOwnProperty(b)&&a[b])return!1;return!0}function K(a,b,e,c){a=document.createElement(a);e&&(a.className=e);c&&(a.style.cssText=c);if("string"==typeof b)bd(a,b);else if(b)for(e=0;e<b.length;++e)a.appendChild(b[e]);return a}function vb(a){for(var b=a.childNodes.length;0<b;--b)a.removeChild(a.firstChild);return a}function Fa(a,b){return vb(a).appendChild(b)}function bd(a,
b){va?(a.innerHTML="",a.appendChild(document.createTextNode(b))):a.textContent=b}function ca(a){return a.getBoundingClientRect()}function lc(){return!1}function wb(a){if(null!=Eb)return Eb;var b=K("div",null,null,"width: 50px; height: 50px; overflow-x: scroll");Fa(a,b);b.offsetWidth&&(Eb=b.offsetHeight-b.clientHeight);return Eb||0}function Ab(a){if(null==Xc){var b=K("span","\u200b");Fa(a,K("span",[b,document.createTextNode("x")]));0!=a.firstChild.offsetHeight&&(Xc=1>=b.offsetWidth&&2<b.offsetHeight&&
!db)}return Xc?K("span","\u200b"):K("span","\u00a0",null,"display: inline-block; width: 1px; margin-right: -1px")}function ae(a,b,e,c){if(!a)return c(b,e,"ltr");for(var d=!1,f=0;f<a.length;++f){var h=a[f];if(h.from<e&&h.to>b||b==e&&h.to==b)c(Math.max(h.from,b),Math.min(h.to,e),1==h.level?"rtl":"ltr"),d=!0}d||c(b,e,"ltr")}function yc(a){return a.level%2?a.from:a.to}function Wb(a){return(a=Ea(a))?a[0].level%2?a[0].to:a[0].from:0}function Xb(a){var b=Ea(a);return b?yc(qa(b)):a.text.length}function Wd(a,
b){var e=L(a.doc,b),c=Ja(a.doc,e);c!=e&&(b=ua(c));c=(e=Ea(c))?e[0].level%2?Xb(c):Wb(c):0;return I(b,c)}function ve(a,b){for(var e,c;e=Ub(c=L(a.doc,b));)b=e.find().to.line;c=(e=Ea(c))?e[0].level%2?Wb(c):Xb(c):c.text.length;return I(b,c)}function zc(a,b){for(var e=0,c;e<a.length;++e){var d=a[e];if(d.from<b&&d.to>b)return ib=null,e;if(d.from==b||d.to==b)if(null==c)c=e;else{var d=d.level,f=a[c].level,h=a[0].level,d=d==h?!0:f==h?!1:d<f;if(d)return ib=c,e;ib=e;return c}}ib=null;return c}function Yc(a,b,
e,c){if(!c)return b+e;do b+=e;while(0<b&&Bc.test(a.text.charAt(b)));return b}function Ac(a,b,e,c){var d=Ea(a);if(!d)return Fd(a,b,e,c);var f=zc(d,b),h=d[f];for(b=Yc(a,b,h.level%2?-e:e,c);;){if(b>h.from&&b<h.to)return b;if(b==h.from||b==h.to){if(zc(d,b)==f)return b;h=d[f+e];return 0<e==h.level%2?h.to:h.from}h=d[f+=e];if(!h)return null;b=0<e==h.level%2?Yc(a,h.to,-1,c):Yc(a,h.from,1,c)}}function Fd(a,b,e,c){b+=e;if(c)for(;0<b&&Bc.test(a.text.charAt(b));)b+=e;return 0>b||b>a.text.length?null:b}var ob=
/gecko\/\d/i.test(navigator.userAgent),da=/MSIE \d/.test(navigator.userAgent),db=da&&(null==document.documentMode||8>document.documentMode),va=da&&(null==document.documentMode||9>document.documentMode),ka=/WebKit\//.test(navigator.userAgent),we=ka&&/Qt\/\d+\.\d+/.test(navigator.userAgent),xe=/Chrome\//.test(navigator.userAgent),ya=/Opera\//.test(navigator.userAgent),Gc=/Apple Computer/.test(navigator.vendor),wc=/KHTML\//.test(navigator.userAgent),Zd=/Mac OS X 1\d\D([7-9]|\d\d)\D/.test(navigator.userAgent),
$d=/Mac OS X 1\d\D([8-9]|\d\d)\D/.test(navigator.userAgent),ce=/PhantomJS/.test(navigator.userAgent),ub=/AppleWebKit/.test(navigator.userAgent)&&/Mobile\/\w+/.test(navigator.userAgent),sc=ub||/Android|webOS|BlackBerry|Opera Mini|Opera Mobi|IEMobile/i.test(navigator.userAgent),fb=ub||/Mac/.test(navigator.platform),ye=/win/i.test(navigator.platform),Za=ya&&navigator.userAgent.match(/Version\/(\d*\.\d*)/);Za&&(Za=Number(Za[1]));Za&&15<=Za&&(ya=!1,ka=!0);var Hd=fb&&(we||ya&&(null==Za||12.11>Za)),Fc=ob||
da&&!va,xd=!1,yb=!1,Ua,be=0,bc,ac,nd=0,cc=0,za=null;da?za=-0.53:ob?za=15:xe?za=-0.7:Gc&&(za=-1/3);var sd,Jc=null,Kc,Mc=a.changeEnd=function(a){return a.text?I(a.from.line+a.text.length-1,qa(a.text).length+(1==a.text.length?a.from.ch:0)):a.to};a.Pos=I;a.prototype={constructor:a,posFromMouse:function(a){return nb(this,a,!0)},focus:function(){window.focus();sa(this);Sa(this);Cb(this)},setOption:function(a,b){var c=this.options,d=c[a];if(c[a]!=b||"mode"==a)c[a]=b,bb.hasOwnProperty(a)&&R(this,bb[a])(this,
b,d)},getOption:function(a){return this.options[a]},getDoc:function(){return this.doc},addKeyMap:function(a,b){this.state.keyMaps[b?"push":"unshift"](a)},removeKeyMap:function(a){for(var b=this.state.keyMaps,c=0;c<b.length;++c)if(b[c]==a||"string"!=typeof b[c]&&b[c].name==a)return b.splice(c,1),!0},addOverlay:R(null,function(b,c){var e=b.token?b:a.getMode(this.options,b);if(e.startState)throw Error("Overlays may not be stateful.");this.state.overlays.push({mode:e,modeSpec:b,opaque:c&&c.opaque});this.state.modeGen++;
ea(this)}),removeOverlay:R(null,function(a){for(var b=this.state.overlays,c=0;c<b.length;++c){var d=b[c].modeSpec;if(d==a||"string"==typeof a&&d.name==a){b.splice(c,1);this.state.modeGen++;ea(this);break}}}),indentLine:R(null,function(a,b,c){"string"!=typeof b&&"number"!=typeof b&&(b=null==b?this.options.smartIndent?"smart":"prev":b?"add":"subtract");qb(this.doc,a)&&ec(this,a,b,c)}),indentSelection:R(null,function(a){var b=this.doc.sel;if(Z(b.from,b.to))return ec(this,b.from.line,a);for(var c=b.to.line-
(b.to.ch?0:1),b=b.from.line;b<=c;++b)ec(this,b,a)}),getTokenAt:function(a,b){var c=this.doc;a=P(c,a);for(var d=Y(this,a.line,b),f=this.doc.mode,c=L(c,a.line),c=new Lb(c.text,this.options.tabSize);c.pos<a.ch&&!c.eol();){c.start=c.pos;var h=f.token(c,d)}return{start:c.start,end:c.pos,string:c.current(),className:h||null,type:h||null,state:d}},getTokenTypeAt:function(a){a=P(this.doc,a);var b=Md(this,L(this.doc,a.line)),c=0,d=(b.length-1)/2;a=a.ch;if(0==a)return b[2];for(;;){var f=c+d>>1;if((f?b[2*f-
1]:0)>=a)d=f;else if(b[2*f+1]<a)c=f+1;else return b[2*f+2]}},getModeAt:function(b){var c=this.doc.mode;return c.innerMode?a.innerMode(c,this.getTokenAt(b).state).mode:c},getHelper:function(a,b){if(Qb.hasOwnProperty(b)){var c=Qb[b],d=this.getModeAt(a);return d[b]&&c[d[b]]||d.helperType&&c[d.helperType]||c[d.name]}},getStateAfter:function(a,b){var c=this.doc;a=Math.max(c.first,Math.min(null==a?c.first+c.size-1:a,c.first+c.size-1));return Y(this,a+1,b)},cursorCoords:function(a,b){var c;c=this.doc.sel;
c=null==a?c.head:"object"==typeof a?P(this.doc,a):a?c.from:c.to;return ja(this,c,b||"page")},charCoords:function(a,b){return Da(this,P(this.doc,a),b||"page")},coordsChar:function(a,b){a=Ca(this,a,b||"page");return X(this,a.left,a.top)},lineAtHeight:function(a,b){a=Ca(this,{top:a,left:0},b||"page").top;return xb(this.doc,a+this.display.viewOffset)},heightAtLine:function(a,b){var c=!1,d=this.doc.first+this.doc.size-1;a<this.doc.first?a=this.doc.first:a>d&&(a=d,c=!0);d=L(this.doc,a);return Ba(this,L(this.doc,
a),{top:0,left:0},b||"page").top+(c?d.height:0)},defaultTextHeight:function(){return Na(this.display)},defaultCharWidth:function(){return ad(this.display)},setGutterMarker:R(null,function(a,b,c){return ic(this,a,function(a){var g=a.gutterMarkers||(a.gutterMarkers={});g[b]=c;!c&&Vd(g)&&(a.gutterMarkers=null);return!0})}),clearGutter:R(null,function(a){var b=this,c=b.doc,d=c.first;c.iter(function(c){c.gutterMarkers&&c.gutterMarkers[a]&&(c.gutterMarkers[a]=null,ea(b,d,d+1),Vd(c.gutterMarkers)&&(c.gutterMarkers=
null));++d})}),addLineClass:R(null,function(a,b,c){return ic(this,a,function(a){var g="text"==b?"textClass":"background"==b?"bgClass":"wrapClass";if(a[g]){if(RegExp("(?:^|\\s)"+c+"(?:$|\\s)").test(a[g]))return!1;a[g]+=" "+c}else a[g]=c;return!0})}),removeLineClass:R(null,function(a,b,c){return ic(this,a,function(a){var g="text"==b?"textClass":"background"==b?"bgClass":"wrapClass",d=a[g];if(d)if(null==c)a[g]=null;else{var f=d.match(RegExp("(?:^|\\s+)"+c+"(?:$|\\s+)"));if(!f)return!1;var h=f.index+
f[0].length;a[g]=d.slice(0,f.index)+(f.index&&h!=d.length?" ":"")+d.slice(h)||null}else return!1;return!0})}),addLineWidget:R(null,function(a,b,c){return oe(this,a,b,c)}),removeLineWidget:function(a){a.clear()},lineInfo:function(a){if("number"==typeof a){if(!qb(this.doc,a))return null;var b=a;a=L(this.doc,a);if(!a)return null}else if(b=ua(a),null==b)return null;return{line:b,handle:a,text:a.text,gutterMarkers:a.gutterMarkers,textClass:a.textClass,bgClass:a.bgClass,wrapClass:a.wrapClass,widgets:a.widgets}},
getViewport:function(){return{from:this.display.showingFrom,to:this.display.showingTo}},addWidget:function(a,b,c,d,f){var h=this.display;a=ja(this,P(this.doc,a));var k=a.bottom,l=a.left;b.style.position="absolute";h.sizer.appendChild(b);if("over"==d)k=a.top;else if("above"==d||"near"==d){var m=Math.max(h.wrapper.clientHeight,this.doc.height),p=Math.max(h.sizer.clientWidth,h.lineSpace.clientWidth);("above"==d||a.bottom+b.offsetHeight>m)&&a.top>b.offsetHeight?k=a.top-b.offsetHeight:a.bottom+b.offsetHeight<=
m&&(k=a.bottom);l+b.offsetWidth>p&&(l=p-b.offsetWidth)}b.style.top=k+"px";b.style.left=b.style.right="";"right"==f?(l=h.sizer.clientWidth-b.offsetWidth,b.style.right="0px"):("left"==f?l=0:"middle"==f&&(l=(h.sizer.clientWidth-b.offsetWidth)/2),b.style.left=l+"px");c&&(a=Zb(this,l,k,l+b.offsetWidth,k+b.offsetHeight),null!=a.scrollTop&&Hb(this,a.scrollTop),null!=a.scrollLeft&&lb(this,a.scrollLeft))},triggerOnKeyDown:R(null,md),execCommand:function(a){return Hc[a](this)},findPosH:function(a,b,c,d){var f=
1;0>b&&(f=-1,b=-b);var h=0;for(a=P(this.doc,a);h<b&&(a=Tc(this.doc,a,f,c,d),!a.hitSide);++h);return a},moveH:R(null,function(a,b){var c=this.doc.sel,c=c.shift||c.extend||Z(c.from,c.to)?Tc(this.doc,c.head,a,b,this.options.rtlMoveVisually):0>a?c.from:c.to;ma(this.doc,c,c,a)}),deleteH:R(null,function(a,b){var c=this.doc.sel;Z(c.from,c.to)?Qa(this.doc,"",c.from,Tc(this.doc,c.head,a,b,!1),"+delete"):Qa(this.doc,"",c.from,c.to,"+delete");this.curOp.userSelChange=!0}),findPosV:function(a,b,c,d){var f=1;
0>b&&(f=-1,b=-b);var h=0;for(a=P(this.doc,a);h<b&&(a=ja(this,a,"div"),null==d?d=a.left:a.left=d,a=Gd(this,a,f,c),!a.hitSide);++h);return a},moveV:R(null,function(a,b){var c=this.doc.sel,d=ja(this,c.head,"div");null!=c.goalColumn&&(d.left=c.goalColumn);var f=Gd(this,d,a,b);"page"==b&&Sc(this,0,Da(this,f,"div").top-d.top);ma(this.doc,f,f,a);c.goalColumn=d.left}),toggleOverwrite:function(a){if(null==a||a!=this.state.overwrite)(this.state.overwrite=!this.state.overwrite)?this.display.cursor.className+=
" CodeMirror-overwrite":this.display.cursor.className=this.display.cursor.className.replace(" CodeMirror-overwrite","")},hasFocus:function(){return this.state.focused},scrollTo:R(null,function(a,b){hc(this,a,b)}),getScrollInfo:function(){var a=this.display.scroller,b=cb;return{left:a.scrollLeft,top:a.scrollTop,height:a.scrollHeight-b,width:a.scrollWidth-b,clientHeight:a.clientHeight-b,clientWidth:a.clientWidth-b}},scrollIntoView:R(null,function(a,b){"number"==typeof a&&(a=I(a,0));b||(b=0);var c=a;
a&&null==a.line||(this.curOp.scrollToPos=a?P(this.doc,a):this.doc.sel.head,this.curOp.scrollToPosMargin=b,c=ja(this,this.curOp.scrollToPos));c=Zb(this,c.left,c.top-b,c.right,c.bottom+b);hc(this,c.scrollLeft,c.scrollTop)}),setSize:R(null,function(a,b){function c(a){return"number"==typeof a||/^\d+$/.test(String(a))?a+"px":a}null!=a&&(this.display.wrapper.style.width=c(a));null!=b&&(this.display.wrapper.style.height=c(b));this.options.lineWrapping&&(this.display.measureLineCache.length=this.display.measureLineCachePos=
0);this.curOp.forceUpdate=!0}),operation:function(a){return Cc(this,a)},refresh:R(null,function(){ha(this);hc(this,this.doc.scrollLeft,this.doc.scrollTop);ea(this)}),swapDoc:R(null,function(a){var b=this.doc;b.cm=null;Zc(this,a);ha(this);Ha(this,!0);hc(this,a.scrollLeft,a.scrollTop);return b}),getInputField:function(){return this.display.input},getWrapperElement:function(){return this.display.wrapper},getScrollerElement:function(){return this.display.scroller},getGutterElement:function(){return this.display.gutters}};
sb(a);var bb=a.optionHandlers={},rc=a.defaults={},$c=a.Init={toString:function(){return"CodeMirror.Init"}};T("value","",function(a,b){a.setValue(b)},!0);T("mode",null,function(a,b){a.doc.modeOption=b;c(a)},!0);T("indentUnit",2,c,!0);T("indentWithTabs",!1);T("smartIndent",!0);T("tabSize",4,function(a){c(a);ha(a);ea(a)},!0);T("electricChars",!0);T("rtlMoveVisually",!ye);T("theme","default",function(a){m(a);l(a)},!0);T("keyMap","default",h);T("extraKeys",null);T("onKeyEvent",null);T("onDragEvent",null);
T("lineWrapping",!1,function(a){a.options.lineWrapping?(a.display.wrapper.className+=" CodeMirror-wrap",a.display.sizer.style.minWidth=""):(a.display.wrapper.className=a.display.wrapper.className.replace(" CodeMirror-wrap",""),r(a));d(a);ea(a);ha(a);setTimeout(function(){w(a)},100)},!0);T("gutters",[],function(a){v(a.options);l(a)},!0);T("fixedGutter",!0,function(a,b){a.display.gutters.style.left=b?k(a.display)+"px":"0";a.refresh()},!0);T("coverGutterNextToScrollbar",!1,w,!0);T("lineNumbers",!1,function(a){v(a.options);
l(a)},!0);T("firstLineNumber",1,l,!0);T("lineNumberFormatter",function(a){return a},l,!0);T("showCursorWhenSelecting",!1,U,!0);T("readOnly",!1,function(a,b){"nocursor"==b?(uc(a),a.display.input.blur()):b||Ha(a,!0)});T("dragDrop",!0);T("cursorBlinkRate",530);T("cursorScrollMargin",0);T("cursorHeight",1);T("workTime",100);T("workDelay",100);T("flattenSpans",!0);T("pollInterval",100);T("undoDepth",40,function(a,b){a.doc.history.undoDepth=b});T("historyEventDelay",500);T("viewportMargin",10,function(a){a.refresh()},
!0);T("maxHighlightLength",1E4,function(a){c(a);a.refresh()},!0);T("moveInputWithCursor",!0,function(a,b){b||(a.display.inputDiv.style.top=a.display.inputDiv.style.left=0)});T("tabindex",null,function(a,b){a.display.input.tabIndex=b||""});T("autofocus",null);var Xd=a.modes={},Rb=a.mimeModes={};a.defineMode=function(b,c){a.defaults.mode||"null"==b||(a.defaults.mode=b);if(2<arguments.length){c.dependencies=[];for(var e=2;e<arguments.length;++e)c.dependencies.push(arguments[e])}Xd[b]=c};a.defineMIME=
function(a,b){Rb[a]=b};a.resolveMode=function(b){if("string"==typeof b&&Rb.hasOwnProperty(b))b=Rb[b];else if(b&&"string"==typeof b.name&&Rb.hasOwnProperty(b.name)){var c=Rb[b.name];b=Ud(c,b);b.name=c.name}else if("string"==typeof b&&/^[\w\-]+\/[\w\-]+\+xml$/.test(b))return a.resolveMode("application/xml");return"string"==typeof b?{name:b}:b||{name:"null"}};a.getMode=function(b,c){c=a.resolveMode(c);var e=Xd[c.name];if(!e)return a.getMode(b,"text/plain");e=e(b,c);if(Sb.hasOwnProperty(c.name)){var d=
Sb[c.name],f;for(f in d)d.hasOwnProperty(f)&&(e.hasOwnProperty(f)&&(e["_"+f]=e[f]),e[f]=d[f])}e.name=c.name;return e};a.defineMode("null",function(){return{token:function(a){a.skipToEnd()}}});a.defineMIME("text/plain","null");var Sb=a.modeExtensions={};a.extendMode=function(a,b){var c=Sb.hasOwnProperty(a)?Sb[a]:Sb[a]={};jc(b,c)};a.defineExtension=function(b,c){a.prototype[b]=c};a.defineDocExtension=function(a,b){oa.prototype[a]=b};a.defineOption=T;var vc=[];a.defineInitHook=function(a){vc.push(a)};
var Qb=a.helpers={};a.registerHelper=function(b,c,e){Qb.hasOwnProperty(b)||(Qb[b]=a[b]={});Qb[b][c]=e};a.isWordChar=Kb;a.copyState=gb;a.startState=ed;a.innerMode=function(a,b){for(;a.innerMode;){var c=a.innerMode(b);if(!c||c.mode==a)break;b=c.state;a=c.mode}return c||{mode:a,state:b}};var Hc=a.commands={selectAll:function(a){a.setSelection(I(a.firstLine(),0),I(a.lastLine()))},killLine:function(a){var b=a.getCursor(!0),c=a.getCursor(!1),d=!Z(b,c);d||a.getLine(b.line).length!=b.ch?a.replaceRange("",
b,d?c:I(b.line),"+delete"):a.replaceRange("",b,I(b.line+1,0),"+delete")},deleteLine:function(a){var b=a.getCursor().line;a.replaceRange("",I(b,0),I(b),"+delete")},delLineLeft:function(a){var b=a.getCursor();a.replaceRange("",I(b.line,0),b,"+delete")},undo:function(a){a.undo()},redo:function(a){a.redo()},goDocStart:function(a){a.extendSelection(I(a.firstLine(),0))},goDocEnd:function(a){a.extendSelection(I(a.lastLine()))},goLineStart:function(a){a.extendSelection(Wd(a,a.getCursor().line))},goLineStartSmart:function(a){var b=
a.getCursor(),c=Wd(a,b.line),d=a.getLineHandle(c.line),f=Ea(d);f&&0!=f[0].level?a.extendSelection(c):(d=Math.max(0,d.text.search(/\S/)),a.extendSelection(I(c.line,b.line==c.line&&b.ch<=d&&b.ch?0:d)))},goLineEnd:function(a){a.extendSelection(ve(a,a.getCursor().line))},goLineRight:function(a){var b=a.charCoords(a.getCursor(),"div").top+5;a.extendSelection(a.coordsChar({left:a.display.lineDiv.offsetWidth+100,top:b},"div"))},goLineLeft:function(a){var b=a.charCoords(a.getCursor(),"div").top+5;a.extendSelection(a.coordsChar({left:0,
top:b},"div"))},goLineUp:function(a){a.moveV(-1,"line")},goLineDown:function(a){a.moveV(1,"line")},goPageUp:function(a){a.moveV(-1,"page")},goPageDown:function(a){a.moveV(1,"page")},goCharLeft:function(a){a.moveH(-1,"char")},goCharRight:function(a){a.moveH(1,"char")},goColumnLeft:function(a){a.moveH(-1,"column")},goColumnRight:function(a){a.moveH(1,"column")},goWordLeft:function(a){a.moveH(-1,"word")},goGroupRight:function(a){a.moveH(1,"group")},goGroupLeft:function(a){a.moveH(-1,"group")},goWordRight:function(a){a.moveH(1,
"word")},delCharBefore:function(a){a.deleteH(-1,"char")},delCharAfter:function(a){a.deleteH(1,"char")},delWordBefore:function(a){a.deleteH(-1,"word")},delWordAfter:function(a){a.deleteH(1,"word")},delGroupBefore:function(a){a.deleteH(-1,"group")},delGroupAfter:function(a){a.deleteH(1,"group")},indentAuto:function(a){a.indentSelection("smart")},indentMore:function(a){a.indentSelection("add")},indentLess:function(a){a.indentSelection("subtract")},insertTab:function(a){a.replaceSelection("\t","end",
"+input")},defaultTab:function(a){a.somethingSelected()?a.indentSelection("add"):a.replaceSelection("\t","end","+input")},transposeChars:function(a){var b=a.getCursor(),c=a.getLine(b.line);0<b.ch&&b.ch<c.length-1&&a.replaceRange(c.charAt(b.ch)+c.charAt(b.ch-1),I(b.line,b.ch-1),I(b.line,b.ch+1))},newlineAndIndent:function(a){R(a,function(){a.replaceSelection("\n","end","+input");a.indentLine(a.getCursor().line,null,!0)})()},toggleOverwrite:function(a){a.toggleOverwrite()}},Ia=a.keyMap={};Ia.basic=
{Left:"goCharLeft",Right:"goCharRight",Up:"goLineUp",Down:"goLineDown",End:"goLineEnd",Home:"goLineStartSmart",PageUp:"goPageUp",PageDown:"goPageDown",Delete:"delCharAfter",Backspace:"delCharBefore",Tab:"defaultTab","Shift-Tab":"indentAuto",Enter:"newlineAndIndent",Insert:"toggleOverwrite"};Ia.pcDefault={"Ctrl-A":"selectAll","Ctrl-D":"deleteLine","Ctrl-Z":"undo","Shift-Ctrl-Z":"redo","Ctrl-Y":"redo","Ctrl-Home":"goDocStart","Alt-Up":"goDocStart","Ctrl-End":"goDocEnd","Ctrl-Down":"goDocEnd","Ctrl-Left":"goGroupLeft",
"Ctrl-Right":"goGroupRight","Alt-Left":"goLineStart","Alt-Right":"goLineEnd","Ctrl-Backspace":"delGroupBefore","Ctrl-Delete":"delGroupAfter","Ctrl-S":"save","Ctrl-F":"find","Ctrl-G":"findNext","Shift-Ctrl-G":"findPrev","Shift-Ctrl-F":"replace","Shift-Ctrl-R":"replaceAll","Ctrl-[":"indentLess","Ctrl-]":"indentMore",fallthrough:"basic"};Ia.macDefault={"Cmd-A":"selectAll","Cmd-D":"deleteLine","Cmd-Z":"undo","Shift-Cmd-Z":"redo","Cmd-Y":"redo","Cmd-Up":"goDocStart","Cmd-End":"goDocEnd","Cmd-Down":"goDocEnd",
"Alt-Left":"goGroupLeft","Alt-Right":"goGroupRight","Cmd-Left":"goLineStart","Cmd-Right":"goLineEnd","Alt-Backspace":"delGroupBefore","Ctrl-Alt-Backspace":"delGroupAfter","Alt-Delete":"delGroupAfter","Cmd-S":"save","Cmd-F":"find","Cmd-G":"findNext","Shift-Cmd-G":"findPrev","Cmd-Alt-F":"replace","Shift-Cmd-Alt-F":"replaceAll","Cmd-[":"indentLess","Cmd-]":"indentMore","Cmd-Backspace":"delLineLeft",fallthrough:["basic","emacsy"]};Ia["default"]=fb?Ia.macDefault:Ia.pcDefault;Ia.emacsy={"Ctrl-F":"goCharRight",
"Ctrl-B":"goCharLeft","Ctrl-P":"goLineUp","Ctrl-N":"goLineDown","Alt-F":"goWordRight","Alt-B":"goWordLeft","Ctrl-A":"goLineStart","Ctrl-E":"goLineEnd","Ctrl-V":"goPageDown","Shift-Ctrl-V":"goPageUp","Ctrl-D":"delCharAfter","Ctrl-H":"delCharBefore","Alt-D":"delWordAfter","Alt-Backspace":"delWordBefore","Ctrl-K":"killLine","Ctrl-T":"transposeChars"};a.lookupKey=Ib;a.isModifierKey=td;a.keyName=ud;a.fromTextArea=function(b,c){function e(){b.value=p.getValue()}c||(c={});c.value=b.value;!c.tabindex&&b.tabindex&&
(c.tabindex=b.tabindex);!c.placeholder&&b.placeholder&&(c.placeholder=b.placeholder);if(null==c.autofocus){var d=document.body;try{d=document.activeElement}catch(f){}c.autofocus=d==b||null!=b.getAttribute("autofocus")&&d==document.body}if(b.form&&(S(b.form,"submit",e),!c.leaveSubmitMethodAlone)){var h=b.form,k=h.submit;try{var l=h.submit=function(){e();h.submit=k;h.submit();h.submit=l}}catch(m){}}b.style.display="none";var p=a(function(a){b.parentNode.insertBefore(a,b.nextSibling)},c);p.save=e;p.getTextArea=
function(){return b};p.toTextArea=function(){e();b.parentNode.removeChild(p.getWrapperElement());b.style.display="";b.form&&(Ka(b.form,"submit",e),"function"==typeof b.form.submit&&(b.form.submit=k))};return p};Lb.prototype={eol:function(){return this.pos>=this.string.length},sol:function(){return 0==this.pos},peek:function(){return this.string.charAt(this.pos)||void 0},next:function(){if(this.pos<this.string.length)return this.string.charAt(this.pos++)},eat:function(a){var b=this.string.charAt(this.pos);
if("string"==typeof a?b==a:b&&(a.test?a.test(b):a(b)))return++this.pos,b},eatWhile:function(a){for(var b=this.pos;this.eat(a););return this.pos>b},eatSpace:function(){for(var a=this.pos;/[\s\u00a0]/.test(this.string.charAt(this.pos));)++this.pos;return this.pos>a},skipToEnd:function(){this.pos=this.string.length},skipTo:function(a){a=this.string.indexOf(a,this.pos);if(-1<a)return this.pos=a,!0},backUp:function(a){this.pos-=a},column:function(){this.lastColumnPos<this.start&&(this.lastColumnValue=
hb(this.string,this.start,this.tabSize,this.lastColumnPos,this.lastColumnValue),this.lastColumnPos=this.start);return this.lastColumnValue},indentation:function(){return hb(this.string,null,this.tabSize)},match:function(a,b,c){if("string"==typeof a){var d=this.string.substr(this.pos,a.length);if((c?d.toLowerCase():d)==(c?a.toLowerCase():a))return!1!==b&&(this.pos+=a.length),!0}else{if((a=this.string.slice(this.pos).match(a))&&0<a.index)return null;a&&!1!==b&&(this.pos+=a[0].length);return a}},current:function(){return this.string.slice(this.start,
this.pos)}};a.StringStream=Lb;a.TextMarker=Ra;sb(Ra);Ra.prototype.clear=function(){if(!this.explicitlyCleared){var a=this.doc.cm,b=a&&!a.curOp;b&&jb(a);if(La(this,"clear")){var c=this.find();c&&ra(this,"clear",c.from,c.to)}for(var d=c=null,f=0;f<this.lines.length;++f){var h=this.lines[f],k=Ob(h.markedSpans,this);null!=k.to&&(d=ua(h));for(var l=h,m=h.markedSpans,p=k,q=void 0,r=0;r<m.length;++r)m[r]!=p&&(q||(q=[])).push(m[r]);l.markedSpans=q;null!=k.from?c=ua(h):this.collapsed&&!Ta(this.doc,h)&&a&&
xa(h,Na(a.display))}if(a&&this.collapsed&&!a.options.lineWrapping)for(f=0;f<this.lines.length;++f)h=Ja(a.doc,this.lines[f]),k=t(a.doc,h),k>a.display.maxLineLength&&(a.display.maxLine=h,a.display.maxLineLength=k,a.display.maxLineChanged=!0);null!=c&&a&&ea(a,c,d+1);this.lines.length=0;this.explicitlyCleared=!0;this.atomic&&this.doc.cantEdit&&(this.doc.cantEdit=!1,a&&Dd(a));b&&kb(a)}};Ra.prototype.find=function(){for(var a,b,c=0;c<this.lines.length;++c){var d=this.lines[c],f=Ob(d.markedSpans,this);if(null!=
f.from||null!=f.to)d=ua(d),null!=f.from&&(a=I(d,f.from)),null!=f.to&&(b=I(d,f.to))}return"bookmark"==this.type?a:a&&{from:a,to:b}};Ra.prototype.changed=function(){var a=this.find(),b=this.doc.cm;if(a&&b){"bookmark"!=this.type&&(a=a.from);var c=L(this.doc,a.line);na(b,c);if(a.line>=b.display.showingFrom&&a.line<b.display.showingTo){for(a=b.display.lineDiv.firstChild;a;a=a.nextSibling)if(a.lineObj==c){a.offsetHeight!=c.height&&xa(c,a.offsetHeight);break}Cc(b,function(){b.curOp.selectionChanged=b.curOp.forceUpdate=
b.curOp.updateMaxLine=!0})}}};Ra.prototype.attachLine=function(a){if(!this.lines.length&&this.doc.cm){var b=this.doc.cm.curOp;b.maybeHiddenMarkers&&-1!=Ma(b.maybeHiddenMarkers,this)||(b.maybeUnhiddenMarkers||(b.maybeUnhiddenMarkers=[])).push(this)}this.lines.push(a)};Ra.prototype.detachLine=function(a){this.lines.splice(Ma(this.lines,a),1);!this.lines.length&&this.doc.cm&&(a=this.doc.cm.curOp,(a.maybeHiddenMarkers||(a.maybeHiddenMarkers=[])).push(this))};a.SharedTextMarker=Nb;sb(Nb);Nb.prototype.clear=
function(){if(!this.explicitlyCleared){this.explicitlyCleared=!0;for(var a=0;a<this.markers.length;++a)this.markers[a].clear();ra(this,"clear")}};Nb.prototype.find=function(){return this.primary.find()};var kc=a.LineWidget=function(a,b,c){if(c)for(var d in c)c.hasOwnProperty(d)&&(this[d]=c[d]);this.cm=a;this.node=b};sb(kc);kc.prototype.clear=Kd(function(){var a=this.line.widgets,b=ua(this.line);if(null!=b&&a){for(var c=0;c<a.length;++c)a[c]==this&&a.splice(c--,1);a.length||(this.line.widgets=null);
a=zb(this.cm,this.line)<this.cm.doc.scrollTop;xa(this.line,Math.max(0,this.line.height-Vb(this)));a&&Sc(this.cm,0,-this.height);ea(this.cm,b,b+1)}});kc.prototype.changed=Kd(function(){var a=this.height;this.height=null;if(a=Vb(this)-a)xa(this.line,this.line.height+a),a=ua(this.line),ea(this.cm,a,a+1)});var rb=a.Line=function(a,b,c){this.text=a;Jd(this,b);this.height=c?c(this):1};sb(rb);var Od={},Vc=/[\t\u0000-\u0019\u00ad\u200b\u2028\u2029\uFEFF]/g;mc.prototype={chunkSize:function(){return this.lines.length},
removeInner:function(a,b){for(var c=a,d=a+b;c<d;++c){var f=this.lines[c];this.height-=f.height;var h=f;h.parent=null;Id(h);ra(f,"delete")}this.lines.splice(a,b)},collapse:function(a){a.splice.apply(a,[a.length,0].concat(this.lines))},insertInner:function(a,b,c){this.height+=c;this.lines=this.lines.slice(0,a).concat(b).concat(this.lines.slice(a));a=0;for(c=b.length;a<c;++a)b[a].parent=this},iterN:function(a,b,c){for(b=a+b;a<b;++a)if(c(this.lines[a]))return!0}};Pb.prototype={chunkSize:function(){return this.size},
removeInner:function(a,b){this.size-=b;for(var c=0;c<this.children.length;++c){var d=this.children[c],f=d.chunkSize();if(a<f){var h=Math.min(b,f-a),k=d.height;d.removeInner(a,h);this.height-=k-d.height;f==h&&(this.children.splice(c--,1),d.parent=null);if(0==(b-=h))break;a=0}else a-=f}25>this.size-b&&(c=[],this.collapse(c),this.children=[new mc(c)],this.children[0].parent=this)},collapse:function(a){for(var b=0,c=this.children.length;b<c;++b)this.children[b].collapse(a)},insertInner:function(a,b,c){this.size+=
b.length;this.height+=c;for(var d=0,f=this.children.length;d<f;++d){var h=this.children[d],k=h.chunkSize();if(a<=k){h.insertInner(a,b,c);if(h.lines&&50<h.lines.length){for(;50<h.lines.length;)a=h.lines.splice(h.lines.length-25,25),a=new mc(a),h.height-=a.height,this.children.splice(d+1,0,a),a.parent=this;this.maybeSpill()}break}a-=k}},maybeSpill:function(){if(!(10>=this.children.length)){var a=this;do{var b=a.children.splice(a.children.length-5,5),b=new Pb(b);if(a.parent){a.size-=b.size;a.height-=
b.height;var c=Ma(a.parent.children,a);a.parent.children.splice(c+1,0,b)}else c=new Pb(a.children),c.parent=a,a.children=[c,b],a=c;b.parent=a.parent}while(10<a.children.length);a.parent.maybeSpill()}},iterN:function(a,b,c){for(var d=0,f=this.children.length;d<f;++d){var h=this.children[d],k=h.chunkSize();if(a<k){k=Math.min(b,k-a);if(h.iterN(a,k,c))return!0;if(0==(b-=k))break;a=0}else a-=k}}};var ze=0,oa=a.Doc=function(a,b,c){if(!(this instanceof oa))return new oa(a,b,c);null==c&&(c=0);Pb.call(this,
[new mc([new rb("",null)])]);this.first=c;this.scrollTop=this.scrollLeft=0;this.cantEdit=!1;this.history=nc();this.cleanGeneration=1;this.frontier=c;c=I(c,0);this.sel={from:c,to:c,head:c,anchor:c,shift:!1,extend:!1,goalColumn:null};this.id=++ze;this.modeOption=b;"string"==typeof a&&(a=Va(a));Rc(this,{from:c,to:c,text:a},null,{head:c,anchor:c})};oa.prototype=Ud(Pb.prototype,{constructor:oa,iter:function(a,b,c){c?this.iterN(a-this.first,b-a,c):this.iterN(this.first,this.first+this.size,a)},insert:function(a,
b){for(var c=0,d=0,f=b.length;d<f;++d)c+=b[d].height;this.insertInner(a-this.first,b,c)},remove:function(a,b){this.removeInner(a-this.first,b)},getValue:function(a){var b=Wc(this,this.first,this.first+this.size);return!1===a?b:b.join(a||"\n")},setValue:function(a){var b=I(this.first,0),c=this.first+this.size-1;mb(this,{from:b,to:I(c,L(this,c).text.length),text:Va(a),origin:"setValue"},{head:b,anchor:b},!0)},replaceRange:function(a,b,c,d){b=P(this,b);c=c?P(this,c):b;Qa(this,a,b,c,d)},getRange:function(a,
b,c){a=Qc(this,P(this,a),P(this,b));return!1===c?a:a.join(c||"\n")},getLine:function(a){return(a=this.getLineHandle(a))&&a.text},setLine:function(a,b){qb(this,a)&&Qa(this,b,I(a,0),P(this,I(a)))},removeLine:function(a){a?Qa(this,"",P(this,I(a-1)),P(this,I(a))):Qa(this,"",I(0,0),P(this,I(1,0)))},getLineHandle:function(a){if(qb(this,a))return L(this,a)},getLineNumber:function(a){return ua(a)},getLineHandleVisualStart:function(a){"number"==typeof a&&(a=L(this,a));return Ja(this,a)},lineCount:function(){return this.size},
firstLine:function(){return this.first},lastLine:function(){return this.first+this.size-1},clipPos:function(a){return P(this,a)},getCursor:function(a){var b=this.sel;return Xa(null==a||"head"==a?b.head:"anchor"==a?b.anchor:"end"==a||!1===a?b.to:b.from)},somethingSelected:function(){return!Z(this.sel.head,this.sel.anchor)},setCursor:Bb(function(a,b,c){a=P(this,"number"==typeof a?I(a,b||0):a);c?ma(this,a):Pa(this,a,a)}),setSelection:Bb(function(a,b,c){Pa(this,P(this,a),P(this,b||a),c)}),extendSelection:Bb(function(a,
b,c){ma(this,P(this,a),b&&P(this,b),c)}),getSelection:function(a){return this.getRange(this.sel.from,this.sel.to,a)},replaceSelection:function(a,b,c){mb(this,{from:this.sel.from,to:this.sel.to,text:Va(a),origin:c},b||"around")},undo:Bb(function(){Ad(this,"undo")}),redo:Bb(function(){Ad(this,"redo")}),setExtending:function(a){this.sel.extend=a},historySize:function(){var a=this.history;return{undo:a.done.length,redo:a.undone.length}},clearHistory:function(){this.history=nc(this.history.maxGeneration)},
markClean:function(){this.cleanGeneration=this.changeGeneration()},changeGeneration:function(){this.history.lastOp=this.history.lastOrigin=null;return this.history.generation},isClean:function(a){return this.history.generation==(a||this.cleanGeneration)},getHistory:function(){return{done:oc(this.history.done),undone:oc(this.history.undone)}},setHistory:function(a){var b=this.history=nc(this.history.maxGeneration);b.done=a.done.slice(0);b.undone=a.undone.slice(0)},markText:function(a,b,c){return Mb(this,
P(this,a),P(this,b),c,"range")},setBookmark:function(a,b){var c={replacedWith:b&&(null==b.nodeType?b.widget:b),insertLeft:b&&b.insertLeft};a=P(this,a);return Mb(this,a,a,c,"bookmark")},findMarksAt:function(a){a=P(this,a);var b=[],c=L(this,a.line).markedSpans;if(c)for(var d=0;d<c.length;++d){var f=c[d];(null==f.from||f.from<=a.ch)&&(null==f.to||f.to>=a.ch)&&b.push(f.marker.parent||f.marker)}return b},getAllMarks:function(){var a=[];this.iter(function(b){if(b=b.markedSpans)for(var c=0;c<b.length;++c)null!=
b[c].from&&a.push(b[c].marker)});return a},posFromIndex:function(a){var b,c=this.first;this.iter(function(d){d=d.text.length+1;if(d>a)return b=a,!0;a-=d;++c});return P(this,I(c,b))},indexFromPos:function(a){a=P(this,a);var b=a.ch;if(a.line<this.first||0>a.ch)return 0;this.iter(this.first,a.line,function(a){b+=a.text.length+1});return b},copy:function(a){var b=new oa(Wc(this,this.first,this.first+this.size),this.modeOption,this.first);b.scrollTop=this.scrollTop;b.scrollLeft=this.scrollLeft;b.sel={from:this.sel.from,
to:this.sel.to,head:this.sel.head,anchor:this.sel.anchor,shift:this.sel.shift,extend:!1,goalColumn:this.sel.goalColumn};a&&(b.history.undoDepth=this.history.undoDepth,b.setHistory(this.getHistory()));return b},linkedDoc:function(a){a||(a={});var b=this.first,c=this.first+this.size;null!=a.from&&a.from>b&&(b=a.from);null!=a.to&&a.to<c&&(c=a.to);b=new oa(Wc(this,b,c),a.mode||this.modeOption,b);a.sharedHist&&(b.history=this.history);(this.linked||(this.linked=[])).push({doc:b,sharedHist:a.sharedHist});
b.linked=[{doc:this,isParent:!0,sharedHist:a.sharedHist}];return b},unlinkDoc:function(b){b instanceof a&&(b=b.doc);if(this.linked)for(var c=0;c<this.linked.length;++c)if(this.linked[c].doc==b){this.linked.splice(c,1);b.unlinkDoc(this);break}if(b.history==this.history){var d=[b.id];pb(b,function(a){d.push(a.id)},!0);b.history=nc();b.history.done=oc(this.history.done,d);b.history.undone=oc(this.history.undone,d)}},iterLinkedDocs:function(a){pb(this,a)},getMode:function(){return this.mode},getEditor:function(){return this.cm}});
oa.prototype.eachLine=oa.prototype.iter;var Ae=["iter","insert","remove","copy","getEditor"],Tb;for(Tb in oa.prototype)oa.prototype.hasOwnProperty(Tb)&&0>Ma(Ae,Tb)&&(a.prototype[Tb]=function(a){return function(){return a.apply(this.doc,arguments)}}(oa.prototype[Tb]));sb(oa);a.e_stop=Gb;a.e_preventDefault=fa;a.e_stopPropagation=Td;var Oa,Yb=0;a.on=S;a.off=Ka;a.signal=la;var cb=30,pd=a.Pass={toString:function(){return"CodeMirror.Pass"}};tc.prototype={set:function(a,b){clearTimeout(this.id);this.id=
setTimeout(b,a)}};a.countColumn=hb;var qc=[""],ue=/[\u3040-\u309f\u30a0-\u30ff\u3400-\u4db5\u4e00-\u9fcc\uac00-\ud7af]/,Bc=/[\u0300-\u036F\u0483-\u0487\u0488-\u0489\u0591-\u05BD\u05BF\u05C1-\u05C2\u05C4-\u05C5\u05C7\u0610-\u061A\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7-\u06E8\u06EA-\u06ED\uA66F\uA670-\uA672\uA674-\uA67D\uA69F\udc00-\udfff]/;a.replaceGetRect=function(a){ca=a};var ie=function(){if(va)return!1;var a=K("div");return"draggable"in a||"dragDrop"in a}();ob?lc=function(a,b){return 36==
a.charCodeAt(b-1)&&39==a.charCodeAt(b)}:Gc&&!/Version\/([6-9]|\d\d)\b/.test(navigator.userAgent)?lc=function(a,b){return/\-[^ \-?]|\?[^ !\'\"\),.\-\/:;\?\]\}]/.test(a.slice(b-1,b+1))}:ka&&!/Chrome\/(?:29|[3-9]\d|\d\d\d)\./.test(navigator.userAgent)&&(lc=function(a,b){if(1<b&&45==a.charCodeAt(b-1)){if(/\w/.test(a.charAt(b-2))&&/[^\-?\.]/.test(a.charAt(b)))return!0;if(2<b&&/[\d\.,]/.test(a.charAt(b-2))&&/[\d\.,]/.test(a.charAt(b)))return!1}return/[~!#%&*)=+}\]|\"\.>,:;][({[<]|-[^\-?\.\u2010-\u201f\u2026]|\?[\w~`@#$%\^&*(_=+{[|><]|\u2026[\w~`@#$%\^&*(_=+{[><]/.test(a.slice(b-
1,b+1))});var Eb,Xc,Va=3!="\n\nb".split(/\n/).length?function(a){for(var b=0,c=[],d=a.length;b<=d;){var f=a.indexOf("\n",b);-1==f&&(f=a.length);var h=a.slice(b,"\r"==a.charAt(f-1)?f-1:f),k=h.indexOf("\r");-1!=k?(c.push(h.slice(0,k)),b+=k+1):(c.push(h),b=f+1)}return c}:function(a){return a.split(/\r\n?|\n/)};a.splitLines=Va;var de=window.getSelection?function(a){try{return a.selectionStart!=a.selectionEnd}catch(b){return!1}}:function(a){try{var b=a.ownerDocument.selection.createRange()}catch(c){}return b&&
b.parentElement()==a?0!=b.compareEndPoints("StartToEnd",b):!1},hd=function(){var a=K("div");if("oncopy"in a)return!0;a.setAttribute("oncopy","return;");return"function"==typeof a.oncopy}(),Ya={3:"Enter",8:"Backspace",9:"Tab",13:"Enter",16:"Shift",17:"Ctrl",18:"Alt",19:"Pause",20:"CapsLock",27:"Esc",32:"Space",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"Left",38:"Up",39:"Right",40:"Down",44:"PrintScrn",45:"Insert",46:"Delete",59:";",91:"Mod",92:"Mod",93:"Mod",109:"-",107:"=",127:"Delete",186:";",
187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'",63276:"PageUp",63277:"PageDown",63275:"End",63273:"Home",63234:"Left",63232:"Up",63235:"Right",63233:"Down",63302:"Insert",63272:"Delete"};a.keyNames=Ya;(function(){for(var a=0;10>a;a++)Ya[a+48]=String(a);for(a=65;90>=a;a++)Ya[a]=String.fromCharCode(a);for(a=1;12>=a;a++)Ya[a+111]=Ya[a+63235]="F"+a})();var ib,re=function(){function a(d){return 255>=d?b.charAt(d):1424<=d&&1524>=d?"R":1536<=d&&1791>=d?c.charAt(d-1536):1792<=
d&&2220>=d?"r":"L"}var b="bbbbbbbbbtstwsbbbbbbbbbbbbbbssstwNN%%%NNNNNN,N,N1111111111NNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNNNLLLLLLLLLLLLLLLLLLLLLLLLLLNNNNbbbbbbsbbbbbbbbbbbbbbbbbbbbbbbbbb,N%%%%NNNNLNNNNN%%11NLNNN1LNNNNNLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLNLLLLLLLL",c="rrrrrrrrrrrr,rNNmmmmmmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmrrrrrrrnnnnnnnnnn%nnrrrmrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrrmmmmmmmmmmmmmmmmmmmNmmmmrrrrrrrrrrrrrrrrrr",
d=/[\u0590-\u05f4\u0600-\u06ff\u0700-\u08ac]/,f=/[stwN]/,h=/[LRr]/,k=/[Lb1n]/,l=/[1n]/;return function(b){if(!d.test(b))return!1;for(var c=b.length,e=[],m=0,p;m<c;++m)e.push(a(b.charCodeAt(m)));for(var m=0,q="L";m<c;++m)p=e[m],"m"==p?e[m]=q:q=p;m=0;for(q="L";m<c;++m)p=e[m],"1"==p&&"r"==q?e[m]="n":h.test(p)&&(q=p,"r"==p&&(e[m]="R"));m=1;for(q=e[0];m<c-1;++m)p=e[m],"+"==p&&"1"==q&&"1"==e[m+1]?e[m]="1":","!=p||q!=e[m+1]||"1"!=q&&"n"!=q||(e[m]=q),q=p;for(m=0;m<c;++m)if(p=e[m],","==p)e[m]="N";else if("%"==
p){for(q=m+1;q<c&&"%"==e[q];++q);var r=m&&"!"==e[m-1]||q<c-1&&"1"==e[q]?"1":"N";for(p=m;p<q;++p)e[p]=r;m=q-1}m=0;for(q="L";m<c;++m)p=e[m],"L"==q&&"1"==p?e[m]="L":h.test(p)&&(q=p);for(m=0;m<c;++m)if(f.test(e[m])){for(q=m+1;q<c&&f.test(e[q]);++q);p="L"==(q<c-1?e[q]:"L");r="L"==(m?e[m-1]:"L")||p?"L":"R";for(p=m;p<q;++p)e[p]=r;m=q-1}for(var q=[],s,m=0;m<c;)if(k.test(e[m])){p=m;for(++m;m<c&&k.test(e[m]);++m);q.push({from:p,to:m,level:0})}else{var t=m,r=q.length;for(++m;m<c&&"L"!=e[m];++m);for(p=t;p<m;)if(l.test(e[p])){t<
p&&q.splice(r,0,{from:t,to:p,level:1});t=p;for(++p;p<m&&l.test(e[p]);++p);q.splice(r,0,{from:t,to:p,level:2});t=p}else++p;t<m&&q.splice(r,0,{from:t,to:m,level:1})}1==q[0].level&&(s=b.match(/^\s+/))&&(q[0].from=s[0].length,q.unshift({from:0,to:s[0].length,level:0}));1==qa(q).level&&(s=b.match(/\s+$/))&&(qa(q).to-=s[0].length,q.push({from:c-s[0].length,to:c,level:0}));q[0].level!=qa(q).level&&q.push({from:c,to:c,level:q[0].level});return q}}();a.version="3.16.0";return a}();(function(){function a(a){"activeLine"in a.state&&(a.removeLineClass(a.state.activeLine,"wrap",c),a.removeLineClass(a.state.activeLine,"background",f))}function b(b){var h=b.getLineHandleVisualStart(b.getCursor().line);b.state.activeLine!=h&&(a(b),b.addLineClass(h,"wrap",c),b.addLineClass(h,"background",f),b.state.activeLine=h)}var c="CodeMirror-activeline",f="CodeMirror-activeline-background";window.CodeMirror.defineOption("styleActiveLine",!1,function(c,f,m){m=m&&m!=CodeMirror.Init;f&&!m?(b(c),
c.on("cursorActivity",b)):!f&&m&&(c.off("cursorActivity",b),a(c),delete c.state.activeLine)})})();colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",
grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",
darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",
lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#31A2F2",lightblue:"#B2DCEF",darkblue:"#005784",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",
orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",
lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",
purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},amstrad:{black:"#000000",white:"#ffffff",
grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"}};
var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|#(?:[0-9a-f]{3}){1,2})\s*/;function setPixel(a,b,c,f,d,h,m){index=4*(b+c*a.width);a.data[index+0]=f;a.data[index+1]=d;a.data[index+2]=h;a.data[index+3]=m}function createSprite(a,b,c){b.clearRect(0,0,cellwidth,cellheight);c=font[c];var f=~~(cellwidth/5),d=~~(cellheight/5);b.fillStyle="#ffffff";for(var h=0;5>h;h++)for(var m=0;5>m;m++){var l=~~(h*f),p=~~(m*d);1==c[h][m]&&b.fillRect(p,l,f,d)}a=a.toDataURL();b=document.createElement("img");b.onload=redraw;b.src=a;return b}
function regenText(a,b){textImages={};for(var c in font)font.hasOwnProperty(c)&&(textImages[c]=createSprite(a,b,c))}var spriteimages;
function regenSpriteImages(){var a=document.createElement("canvas");a.width=cellwidth;a.height=cellheight;var b=a.getContext("2d"),c=~~(cellwidth/5),f=~~(cellheight/5);if(textMode)regenText(a,b);else{spriteimages=[];for(var d=0;d<sprites.length;d++)if(void 0!=sprites[d]){b.clearRect(0,0,cellwidth,cellheight);for(var h=sprites[d].dat,m=sprites[d].colors,l=0;5>l;l++)for(var p=0;5>p;p++){var t=h[l][p];if(0<=t){var r=l*c|0,v=p*f|0;b.fillStyle=m[t];b.fillRect(v,r,c,f)}}h=a.toDataURL();m=document.createElement("img");
m.onload=redraw;m.src=h;spriteimages[d]=m}}}var canvas,ctx,x,y,cellwidth,cellheight,xoffset,yoffset;window.console.log("init");window.addEventListener("resize",canvasResize,!1);canvas=document.getElementById("gameCanvas");ctx=canvas.getContext("2d");y=x=0;
function redraw(){if(textMode){for(var a in textImages)if(textImages.hasOwnProperty(a)){var b=textImages[a];if(!b.complete)return}ctx.fillStyle="#000000";ctx.fillRect(0,0,canvas.width,canvas.height);for(a=0;a<titleWidth;a++)for(var c=0;c<titleHeight;c++)if(b=titleImage[c].charAt(a),b in textImages){var f=textImages[b];ctx.drawImage(f,xoffset+a*cellwidth,yoffset+c*cellheight)}}else{void 0===spriteimages&&regenSpriteImages();for(a=0;a<spriteimages.length;a++)if(b=spriteimages[a],void 0!=b&&!b.complete)return;
ctx.fillStyle="#000000";ctx.fillRect(0,0,canvas.width,canvas.height);var b=0,d=screenwidth,h=0,m=screenheight;flickscreen?(a=getPlayerPositions(),0<a.length&&(a=a[0],b=a/level.height|0,a=a%level.height|0,a=a/screenheight|0,b=(b/screenwidth|0)*screenwidth,h=a*screenheight,d=Math.min(b+screenwidth,level.width),m=Math.min(h+screenheight,level.height))):zoomscreen&&(a=getPlayerPositions(),0<a.length&&(a=a[0],b=a/level.height|0,a=a%level.height|0,b=Math.max(b-(screenwidth/2|0),0),h=Math.max(a-(screenheight/
2|0),0),d=Math.min(b+screenwidth,level.width),m=Math.min(h+screenheight,level.height)));for(a=b;a<d;a++)for(c=h;c<m;c++)for(var l=level.dat[c+a*level.height],p=0;p<state.objectCount;p++)0!=(l&1<<p)&&(f=spriteimages[p],ctx.drawImage(f,xoffset+(a-b)*cellwidth,yoffset+(c-h)*cellheight))}}var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,forceRegenImages=!1;
function canvasResize(){canvas.style.width=canvas.parentNode.clientWidth;canvas.style.height=canvas.parentNode.clientHeight;canvas.width=canvas.parentNode.clientWidth;canvas.height=canvas.parentNode.clientHeight;screenwidth=level.width;screenheight=level.height;if(void 0!==state){if(flickscreen=void 0!==state.metadata.flickscreen)screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1];if(zoomscreen=void 0!==state.metadata.zoomscreen)screenwidth=state.metadata.zoomscreen[0],
screenheight=state.metadata.zoomscreen[1]}textMode&&(screenwidth=titleWidth,screenheight=titleHeight);cellwidth=canvas.width/screenwidth;cellheight=canvas.height/screenheight;var a=5,b=5;textMode&&(b=a=6);cellwidth=a*~~(cellwidth/a);cellheight=b*~~(cellheight/b);yoffset=xoffset=0;cellwidth>cellheight?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):cellheight>cellwidth&&(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/
2,xoffset=(canvas.width-cellwidth*screenwidth)/2);cellwidth=~~cellwidth;cellheight=~~cellheight;xoffset=~~xoffset;yoffset=~~yoffset;if(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||forceRegenImages)forceRegenImages=!1,regenSpriteImages();oldcellheight=cellheight;oldcellwidth=cellwidth;oldtextmode=textMode;redraw()};var keybuffer=[];function onMouseDown(a){lastDownTarget=a.target;keybuffer={}}function onKeyDown(a){a=a||window.event;lastDownTarget==canvas&&void 0===keybuffer[a.keyCode]&&(keybuffer[a.keyCode]=0,checkKey(a));!0===canDump&&(74===a.keyCode&&(a.ctrlKey||a.metaKey)?dumpTestCase():75===a.keyCode&&(a.ctrlKey||a.metaKey)&&makeGIF())}function onKeyUp(a){a=a||window.event;delete keybuffer[a.keyCode]}document.addEventListener("mousedown",onMouseDown,!1);document.addEventListener("keydown",onKeyDown,!1);
document.addEventListener("keyup",onKeyUp,!1);function prevent(a){a.preventDefault&&a.preventDefault();a.stopImmediatePropagation&&a.stopImmediatePropagation();a.stopPropagation&&a.stopPropagation();return a.returnValue=!1}var messageselected=!1;
function checkKey(a){if(!winning){var b=-1;switch(a.keyCode){case 65:case 37:window.console.log("LEFT");b=1;break;case 38:case 87:window.console.log("UP");b=0;break;case 68:case 39:window.console.log("RIGHT");b=3;break;case 83:case 40:window.console.log("DOWN");b=2;break;case 13:case 32:case 67:case 88:window.console.log("ACTION");b=4;break;case 85:case 90:if(!1==textMode)return!0===canDump&&inputHistory.push("undo"),DoUndo(),prevent(a);case 82:if(!1==textMode)return!0===canDump&&inputHistory.push("restart"),
DoRestart(),prevent(a);case 27:if(!1==titleScreen)return goToTitleScreen(),tryPlayTitleSound(),canvasResize(),prevent(a)}if(textMode){if(0!==state.levels.length)if(titleScreen)if(0==titleMode)4==b&&!1==titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize());else if(4==b)!1==titleSelected&&(tryPlayStartGameSound(),titleSelected=!0,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw());else{if(0===b||2===b)titleSelection=
1-titleSelection,generateTitleScreen(),redraw()}else 4==b&&(unitTesting?nextLevel():!1==messageselected&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen()))}else if(0<=b)return!0===canDump&&inputHistory.push(b),processInput(b),prevent(a)}}
function update(){timer+=deltatime;quittingTitleScreen&&0.3<timer/1E3&&(quittingTitleScreen=!1,nextLevel());quittingMessageScreen&&0.15<timer/1E3&&(quittingMessageScreen=!1,""===messagetext?nextLevel():(messagetext="",titleScreen=textMode=!1,titleMode=0<curlevel?1:0,titleSelected=!1,titleSelection=0,canvasResize()));winning&&0.3<timer/1E3&&(winning=!1,nextLevel());for(var a in keybuffer)keybuffer[a]+=deltatime,keybuffer[a]>repeatinterval&&(keybuffer[a]=0,checkKey({keyCode:parseInt(a)}));0<autotickinterval&&
(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,autoTickGame()))}setInterval(function(){update()},deltatime);var get_blob=function(){return self.Blob},standalone_HTML_String="",client=new XMLHttpRequest;client.open("GET","standalone_inlined.txt");client.onreadystatechange=function(){4==client.readyState&&(standalone_HTML_String=client.responseText)};client.send();
function buildStandalone(a){if(0==standalone_HTML_String.length)consolePrint("Can't export yet - still downloading html template.");else{var b=standalone_HTML_String,c="PuzzleScript Game";void 0!==state.metadata.title&&(c=state.metadata.title.toUpperCase());var f="www.puzzlescript.net";void 0!==state.metadata.homepage&&(f=state.metadata.homepage.toLowerCase());b=b.replace(/\"__GAMETITLE__\"/g,c);b=b.replace(/\"__HOMEPAGE__\"/g,f);b=b.replace(/\"__GAMEDAT__\"/g,a);a=new (get_blob())([b],{type:"text/plain;charset=utf-8"});
saveAs(a,c+".html")}};intro_template="..................................;..................................;..................................;......Puzzle Script Terminal......;..............v 0.1...............;..................................;..................................;..................................;.........insert cartridge.........;..................................;..................................;..................................;..................................".split(";");
messagecontainer_template="..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..................................;..........X to continue...........;..................................;..................................".split(";");
titletemplate_firstgo="..................................;..................................;..................................;..................................;..................................;..................................;..........#.start game.#..........;..................................;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
titletemplate_select0="..................................;..................................;..................................;..................................;..................................;...........#.new game.#...........;..................................;.............continue.............;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
titletemplate_select1="..................................;..................................;..................................;..................................;..................................;.............new game.............;..................................;...........#.continue.#...........;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
titletemplate_firstgo_selected="..................................;..................................;..................................;..................................;..................................;..................................;###########.start game.###########;..................................;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
titletemplate_select0_selected="..................................;..................................;..................................;..................................;..................................;############.new game.############;..................................;.............continue.............;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
titletemplate_select1_selected="..................................;..................................;..................................;..................................;..................................;.............new game.............;..................................;############.continue.############;..................................;.arrow keys to move...............;.X to action......................;.Z to undo, R to restart..........;..................................".split(";");
var titleImage=[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1;
function generateTitleScreen(){titleMode=0<curlevel?1:0;if(0==state.levels.length)titleImage=intro_template;else{var a="PuzzleScript Game";void 0!==state.metadata.title&&(a=state.metadata.title.toUpperCase());continueText="continue";leftnote1="arrow keys to move";titleImage=0==titleMode?titleSelected?deepClone(titletemplate_firstgo_selected):deepClone(titletemplate_firstgo):0==titleSelection?titleSelected?deepClone(titletemplate_select0_selected):deepClone(titletemplate_select0):titleSelected?deepClone(titletemplate_select1_selected):
deepClone(titletemplate_select1);var b="noundo"in state.metadata,c="norestart"in state.metadata;b&&c?titleImage[11]="..................................":b?titleImage[11]=".R to restart.....................":c&&(titleImage[11]=".Z to undo.....................");for(b=0;b<titleImage.length;b++)titleImage[b]=titleImage[b].replace(/\./g," ");var b=titleImage[0].length,f=(b-a.length)/2|0,c=titleImage[1];titleImage[1]=c.slice(0,f)+a+c.slice(f+a.length);c=titleImage[3];void 0!==state.metadata.author&&(a=
"by "+state.metadata.author,titleImage[3]=c.slice(0,b-a.length-1)+a+c[c.length-1])}}var state={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[]};
function deepClone(a){if(!a)return a;var b;[Number,String,Boolean].forEach(function(c){a instanceof c&&(b=c(a))});if("undefined"==typeof b)if("[object Array]"===Object.prototype.toString.call(a))b=[],a.forEach(function(a,c,h){b[c]=deepClone(a)});else if("object"==typeof a)if(a.nodeType&&"function"==typeof a.cloneNode)b=a.cloneNode(!0);else if(a.prototype)b=a;else if(a instanceof Date)b=new Date(a);else{b={};for(var c in a)b[c]=deepClone(a[c])}else b=a;return b}
function drawMessageScreen(){titleMode=0;textMode=!0;titleImage=deepClone(messagecontainer_template);for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");var b=titleImage[0].length;""===messagetext?a=state.levels[curlevel].message.trim():(a=messagetext,canvasResize());var b=(b-a.length)/2|0,c=titleImage[5];titleImage[5]=c.slice(0,b)+a+c.slice(b+a.length);quittingMessageScreen&&(titleImage[10]=titleImage[9])}
function loadLevelFromState(a,b){forceRegenImages=!0;titleScreen=!1;titleMode=0<curlevel?1:0;titleSelected=!1;titleSelection=0;curlevel=b;var c=a.levels[b];if(null===c)consolePrint("Trying to access a level that doesn't exist.");else if(void 0===c.message){titleMode=0;textMode=!1;level={width:c.w,height:c.h,layerCount:c.layerCount,dat:c.dat.concat([]),movementMask:c.dat.concat([]),rigidMovementAppliedMask:c.dat.concat([]),rigidGroupIndexMask:c.dat.concat([]),commandQueue:[]};for(c=0;c<level.movementMask.length;c++)level.movementMask[c]=
0,level.rigidMovementAppliedMask[c]=0,level.rigidGroupIndexMask[c]=0;"run_rules_on_level_start"in a.metadata&&processInput(-1);backups=[];restartTarget=backupLevel();tryPlayStartLevelSound()}else tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function autoTickGame(){processInput(-1)}var sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];generateTitleScreen();
canvasResize();function tick(){redraw()}function mouseMove(a){x=a.clientX;y=a.clientY;redraw()}function mouseOut(){}function tryPlaySimpleSound(a){void 0!==state.sfx_Events[a]&&playSeed(state.sfx_Events[a])}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}
function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}var backups=[],restartTarget;function backupLevel(){return deepClone(level)}
function setGameState(a,b){void 0===b&&(b=["restart"]);0==state.levels.length&&0<b.length&&"rebuild"===b[0]&&(b=["restart"]);state=a;window.console.log("setting game state :D ");backups=[];sprites=[];for(var c in state.objects)if(state.objects.hasOwnProperty(c)){var f=state.objects[c];sprites[f.id]={colors:f.colors,dat:f.spritematrix}}void 0!==state.metadata.realtime_interval?(autotick=0,autotickinterval=1E3*state.metadata.realtime_interval):autotickinterval=autotick=0;repeatinterval=void 0!==state.metadata.key_repeat_interval?
1E3*state.metadata.key_repeat_interval:150;switch(b[0]){case "restart":winning=!1;timer=0;titleScreen=!0;tryPlayTitleSound();textMode=!0;titleSelection=0;messageselected=quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;0<curlevel&&(titleMode=1);generateTitleScreen();break;case "loadLevel":c=b[1];curlevel=d;winning=!1;timer=0;textMode=titleScreen=!1;titleSelection=0;messageselected=quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;loadLevelFromState(state,
c);break;case "levelline":c=b[1];for(var d=state.levels.length-1;0<=d;d--)if(state.levels[d].lineNumber<=c+1){curlevel=d;winning=!1;timer=0;textMode=titleScreen=!1;titleSelection=0;messageselected=quittingTitleScreen=quittingMessageScreen=titleSelected=!1;titleMode=0;loadLevelFromState(state,d);break}}canvasResize()}var messagetext="";
function restoreLevel(a){level=deepClone(a);for(a=0;a<level.movementMask.length;a++)level.movementMask[a]=0,level.rigidGroupIndexMask[a]=0,level.rigidMovementAppliedMask[a]=0;messagetext="";level.commandQueue=[];redraw()}var zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0;function DoRestart(){"norestart"in state.metadata||(backups.push(backupLevel()),restoreLevel(restartTarget),tryPlayRestartSound())}
function DoUndo(){!("noundo"in state.metadata)&&0<backups.length&&(restoreLevel(backups[backups.length-1]),backups=backups.splice(0,backups.length-1),tryPlayUndoSound())}function getPlayerPositions(){var a=[],b=state.playerMask;for(i=0;i<level.dat.length;i++)0!=(b&level.dat[i])&&a.push(i);return a}function getLayersOfMask(a){for(var b=[],c=0;c<state.objectCount;c++)0!=(a&1<<c)&&b.push(state.objects[state.idDict[c]].layer);return b}
function getLayerMask(a){for(var b=0,c=0;c<state.objectCount;c++)0!=(a&1<<c)&&(b|=31<<5*state.objects[state.idDict[c]].layer);return b}function moveEntitiesAtIndex(a,b,c){b=getLayersOfMask(b&level.dat[a]);for(var f=level.movementMask[a],d=0;d<b.length;d++)f|=c<<5*b[d];level.movementMask[a]=f}function startMovement(a){for(var b=getPlayerPositions(),c=0;c<b.length;c++)moveEntitiesAtIndex(b[c],state.playerMask,a);return b}
var dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},seedsToPlay=[];
function repositionEntitiesOnLayer(a,b,c){c=dirMasksDelta[c];var f=c[0],d=c[1],h=a/level.height|0,m=a%level.height|0,l=level.width-1,p=level.height-1;if(0===h&&0>f||h===l&&0<f||0===m&&0>d||m===p&&0<d)return!1;c=(a+c[1]+c[0]*level.height)%level.dat.length;b=state.layerMasks[b];f=level.dat[c];if(0!=(f&b)){for(b=0;b<state.sfx_MovementFailureMasks.length;b++)c=state.sfx_MovementFailureMasks[b],f=c.objectMask,f&0!==t&&(f=level.movementMask[a],d=c.directionMask,0!==(f&d)&&-1===seedsToPlay.indexOf(c.seed)&&
seedsToPlay.push(c.seed));return!1}var t=level.dat[a];level.dat[a]=t&~b;level.dat[c]=f|t&b;for(b=0;b<state.sfx_MovementMasks.length;b++)c=state.sfx_MovementMasks[b],f=c.objectMask,0!==(f&t)&&(f=level.movementMask[a],d=c.directionMask,0!==(f&d)&&seedsToPlay.push(c.seed));return!0}var dirMask_random=[1,2,4,8];function randomDir(){return dirMask_random[Math.floor(Math.random()*dirMask_random.length)]}
function repositionEntiteisAtCell(a){for(var b=level.movementMask[a],c=!1,f=0;5>f;f++){var d=31&b>>5*f;0!=d&&(5==d&&(d=randomDir()),c=repositionEntitiesOnLayer(a,f,d)||c)}c&&(level.movementMask[a]=0);return c}function ruleMovementMaskAgrees(a,b){return 0===a?!0:0!==(a&b)}var ellipsisDirection=-2147483648,randomEntityMask=5;
function cellRowMatchesWildCard_ParticularK(a,b,c,f){a=dirMasksDelta[a];var d=level.movementMask[c],h=level.dat[c],m=[];if(checkThing(b[1],b[0],b[2],b[4],d,h))for(var l=c,p=6;p<b.length;p+=6){var l=(l+a[1]+a[0]*level.height)%level.dat.length,d=level.movementMask[l],t=b[p+0],h=level.dat[l],r=b[p+1],v=b[p+2],w=b[p+4];if(t===ellipsisDirection){l=(l+a[1]*f+a[0]*f*level.height+level.dat.length)%level.dat.length;for(p+=6;p<b.length;p+=6){d=level.movementMask[l];h=level.dat[l];t=b[p+0];r=b[p+1];v=b[p+2];
w=b[p+4];if(!checkThing(r,t,v,w,d,h))break;l=(l+a[1]+a[0]*level.height)%level.dat.length}p>=b.length&&m.push([c,f]);break}if(!checkThing(r,t,v,w,d,h))break}return 0<m.length}
function cellRowMatchesWildCard(a,b,c,f){a=dirMasksDelta[a];var d=level.movementMask[c],h=level.dat[c],m=[];if(checkThing(b[1],b[0],b[2],b[4],d,h))for(var l=c,p=6;p<b.length;p+=6){var l=(l+a[1]+a[0]*level.height)%level.dat.length,d=level.movementMask[l],t=b[p+0],h=level.dat[l],r=b[p+1],v=b[p+2],w=b[p+4];if(t===ellipsisDirection){for(var C=0;C<f;C++){for(var A=l,A=(A+a[1]*C+a[0]*C*level.height+level.dat.length)%level.dat.length,s=p+6;s<b.length;s+=6){d=level.movementMask[A];h=level.dat[A];t=b[s+0];
r=b[s+1];v=b[s+2];w=b[s+4];if(!checkThing(r,t,v,w,d,h))break;A=(A+a[1]+a[0]*level.height)%level.dat.length}s>=b.length&&m.push([c,C])}break}if(!checkThing(r,t,v,w,d,h))break}return m}function checkThing(a,b,c,f,d,h){return(a&h)==a&&0==(c&h)&&ruleMovementMaskAgrees(b,d)&&0==(f&d)}
function cellRowMatches(a,b,c,f){a=dirMasksDelta[a];var d=level.movementMask[c],h=level.dat[c];if(checkThing(b[1],b[0],b[2],b[4],d,h)){for(var m=6;m<b.length;m+=6){c=(c+a[1]+a[0]*level.height)%level.dat.length;var d=level.movementMask[c],l=b[m+0];l===ellipsisDirection&&(c=(c+a[1]*f+a[0]*f*level.height)%level.dat.length);h=level.dat[c];if(!checkThing(b[m+1],l,b[m+2],b[m+4],d,h))break}if(m>=b.length)return!0}return!1}
function matchCellRow(a,b){var c=[],f=0,d=level.width,h=0,m=level.height,l=b.length/6|0;switch(a){case 1:h+=l-1;break;case 2:m-=l-1;break;case 4:f+=l-1;break;case 8:d-=l-1;break;default:window.console.log("EEEP "+a)}for(;f<d;f++)for(l=h;l<m;l++){var p=f*level.height+l;cellRowMatches(a,b,p)&&c.push(p)}return c}
function matchCellRowWildCard(a,b){var c=[],f=0,d=level.width,h=0,m=level.height,l=(b.length/6|0)-1;switch(a){case 1:h+=l-1;break;case 2:m-=l-1;break;case 4:f+=l-1;break;case 8:d-=l-1;break;default:window.console.log("EEEP2 "+a)}for(;f<d;f++)for(l=h;l<m;l++){var p=f*level.height+l,t;switch(a){case 1:t=l;break;case 2:t=m-l;break;case 4:t=f;break;case 8:t=d-f;break;default:window.console.log("EEEP2 "+a)}c=c.concat(cellRowMatchesWildCard(a,b,p,t))}return c}
function generateTuples(a){for(var b=[[]],c=0;c<a.length;c++){for(var f=a[c],d=[],h=0;h<f.length;h++)for(var m=f[h],l=0;l<b.length;l++){var p=b[l].concat([m]);d.push(p)}b=d}return b}propagationState={ruleGroupIndex:0,levelDat:[],levelMovementMask:[],rigidGroupIndexMask:[],rigidMovementAppliedMask:[]};var rigidBackups=[],bannedGroup=[];
function commitPreservationState(a){var b={ruleGroupIndex:a,dat:level.dat.concat([]),levelMovementMask:level.movementMask.concat([]),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:bannedGroup.concat([])};return rigidBackups[a]=b}
function restorePreservationState(a){level.dat=a.dat.concat([]);level.movementMask=a.levelMovementMask.concat([]);level.rigidGroupIndexMask=a.rigidGroupIndexMask.concat([]);level.rigidMovementAppliedMask=a.rigidMovementAppliedMask.concat([]);sfxDestroyMask=sfxCreateMask=0}
function tryApplyRule(a,b,c){b=!1;c=dirMasksDelta[a[0]];for(var f=[],d=0;d<a[1].length;d++){var h=a[1][d],h=a[5][d]?matchCellRowWildCard(a[0],h):matchCellRow(a[0],h);if(0==h.length)return!1;f.push(h)}if(!1==a[9])for(var h=generateTuples(f),m=0;m<h.length;m++){var l=h[m];if(0<m){f=!0;for(d=0;d<a[1].length;d++)if(a[5][d]){if(!1==cellRowMatchesWildCard_ParticularK(a[0],a[1][d],l[d][0],l[d][1])){f=!1;break}}else if(!1==cellRowMatches(a[0],a[1][d],l[d])){f=!1;break}if(!1==f)continue}for(d=0;d<a[1].length;d++)for(var p=
a[1][d],t=a[2][d],r=a[5][d]?l[d][0]:l[d],v=0;v<p.length;v+=6){var w=p[v+0];if(w===ellipsisDirection)var C=l[d][1],r=(r+c[1]*C+c[0]*C*level.height)%level.dat.length;else{var A=p[v+1],s=p[v+3],k=t[v+0],u=t[v+1],D=t[v+2],C=t[v+3],q=t[v+4],z=t[v+5];if(0!==z){for(var G=[],V=0;32>V;V++)0!==(z&1<<V)&&G.push(V);z=G[Math.floor(Math.random()*G.length)];G=state.objects[state.idDict[z]];V=31<<5*G.layer;u|=1<<z;D|=state.layerMasks[G.layer];q|=V}var z=level.dat[r],G=level.movementMask[r],V=z,O=G,z=z&~A,G=G&~w,
z=z&~D,G=G&~s;0!==k&&(G&=~C);z|=u;G&=~q;G|=k;w=!1;s=A=0;a[7]&&(A=state.groupNumber_to_RigidGroupIndex[a[6]],A++,k=A+(A<<5)+(A<<10)+(A<<15)+(A<<20)+(A<<25),k&=C,A=level.rigidGroupIndexMask[r],s=level.rigidMovementAppliedMask[r],u=A,D=s,A|=k,s|=C,u!==A||D!==s)&&(w=!0);if(V!==z||O!=G||w)b=!0,w&&(level.rigidGroupIndexMask[r]=A,level.rigidMovementAppliedMask[r]=s),C=V&~z,sfxCreateMask|=z&~V,sfxDestroyMask|=C,level.dat[r]=z,level.movementMask[r]=G;r=(r+c[1]+c[0]*level.height)%level.dat.length}}}0<f.length&&
queueCommands(a);return b}function queueCommands(a){a=a[8];for(var b=0;b<a.length;b++){var c=a[b];0<=level.commandQueue.indexOf(c[0])||(level.commandQueue.push(c[0]),"message"===c[0]&&(messagetext=c[1]))}}function showTempMessage(){textMode=!0;messageselected=quittingMessageScreen=titleScreen=!1;tryPlayShowMessageSound();drawMessageScreen();canvasResize()}
function propagateMovements(a){for(var b=0<a;a<state.rules.length;){if(!bannedGroup[a])for(var c=state.rules[a],f=!0,d=0;f;){d++;if(50<d){window.console.log("got caught looping in a rule group :O");break}for(var f=!1,h=0;h<c.length;h++)f=tryApplyRule(c[h])||f;b=f||b}a++;b&&void 0!==state.loopPoint[a]&&(a=state.loopPoint[a],b=!1)}}function propagateLateMovements(){for(var a=0;a<state.lateRules.length;a++)for(var b=state.lateRules[a],c=!0;c;)for(var c=!1,f=0;f<b.length;f++)c=tryApplyRule(b[f])||c}
function resolveMovements(a){for(var b=!0;b;)for(b=!1,a=0;a<level.dat.length;a++){var c=level.movementMask[a];0!=c&&(b=repositionEntiteisAtCell(a)||b)}b=!1;for(a=0;a<level.movementMask.length;a++){c=level.movementMask[a];if(0!==c&&(c&=level.rigidMovementAppliedMask[a],0!==c))for(var f=0;6>f;f++)if(0!==(31&c>>5*f)){b=31&level.rigidGroupIndexMask[a]>>5*f;b--;b=bannedGroup[state.rigidGroupIndex_to_GroupIndex[b]]=!0;break}level.movementMask[a]=0;level.rigidGroupIndexMask[a]=0;level.rigidMovementAppliedMask[a]=
0}return b}var sfxCreateMask=0,sfxDestroyMask=0;
function processInput(a){bak=backupLevel();var b=[];if(4>=a){if(0<=a){switch(a){case 0:a=1;break;case 1:a=4;break;case 2:a=2;break;case 3:a=8;break;case 4:a=16}b=startMovement(a)}a=0;var c=!0;bannedGroup=[];rigidBackups=[];level.commandQueue=[];var f=0,d=!1,h=commitPreservationState();messagetext="";sfxDestroyMask=sfxCreateMask=0;for(seedsToPlay=[];c||d||anyMovements()&&50>a;)d=c=!1,a++,propagateMovements(f),resolveMovements()?(d=!0,restorePreservationState(h)):propagateLateMovements(),f=0;50<=a&&
window.console.log("looped through 50 times, gave up.  too many loops!");for(a=0;a<seedsToPlay.length;a++)playSeed(seedsToPlay[a]);for(a=0;a<state.sfx_CreationMasks.length;a++)c=state.sfx_CreationMasks[a],0!==(sfxCreateMask&c.objectMask)&&playSeed(c.seed);for(a=0;a<state.sfx_DestructionMasks.length;a++)c=state.sfx_DestructionMasks[a],0!==(sfxDestroyMask&c.objectMask)&&playSeed(c.seed);for(a=0;a<level.movementMask.length;a++)level.movementMask[a]=0,level.rigidGroupIndexMask[a]=0,level.rigidMovementAppliedMask[a]=
0;if(0<=level.commandQueue.indexOf("cancel")){restorePreservationState(h);redraw();return}if(0<b.length&&void 0!==state.metadata.require_player_movement){h=!1;for(a=0;a<b.length;a++)if(0===(level.dat[b[a]]&state.playerMask)){h=!0;break}if(!1===h){backups.push(bak);DoUndo();return}}for(a=0;a<level.dat.length;a++)if(level.dat[a]!=bak.dat[a]){backups.push(bak);break}for(a=0;a<level.commandQueue.length;a++)b=level.commandQueue[a],"f"===b.charAt(1)&&tryPlaySimpleSound(b),!1==unitTesting&&"message"===b&&
showTempMessage();0<=level.commandQueue.indexOf("restart")&&DoRestart();0<=level.commandQueue.indexOf("checkpoint")&&(restartTarget=backupLevel());checkWin();level.commandQueue=[]}redraw()}
function checkWin(){var a=state.wincondition;if(0!=a.length){var b=a[1],c=a[2],f=!1;switch(a[0]){case -1:f=!0;for(a=0;a<level.dat.length;a++){var d=level.dat[a];if(0!==(b&d)&&0!==(c&d)){f=!1;break}}break;case 0:f=!1;for(a=0;a<level.dat.length;a++)if(d=level.dat[a],0!==(c&d)&&0!==(b&d)){f=!0;break}break;case 1:for(f=!0,a=0;a<level.dat.length;a++)if(d=level.dat[a],0!==(b&d)&&0===(c&d)){f=!1;break}}0<=level.commandQueue.indexOf("win")&&(f=!0);f&&DoWin()}}
function DoWin(){winning||(tryPlayEndLevelSound(),unitTesting?nextLevel():(winning=!0,timer=0))}function anyMovements(){for(var a=0;a<level.movementMask.length;a++)if(0!=level.movementMask[a])return!0;return!1}function saveProgress(){}function restoreProgress(){}
function nextLevel(){messagetext="";titleScreen?(0==titleSelection&&(curlevel=0,saveProgress()),loadLevelFromState(state,curlevel)):curlevel<state.levels.length-1?(curlevel++,messageselected=quittingMessageScreen=titleScreen=textMode=!1,saveProgress(),loadLevelFromState(state,curlevel)):(curlevel=0,saveProgress(),goToTitleScreen(),tryPlayEndGameSound());localStorage.curlevel=curlevel;canvasResize()}
function goToTitleScreen(){messagetext="";textMode=titleScreen=!0;titleSelection=0;generateTitleScreen()};var compiling=!1,errorStrings=[],errorCount=0;function logError(a,b){if(compiling){if(void 0===b)return logErrorNoLine(a);var c='<a onclick="jumpToLine('+b.toString()+');"  href="javascript:void(0);"><span class="errorTextLineNumber"> line '+b.toString()+'</span></a> : <span class="errorText">'+a+"</span>";0<=errorStrings.indexOf(c)||(consolePrint(c),errorStrings.push(c),errorCount++)}}
function logErrorNoLine(a){compiling&&(a='<span class="errorText">'+a+"</span>",0<=errorStrings.indexOf(a)||(consolePrint(a),errorStrings.push(a)),errorCount++)}function blankLineHandle(a){"levels"===a.section&&0<a.levels[a.levels.length-1].length&&a.levels.push([])}
var codeMirrorFn=function(){var a="objects legend sounds collisionlayers rules wincondition levels".split(" "),b="sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10 cancel checkpoint restart win message".split(" "),c=/[\w]+\s*/,f=/\d+\b/,d=/[\.0-9]{5}\s*/,h=/(objects|collisionlayers|legend|sounds|rules|wincondition|levels)\s*/,m=/[\=]+/,l=/[^\(]+/,p=/[ \,]*/,t=/(move|action|create|destroy|cantmove|undo|restart|titlescreen|startgame|endgame|startlevel|endlevel|showmessage|closemessage|sfx0|sfx1|sfx2|sfx3|sfx4|sfx5|sfx6|sfx7|sfx8|sfx9|sfx10)\s+/,
r=/^(up|down|left|right|\^|v|\<|\>|forward|moving|stationary|parallel|perpendicular|horizontal|vertical|no|randomdir|random)$/,v=/^(up|down|left|right|horizontal|vertical|orthogonal|late|rigid)$/,w=/\s*(up|down|left|right|horizontal|vertical|orthogonal)\s*/,C=/^(all|any|no|some)$/,A="objects collisionlayers legend sounds rules ... wincondition levels up down left right late rigid ^ v > < no randomdir random horizontal vertical any all no some moving stationary parallel perpendicular".split(" ");return{blankLine:function(a){"levels"===
a.section&&0<a.levels[a.levels.length-1].length&&a.levels.push([])},token:function(s,k){var u=s.string,D=s.sol();D&&(s.string=s.string.toLowerCase());s.eatWhile(/[ \t]/);var q=s.peek();if("("===q)s.next(),k.commentLevel++;else if(")"===q&&(s.next(),0<k.commentLevel&&(k.commentLevel--,0===k.commentLevel)))return"comment";if(0<k.commentLevel){for(;;){s.eatWhile(/[^\(\)]+/);if(s.eol())break;q=s.peek();"("===q?k.commentLevel++:")"===q&&k.commentLevel--;s.next();if(0===k.commentLevel)break}return"comment"}s.eatWhile(/[ \t]/);
if(D&&s.eol())return blankLineHandle(k);if(D&&s.match(m,!0))return"EQUALSBIT";if(s.match(h,!0)){k.section=s.string.slice(0,s.pos).trim();0<=k.visitedSections.indexOf(k.section)&&logError('cannot duplicate sections (you tried to duplicate "'+k.section.toUpperCase()+'").',k.lineNumber);k.visitedSections.push(k.section);q=a.indexOf(k.section);0==q?(k.objects_section=0,1<k.visitedSections.length&&logError('section "'+k.section.toUpperCase()+'" must be the first section',k.lineNumber)):-1==k.visitedSections.indexOf(a[q-
1])&&logError('section "'+k.section.toUpperCase()+'" is out of order, must follow  "'+a[q-1].toUpperCase()+'".',k.lineNumber);if("sounds"===k.section){for(var z in k.objects)k.objects.hasOwnProperty(z)&&k.names.push(z);for(u=0;u<k.legend_synonyms.length;u++)k.names.push(k.legend_synonyms[u][0]);for(u=0;u<k.legend_aggregates.length;u++)k.names.push(k.legend_aggregates[u][0]);for(u=0;u<k.legend_properties.length;u++)k.names.push(k.legend_properties[u][0])}else if("levels"===k.section){for(z in k.objects)k.objects.hasOwnProperty(z)&&
1==z.length&&k.abbrevNames.push(z);for(u=0;u<k.legend_synonyms.length;u++)1==k.legend_synonyms[u][0].length&&k.abbrevNames.push(k.legend_synonyms[u][0]);for(u=0;u<k.legend_aggregates.length;u++)1==k.legend_aggregates[u][0].length&&k.abbrevNames.push(k.legend_aggregates[u][0])}return"HEADER"}void 0===k.section&&logError('must start with section "OBJECTS"',k.lineNumber);if(s.eol())return null;switch(k.section){case "objects":D&&-1==k.objects_section&&(k.objects_section=1);q=function(){var a=D?s.match(c,
!0):s.match(/[^\s\()]+\s*/,!0);if(null==a)return s.match(l,!0),"ERROR";a=a[0].trim();if(void 0!==k.objects[a])return logError('Object "'+a.toUpperCase()+'" defined multiple times.',k.lineNumber),"ERROR";for(var b=0;b<k.legend_synonyms.length;b++)k.legend_synonyms[b][0]==a&&logError('Name "'+a.toUpperCase()+'" already in use.',k.lineNumber);a in A&&logError('You named an object "'+a.toUpperCase()+"\", but this is a keyword. Don't do that!",k.lineNumber);D?(k.objects_candname=a,k.objects[k.objects_candname]=
{lineNumber:k.lineNumber,colors:[],spritematrix:[]}):k.legend_synonyms.push([a,k.objects_candname]);k.objects_section=-1;return"NAME"};if(!D)if(2===k.objects_section){k.tokenIndex++;z=s.match(reg_color,!0);if(0===k.tokenIndex&&null===z)return 0===k.tokenIndex?logError("Was looking for secondary color for object "+k.objects_candname.toUpperCase()+".",k.lineNumber):logError('Was looking for sprite pixels definition (5 characters side, each one either "." or "0" ) on this line, but finding other crap instead, namely '+
k.objects_candname.toUpperCase()+".",k.lineNumber),s.match(l,!0),null;if(null===z)logError("Was looking for color definition  on this line, but finding other crap instead, namely "+k.objects_candname.toUpperCase()+".",k.lineNumber);else return k.objects[k.objects_candname].colors.push(z[0].trim()),k.objects_section=2,k.objects_spritematrix=[],q=z[0].trim().toLowerCase(),q in colorPalettes.arnecolors?q.toUpperCase():"COLOR"}else if(1!==k.objects_section){if(-1===k.objects_section)return q();logError('Only expecting two things on this line, a foreground colour and a background colour (something like "Red Blue", though you can leave out the background colour if you like, in which case the sprite will be transparent), but found some other stuff :S',
k.lineNumber);s.match(l,!0);return"ERROR"}switch(k.objects_section){case 0:return q();case 1:k.tokenIndex=0;z=s.match(reg_color,!0);if(null==z)return logError("Was looking for color for object "+k.objects_candname.toUpperCase()+".",k.lineNumber),s.match(l,!0),null;void 0===k.objects[k.objects_candname].colors?k.objects[k.objects_candname].colors=[z[0].trim()]:k.objects[k.objects_candname].colors.push(z[0].trim());k.objects_section=2;k.objects_spritematrix=[];q=z[0].trim().toLowerCase();return q in
colorPalettes.arnecolors?q.toUpperCase():"COLOR";case 2:z=s.match(d);if(null==z){if(0===k.objects_spritematrix.length)return q();logError("Incomplete sprite matrix for object "+k.objects_candname.toUpperCase()+".",k.lineNumber);s.match(l,!0);return null}for(var G=z[0],V=k.objects[k.objects_candname],u=0;u<G.length;u++)if(q=G.charAt(u),"."!==q&&(z=parseInt(q),z>=V.colors.length))return logError("trying to access color number "+z+" from the color palette of sprite "+k.objects_candname.toUpperCase()+
", but there are only "+V.colors.length+" defined in it.",k.lineNumber),"ERROR";k.objects_spritematrix.push(G);5===k.objects_spritematrix.length&&(V.spritematrix=k.objects_spritematrix,k.objects_section=0);return"SPRITEMATRIX";default:window.console.logError("EEK shouldn't get here.")}break;case "sounds":if(D){var O=!0,q=l.exec(s.string)[0].split(/\s/).filter(function(a){return""!==a});q.push(k.lineNumber);k.sounds.push(q)}N=s.match(t,!0);if(null!==N)return"SOUNDVERB";N=s.match(w,!0);if(null!==N)return"DIRECTION";
N=s.match(f,!0);if(null!==N)return k.tokenIndex++,"SOUND";N=s.match(/[^\[\|\]\s]*/,!0);if(null!==N&&(q=N[0].trim(),0<=k.names.indexOf(q)))return"NAME";N=s.match(l,!0);logError('unexpected sound token "'+N+'".',k.lineNumber);s.match(l,!0);return"ERROR";case "collisionlayers":D&&k.collisionLayers.push([]);q=s.match(c,!0);if(null===q)return s.match(p,!0),null;var N=q[0].trim(),U=function(a){a=a.toLowerCase();if(a in k.objects)return[a];for(var b=0;b<k.legend_aggregates.length;b++){var c=k.legend_aggregates[b];
if(c[0]===a)return logError('"'+a+'" is an aggregate (defined using "and"), and cannot be added to a single layer because its constituent objects must be able to coexist.',k.lineNumber),[]}for(b=0;b<k.legend_properties.length;b++)if(c=k.legend_properties[b],c[0]===a)return[].concat.apply([],c.slice(1).map(U));logError('Cannot add "'+N.toUpperCase()+'" to a collision layer; it has not been declared.',k.lineNumber);return[]},q=U(N);k.collisionLayers[k.collisionLayers.length-1]=k.collisionLayers[k.collisionLayers.length-
1].concat(q);6<k.collisionLayers.length&&logError("Cannot have more than 6 layers.  You probably don't need that many, you know...",k.lineNumber);return 0<q.length?"NAME":"ERROR";case "legend":if(D){q=s.string.replace("="," = ");q=l.exec(q)[0];q=q.split(/\s/).filter(function(a){return""!==a});O=!0;if(3>q.length)O=!1;else if("="!==q[1])O=!1;else{if("v"==q[0].charAt(q[0].length-1))return logError('names cannot end with the letter "v", because it\'s is used as a direction.',k.lineNumber),s.match(l,!0),
"ERROR";if(3===q.length)k.legend_synonyms.push([q[0],q[2].toLowerCase()]);else if(0===q.length%2)O=!1;else if(z=q[3].toLowerCase(),"and"===z){U=function(a){a=a.toLowerCase();if(a in k.objects)return[a];for(var b=0;b<k.legend_synonyms.length;b++){var c=k.legend_synonyms[b];if(c[0]===a)return[1]}for(b=0;b<k.legend_aggregates.length;b++)if(c=k.legend_aggregates[b],c[0]===a)return[].concat.apply([],c.slice(1).map(U));for(b=0;b<k.legend_properties.length;b++)if(c=k.legend_properties[b],c[0]===a){logError("Cannot define an aggregate (using 'and') in terms of properties (something that uses 'or').",
k.lineNumber);O=!1;break}return[a]};for(u=5;u<q.length;u+=2)if("and"!==q[u].toLowerCase()){O=!1;break}if(O){z=[q[0]].concat(U(q[2])).concat(U(q[4]));for(u=6;u<q.length;u+=2)z=z.concat(U(q[u]));z.lineNumber=k.lineNumber;k.legend_aggregates.push(z)}}else if("or"===z){U=function(a){a=a.toLowerCase();if(a in k.objects)return[a];for(var b=0;b<k.legend_synonyms.length;b++){var c=k.legend_synonyms[b];if(c[0]===a)return[1]}for(b=0;b<k.legend_aggregates.length;b++)c=k.legend_aggregates[b],c[0]===a&&(logError("Cannot define a property (using 'or') in terms of aggregates (something that uses 'and').",
k.lineNumber),O=!1);for(b=0;b<k.legend_properties.length;b++)if(c=k.legend_properties[b],c[0]===a)return[].concat.apply([],c.slice(1).map(U));return[a]};for(u=5;u<q.length;u+=2)if("or"!==q[u].toLowerCase()){O=!1;break}if(O){z=[q[0],q[2].toLowerCase(),q[4].toLowerCase()];for(u=6;u<q.length;u+=2)z.push(q[u].toLowerCase());z.lineNumber=k.lineNumber;k.legend_properties.push(z)}}else O=!1}if(!1===O)return logError("incorrect format of legend - should be one of A = B, A = B or C ( or D ...), A = B and C (and D ...)",
k.lineNumber),s.match(l,!0),"ERROR";k.tokenIndex=0}if(0===k.tokenIndex)return s.match(/[^=]*/,!0),k.tokenIndex++,"NAME";if(1===k.tokenIndex)return s.next(),s.match(/\s*/,!0),k.tokenIndex++,"ASSSIGNMENT";q=s.match(c,!0);if(null===q)return logError("Something bad's happening in the LEGEND",k.lineNumber),s.match(l,!0),"ERROR";N=q[0].trim();if(0===k.tokenIndex%2){if(!1===function(a){a=a.toLowerCase();if(a in k.objects)return!0;for(var b=0;b<k.legend_aggregates.length;b++){var c=k.legend_aggregates[b];
if(c[0]===a)return!0}for(b=0;b<k.legend_properties.length;b++)if(c=k.legend_properties[b],c[0]===a)return!0;return!1}(N))return logError('Cannot reference "'+N.toUpperCase()+'" in the LEGEND section; it has not been defined yet.',k.lineNumber),k.tokenIndex++,"ERROR";k.tokenIndex++;return"NAME"}k.tokenIndex++;return"LOGICWORD";case "rules":D&&(z=l.exec(s.string)[0],k.rules.push([z,k.lineNumber]),k.tokenIndex=0);if(-4===k.tokenIndex)return s.skipToEnd(),"MESSAGE";if(s.match(/\s*\-\>\s*/,!0))return"ARROW";
if("["===q||"|"===q||"]"===q||"+"===q)return k.tokenIndex=1,s.next(),s.match(/\s*/,!0),"BRACKET";q=s.match(/[^\[\|\]\s]*/,!0)[0].trim();if(0===k.tokenIndex&&v.exec(q)||1===k.tokenIndex&&r.exec(q))return s.match(/\s*/,!0),"DIRECTION";if(0<=k.names.indexOf(q)){if(D)return logError("Identifiers cannot appear outside of square brackes in rules, only directions can.",k.lineNumber),"ERROR";s.match(/\s*/,!0);return"NAME"}if("..."===q||"rigid"===q)return"DIRECTION";if(0<=b.indexOf(q))return"message"===q&&
(k.tokenIndex=-4),"COMMAND";logError('Name "'+q+'", referred to in a rule, does not exist.',k.lineNumber);return"ERROR";case "wincondition":D&&(q=l.exec(s.string)[0].split(/\s/).filter(function(a){return""!==a}),q.push(k.lineNumber),0<k.wincondition.length&&logError("There can only be one win condition",k.lineNumber),k.wincondition=q,k.tokenIndex=-1);k.tokenIndex++;q=s.match(/\s*\w+\s*/);if(null===q)return logError("incorrect format of win condition.",k.lineNumber),s.match(l,!0),"ERROR";q=q[0].trim();
if(0===k.tokenIndex)return C.exec(q)?"LOGICWORD":"ERROR";if(2===k.tokenIndex)return"on"!=q?"ERROR":"LOGICWORD";if(1===k.tokenIndex||3===k.tokenIndex)return-1===k.names.indexOf(q)?(logError('Error in win condition: "'+q.toUpperCase()+'" is not a valid object name.',k.lineNumber),"ERROR"):"NAME";break;case "levels":if(D){if(s.match(/\s*message\s*/,!0))return k.tokenIndex=1,q=["\n",u.slice(s.pos).trim()],0==k.levels[k.levels.length-1].length?k.levels.splice(k.levels.length-1,0,q):k.levels.push(q),"MESSAGE_VERB";
q=s.match(l,!1)[0].trim();k.tokenIndex=2;z=k.levels[k.levels.length-1];"\n"==z[0]?k.levels.push([k.lineNumber,q]):(0==z.length&&z.push(k.lineNumber),z.push(q))}else if(1==k.tokenIndex)return s.skipToEnd(),"MESSAGE";if(2===k.tokenIndex&&!s.eol()){q=s.peek();s.next();if(0<=k.abbrevNames.indexOf(q))return"LEVEL";logError('Key "'+q.toUpperCase()+'" not found. Do you need to add it to the legend, or define a new object?',k.lineNumber);return"ERROR"}break;default:if(D&&(k.tokenIndex=0),0==k.tokenIndex){if(q=
s.match(/\s*\w+\s*/),null!==q){q=q[0].trim();if(D)if(0<="title author homepage key_repeat_interval realtime_interval flickscreen zoomscreen color_palette".split(" ").indexOf(q))z=s.match(l,!1),null!=z?(k.metadata.push(q),k.metadata.push(z[0].trim())):logError('MetaData "'+q+'" needs a value.',k.lineNumber),k.tokenIndex=1;else if(0<=["run_rules_on_level_start","require_player_movement","debug","noundo","norestart"].indexOf(q))k.metadata.push(q),k.metadata.push("true"),k.tokenIndex=-1;else return logError("Unrecognised stuff in metadata section.",
k.lineNumber),"ERROR";else if(-1==k.tokenIndex)return logError('MetaData "'+q+'" has no parameters.',k.lineNumber),"ERROR";return"METADATA"}}else return s.match(l,!0),"METADATATEXT"}if(s.eol())return null;if(!s.eol())return s.next(),null},startState:function(){return{objects:{},lineNumber:0,commentLevel:0,section:"",visitedSections:[],objects_candname:"",objects_section:0,objects_spritematrix:[],collisionLayers:[],tokenIndex:0,legend_synonyms:[],legend_aggregates:[],legend_properties:[],sounds:[],
rules:[],names:[],wincondition:[],metadata:[],abbrevNames:[],levels:[[]],subsection:""}}}};window.CodeMirror.defineMode("puzzle",codeMirrorFn);var code=document.getElementById("code"),editor=window.CodeMirror.fromTextArea(code,{lineWrapping:!0,lineNumbers:!0,styleActiveLine:!0});editor.on("mousedown",function(a,b){if("cm-SOUND"==b.target.className){var c=parseInt(b.target.innerHTML);playSound(c)}else"cm-LEVEL"==b.target.className&&(b.ctrlKey||b.metaKey)&&compile(["levelline",a.posFromMouse(b).line])});var mapObj={parallel:"&#8741;",perpendicular:"&#8869;"};code.editorreference=editor;editor.setOption("theme","midnight");
function getParameterByName(a){a=a.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");a=RegExp("[\\?&]"+a+"=([^&#]*)").exec(location.search);return null==a?"":decodeURIComponent(a[1].replace(/\+/g," "))}var fileToOpen=getParameterByName("demo");null!==fileToOpen&&0<fileToOpen.length&&(client=new XMLHttpRequest,client.open("GET","demo/"+fileToOpen+".txt"),client.onreadystatechange=function(){4==client.readyState&&editor.setValue(client.responseText)},client.send());function isColor(a){a=a.trim();if(a in colorPalettes.arnecolors||/(^#[0-9A-F]{6}$)|(^#[0-9A-F]{3}$)/i.test(a))return!0}function colorToHex(a,b){b=b.trim();return b in a?a[b]:b}function generateSpriteMatrix(a){for(var b=[],c=0;c<a.length;c++){for(var f=[],d=0;d<a.length;d++){var h=a[c].charAt(d);"."==h?f.push(-1):f.push(h)}b.push(f)}return b}var debugMode;
function generateExtraMembers(a){a.idDict={};for(var b=0,c=0;c<a.collisionLayers.length;c++)for(var f=0;f<a.collisionLayers[c].length;f++){var d=a.collisionLayers[c][f];if(d in a.objects){var h=a.objects[d];h.layer=c;h.id=b;a.idDict[b]=d;b++}}a.objectCount=b;32<a.objectCount&&logError("Cannot have more than 31 objects defined, you have "+a.objects.length,a.objects[0].lineNumber);h=a.collisionLayers.length;c=[];for(b=0;b<h;b++)c.push(-1);debugMode=!1;f=colorPalettes.arnecolors;for(b=0;b<a.metadata.length;b+=
2){var h=a.metadata[b],m=a.metadata[b+1];"color_palette"===h?void 0===colorPalettes[m]?logError('palette "'+m+'" not found, defaulting to arnecolors.',0):f=colorPalettes[m]:"debug"===h&&(debugMode=!0)}for(d in a.objects)if(a.objects.hasOwnProperty(d))for(h=a.objects[d],10<h.colors.length&&logError("a sprite cannot have more than 10 colors.  Why you would want more than 10 is beyond me.",h.lineNumber+1),b=0;b<h.colors.length;b++){var l=h.colors[b],l=colorToHex(f,l);h.colors[b]=l;!1==isColor(l)&&logError('Invalid color specified for object "'+
d+'", namely "'+h.colors[b]+'".',h.lineNumber+1)}for(d in a.objects)a.objects.hasOwnProperty(d)&&(h=a.objects[d],0==h.colors.length&&(debug.logError('color not specified for object "'+d+'".',h.lineNumber),h.colors=["#ff00ff"]),h.spritematrix=0===h.spritematrix.length?[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]]:generateSpriteMatrix(h.spritematrix));l={};for(d in a.objects)if(a.objects.hasOwnProperty(d)){var h=a.objects[d],p=c.concat([]);p[h.layer]=h.id;l[d]=p}for(d=!0;d;){d=!1;for(b=
0;b<a.legend_synonyms.length;b++)m=a.legend_synonyms[b],h=m[0],m=m[1],h in l&&void 0!==l[h]||void 0===l[m]||(d=!0,l[h]=l[m]);for(b=0;b<a.legend_aggregates.length;b++){for(var m=a.legend_aggregates[b],h=m[0],p=m.slice(1),t=!0,f=0;f<p.length;f++)if(void 0===l[p[f]]){t=!1;break}if(!(h in l&&void 0!==l[h])&&t){p=c.concat([]);for(f=1;f<m.length;f++)d=m[f],h=a.objects[d],void 0==h&&logError("Object not found with name "+d,a.lineNumber),-1==p[h.layer]?p[h.layer]=h.id:logError('Trying to create an aggregate object (defined in the legend) with both) "'+
d.toUpperCase()+'" and "'+a.idDict[p[h.layer]].toUpperCase()+"\", which are on the same layer and therefore can't coexist.",m.lineNumber);d=!0;l[m[0]]=p}}}a.glyphDict=l;c={};for(b=0;b<a.legend_aggregates.length;b++)l=a.legend_aggregates[b],c[l[0]]=l.slice(1);a.aggregatesDict=c;d={};for(b=0;b<a.legend_properties.length;b++)l=a.legend_properties[b],d[l[0]]=l.slice(1);a.propertiesDict=d;f={};for(b=0;b<a.legend_synonyms.length;b++)l=a.legend_synonyms[b],h=l[0],l=l[1],l in c?c[h]=c[l]:l in d?d[h]=d[l]:
f[h]=l;a.synonymsDict=f;void 0===a.objects.background?"background"in a.synonymsDict?(d=a.synonymsDict.background,h=a.objects[d],b=h.id,h=h.layer):"background"in a.propertiesDict?(d=a.propertiesDict.background[0],h=a.objects[d],b=h.id,h=h.layer):"background"in a.aggregatesDict?(h=a.idDict[0],b=h.id,h=h.layer,logError("background cannot be an aggregate (declared with 'and'), it has to be a simple type, or property (declared in terms of others using 'or').")):(h=a.idDict[0],b=h.id,h=h.layer,logError("you have to define something to be the background")):
(b=a.objects.background.id,h=a.objects.background.layer);a.backgroundid=b;a.backgroundlayer=h}function calcLevelBackgroundMask(a,b){for(var c=a.layerMasks[a.backgroundlayer],f=0;f<b.length;f++){var d=b[f]&c;if(0!==d)return d}return 1<<a.backgroundid}
function levelsToArray(a){for(var b=a.levels,c=[],f=a.layerMasks[a.backgroundlayer],d=0;d<b.length;d++){var h=b[d];if(0!=h.length){if("\n"==h[0])var m={message:h[1]};else{for(var l=[],m={lineNumber:h[0],w:h[1].length,h:h.length-1,layerCount:a.collisionLayers.length},p=0;p<m.w;p++)for(var t=0;t<m.h;t++){var r=h[t+1].charAt(p);0==r.length&&(r=h[t+1].charAt(h[t+1].length-1));var v=0,w=a.glyphDict[r];void 0==w&&(void 0===a.propertiesDict[r]?logError('Error, symbol "'+r+'", used in map, not found.',a.lineNumber):
logError('Error, symbol "'+r+"\" is defined using 'or', and therefore ambiguous - it cannot be used in a map. Did you mean to define it in terms of 'and'?",a.lineNumber));w=w.concat([]);for(r=0;r<m.layerCount;r++)0<=w[r]&&(v|=1<<w[r]);l.push(v)}m.dat=l;h=calcLevelBackgroundMask(a,m.dat);for(p=0;p<m.dat.length;p++)l=m.dat[p],0===(l&f)&&(m.dat[p]=l|h)}c.push(m)}}a.levels=c}
var directionaggregates={horizontal:["left","right"],vertical:["up","down"],moving:["up","down","left","right"],perpendicular:["^","v"],parallel:["<",">"]},simpleAbsoluteDirections=["up","down","left","right"],simpleRelativeDirections=["^","v","<",">"],reg_directions_only=/^(\>|\<|\^|v|up|down|left|right|moving|stationary|no|randomdir|random|horizontal|vertical|perpendicular|parallel)$/,commandwords="sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10 cancel checkpoint restart win message".split(" ");
function processRuleString(a,b,c,f){a=a.replace(/\[/g," [ ").replace(/\]/g," ] ").replace(/\|/g," | ").replace(/\-\>/g," -> ");a=a.split(/\s/).filter(function(a){return""!==a});0==a.length&&logError("Spooky error!  Empty line passed to rule function.",c);var d=0,h=[],m=null,l=[],p=!1,t=[],r=[],v=!1,w=!1,C=c,A=[];if(2===a.length){if("["===a[0]&&"["===a[1])return b={bracket:1};if("]"===a[0]&&"]"===a[1])return b={bracket:-1}}-1==a.indexOf("->")&&logError("A rule has to have an arrow in it.  There's no arrow here! Consider reading up about rules - you're clearly doing something weird",
c);for(var s=0;s<a.length;s++){var k=a[s];switch(d){case 0:"+"===k?C===c?(0!==s&&logError('The "+" symbol, for joining a rule with the group of the previous rule, must be the first symbol on the line '),C=f[f.length-1].groupNumber):logError('Two "+"s ("append to previous rule group" symbol)applied to the same rule.',c):k in directionaggregates?h=h.concat(directionaggregates[k]):"late"===k?v=!0:"rigid"===k?w=!0:0<=simpleAbsoluteDirections.indexOf(k)?h.push(k):0<=simpleRelativeDirections.indexOf(k)?
logError('You cannot use relative directions ("^v<>") to indicate in which direction(s) a rule applies.  Use absolute directions indicators (Up, Down, Left, Right, Horizontal, or Vertical, for instance), or, if you want the rule to apply in all four directions, do not specify directions',c):"["==k?(0==h.length&&(h=h.concat(directionaggregates.moving)),d=1,s--):logError("The start of a rule must consist of some number of directions (possibly 0), before the first bracket, specifying in what directions to look (with no direction specified, it applies in all four directions).  It seems you've just entered \""+
k.toUpperCase()+'".',c);break;case 1:"["==k?(0<l.length&&logError('Error, malformed cell rule - encountered a "["" before previous bracket was closed',c),m=[]):reg_directions_only.exec(k)?1==m.length%2?logError("Error, an item can't move in multiple directions.",c):m.push(k):"|"==k?1==m.length%2?logError("In a rule, if you specify a force, it has to act on an object.",c):(l.push(m),m=[]):"]"===k?(1==m.length%2?"..."===m[0]?logError("Cannot end a rule with ellipses.",c):logError("In a rule, if you specify a force, it has to act on an object.",
c):(l.push(m),m=[]),p?r.push(l):t.push(l),l=[]):"->"===k?(p&&logError('Error, you can only use "->" once in a rule; it\'s used to separate before and after states.',c),0<l.length?logError('Encountered an unexpected "->" inside square brackets.  It\'s used to separate states, it has no place inside them >:| .',c):p=!0):0<=b.names.indexOf(k)?0==m.length%2?(m.push(""),m.push(k)):1==m.length%2&&m.push(k):"..."===k?(m.push(k),m.push(k)):0<=commandwords.indexOf(k)?(!1===p&&logError("Commands cannot appear on the left-hand side of the arrow.",
c),"message"===k?(s=a.slice(s+1).join(" "),A.push([k,s]),s=a.length):A.push([k])):logError('Error, malformed cell rule - was looking for cell contents, but found "'+k+'".  What am I supposed to do with this, eh, please tell me that.',c)}}if(t.length!=r.length)0<A.length&&0==r.length||logError("Error, when specifying a rule, the number of matches (square bracketed bits) on the left hand side of the arrow must equal the number on the right",c);else for(s=0;s<t.length;s++)t[s].length!=r[s].length&&logError("In a rule, each pattern to match on the left must have a corresponding pattern on the right of equal length (number of cells).",
c),0==t[s].length&&logError("You have an totally empty pattern on the left-hand side.  This will match *everything*.  You certianly don't want this.");0==t.length&&logError("This rule refers to nothing.  What the heck? :O",c);return b={directions:h,lhs:t,rhs:r,lineNumber:c,late:v,rigid:w,groupNumber:C,commands:A}}function deepCloneHS(a){return a.map(function(a){return a.map(function(a){return a.slice()})})}
function deepCloneRule(a){return{direction:a.direction,lhs:deepCloneHS(a.lhs),rhs:deepCloneHS(a.rhs),lineNumber:a.lineNumber,late:a.late,rigid:a.rigid,groupNumber:a.groupNumber,commands:a.commands}}
function rulesToArray(a){for(var b=a.rules,c=[],f=[],d=0;d<b.length;d++){var h=b[d][1],m=processRuleString(b[d][0],a,h,c);void 0!==m.bracket?f.push([h,m.bracket]):c.push(m)}a.loops=f;f=[];for(d=0;d<c.length;d++)for(b=c[d],h=b.directions,m=0;m<h.length;m++){var l=h[m];if(l in directionaggregates)for(var l=directionaggregates[l],p=0;p<l.length;p++){var t={direction:l[p],lhs:deepCloneHS(b.lhs),rhs:deepCloneHS(b.rhs),lineNumber:b.lineNumber,late:b.late,rigid:b.rigid,groupNumber:b.groupNumber,commands:b.commands};
f.push(t)}else t={direction:l,lhs:deepCloneHS(b.lhs),rhs:deepCloneHS(b.rhs),lineNumber:b.lineNumber,late:b.late,rigid:b.rigid,groupNumber:b.groupNumber,commands:b.commands},f.push(t)}for(d=0;d<f.length;d++)convertRelativeDirsToAbsolute(f[d]);for(d=0;d<f.length;d++)atomizeAggregates(a,f[d]);for(d=0;d<f.length;d++)rephraseSynonyms(a,f[d]);c=[];for(d=0;d<f.length;d++)b=f[d],c=c.concat(concretizeMovingRule(a,b,b.lineNumber));f=[];for(d=0;d<c.length;d++)b=c[d],f=f.concat(concretizePropertyRule(a,b,b.lineNumber));
a.rules=f}function rewriteUpLeftRules(a){if("up"==a.direction)a.direction="down";else if("left"==a.direction)a.direction="right";else return;for(var b=0;b<a.lhs.length;b++)a.lhs[b].reverse(),a.rhs[b].reverse()}function getPropertiesFromCell(a,b){for(var c=[],f=0;f<b.length;f+=2){var d=b[f+1];"random"!=b[f]&&d in a.propertiesDict&&c.push(d)}return c}function getMovings(a,b){for(var c=[],f=0;f<b.length;f+=2){var d=b[f],h=b[f+1];d in directionaggregates&&c.push([h,d])}return c}
function concretizePropertyInCell(a,b,c){for(var f=0;f<a.length;f+=2)a[f+1]===b&&"random"!==a[f]&&(a[f+1]=c)}function concretizeMovingInCell(a,b,c,f){for(var d=0;d<a.length;d+=2)a[d]===b&&a[d+1]===c&&(a[d]=f)}function concretizeMovingInCellByAmbiguousMovementName(a,b,c){for(var f=0;f<a.length;f+=2)a[f]===b&&(a[f]=c)}
function expandNoPrefixedProperties(a,b){for(var c=[],f=0;f<b.length;f+=2){var d=b[f],h=b[f+1];if("no"===d&&h in a.propertiesDict)for(var h=a.propertiesDict[h],m=0;m<h.length;m++){var l=h[m];c.push(d);c.push(l)}else c.push(d),c.push(h)}return c}
function concretizePropertyRule(a,b,c){for(var f=!0;f;)for(var f=!1,d=0;d<b.lhs.length;d++)for(var h=b.lhs[d],m=b.lhs[d],l=0;l<h.length;l++)h[l]=expandNoPrefixedProperties(a,h[l]),m[l]=expandNoPrefixedProperties(a,m[l]);var p;b=[b];for(f=!0;f;)for(f=!1,d=0;d<b.length;d++){h=b[d];p=!1;for(l=0;l<h.lhs.length;l++)for(var t=h.lhs[l],m=0;m<t.length;m++){var r=t[m],r=getPropertiesFromCell(a,r);if(0<r.length)for(var f=p=!0,v=r[0],w=a.propertiesDict[v],C=0;C<w.length;C++){var r=w[C],A=deepCloneRule(h);A.propertyReplacement=
{};for(var s in h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(s)){var k=h.propertyReplacement[s];A.propertyReplacement[s]=[k[0],k[1]]}concretizePropertyInCell(A.lhs[l][m],v,r);concretizePropertyInCell(A.rhs[l][m],v,r);void 0===A.propertyReplacement[v]?A.propertyReplacement[v]=[r,1]:A.propertyReplacement[v][1]+=1;b.push(A)}}p&&(b.splice(d,1),d--)}for(d=0;d<b.length;d++)if(h=b[d],void 0!==h.propertyReplacement)for(v in h.propertyReplacement)if(h.propertyReplacement.hasOwnProperty(v)&&
(l=h.propertyReplacement[v],r=l[0],1===l[1]))for(l=0;l<h.rhs.length;l++)for(f=h.rhs[l],m=0;m<f.length;m++)concretizePropertyInCell(f[m],v,r);v="";for(d=0;d<b.length;d++)for(h=b[d],delete b.propertyReplacement,l=0;l<h.rhs.length;l++)for(t=h.rhs[l],m=0;m<t.length;m++)r=t[m],r=getPropertiesFromCell(a,r),0<r.length&&(v=r[0]);0<v.length&&logError('This rule has a property on the right-hand side, "'+v+"\", that can't be inferred from the left-hand side.  (either for every property on the right there has to be a corresponding one on the left in the same cell, OR, if there's a single occurrence of a particular property name on the left, all properties of the same name on the right are assumed to be the same).",
c);return b}
function concretizeMovingRule(a,b,c){var f;b=[b];for(var d=!0;d;)for(var d=!1,h=0;h<b.length;h++){var m=b[h];f=!1;for(var l=0;l<m.lhs.length;l++)for(var p=m.lhs[l],t=0;t<p.length;t++){var r=p[t],r=getMovings(a,r);if(0<r.length)for(var d=f=!0,v=r[0][0],r=r[0][1],w=directionaggregates[r],C=0;C<w.length;C++){var A=w[C],s=deepCloneRule(m);s.movingReplacement={};for(var k in m.movingReplacement)if(m.movingReplacement.hasOwnProperty(k)){var u=m.movingReplacement[k];s.movingReplacement[k]=[u[0],u[1],u[3]]}concretizeMovingInCell(s.lhs[l][t],
r,v,A);concretizeMovingInCell(s.rhs[l][t],r,v,A);void 0===s.movingReplacement[v]?s.movingReplacement[v]=[A,1,r]:s.movingReplacement[v][1]+=1;b.push(s)}}f&&(b.splice(h,1),h--)}for(h=0;h<b.length;h++)if(m=b[h],void 0!==m.movingReplacement){p={};for(v in m.movingReplacement)if(m.movingReplacement.hasOwnProperty(v)){var D=m.movingReplacement[v];k=D[0];l=D[1];D=D[2];p[D]=D in p||1!==l?"INVALID":k;if(1===l)for(l=0;l<m.rhs.length;l++)for(f=m.rhs[l],t=0;t<f.length;t++)d=f[t],concretizeMovingInCell(d,D,v,
k)}for(D in p)if(p.hasOwnProperty(D)&&"INVALID"!==D)for(k=p[D],l=0;l<m.rhs.length;l++)for(f=m.rhs[l],t=0;t<f.length;t++)d=f[t],concretizeMovingInCellByAmbiguousMovementName(d,D,k)}v="";for(h=0;h<b.length;h++)for(m=b[h],delete b.movingReplacement,l=0;l<m.rhs.length;l++)for(p=m.rhs[l],t=0;t<p.length;t++)r=p[t],r=getMovings(a,r),0<r.length&&(v=r[0][1]);0<v.length&&logError('This rule has an ambiguous movement on the right-hand side, "'+v+"\", that can't be inferred from the left-hand side.  (either for every ambiguous movement associated to an entity on the right there has to be a corresponding one on the left attached to the same entity, OR, if there's a single occurrence of a particular ambiguous movement on the left, all properties of the same movement attached to the same object on the right are assumed to be the same (or something like that)).",
c);return b}function rephraseSynonyms(a,b){for(var c=0;c<b.lhs.length;c++)for(var f=b.lhs[c],d=b.rhs[c],h=0;h<f.length;h++){for(var m=f[h],l=1;l<m.length;l+=2){var p=m[l];p in a.synonymsDict&&(m[l]=a.synonymsDict[m[l]])}if(0<b.rhs.length)for(m=d[h],l=1;l<m.length;l+=2)p=m[l],p in a.synonymsDict&&(m[l]=a.synonymsDict[m[l]])}}
function atomizeAggregates(a,b){for(var c=0;c<b.lhs.length;c++)for(var f=b.lhs[c],d=0;d<f.length;d++){var h=f[d];atomizeCellAggregates(a,h)}for(c=0;c<b.rhs.length;c++)for(f=b.rhs[c],d=0;d<f.length;d++)h=f[d],atomizeCellAggregates(a,h)}function atomizeCellAggregates(a,b){for(var c=1;c<b.length;c+=2){var f=b[c];if(f in a.aggregatesDict)for(f=a.aggregatesDict[f],b[c]=f[0],c=1;c<f.length;c++)b.push(b[c-1]),b.push(f[c])}}
function convertRelativeDirsToAbsolute(a){for(var b=a.direction,c=0;c<a.lhs.length;c++)for(var f=a.lhs[c],d=0;d<f.length;d++){var h=f[d];absolutifyRuleCell(b,h)}for(c=0;c<a.rhs.length;c++)for(f=a.rhs[c],d=0;d<f.length;d++)h=f[d],absolutifyRuleCell(b,h)}var relativeDirs="^ v < > parallel perpendicular".split(" "),relativeDict={right:"up down left right horizontal vertical".split(" "),up:"left right down up vertical horizontal".split(" "),down:"right left up down vertical horizontal".split(" "),left:"down up right left horizontal vertical".split(" ")};
function absolutifyRuleCell(a,b){for(var c=0;c<b.length;c+=2){var f=relativeDirs.indexOf(b[c]);0<=f&&(b[c]=relativeDict[a][f])}}var dirMasks={up:1,down:2,left:4,right:8,moving:15,no:3,randomdir:5,random:18,action:16};
function rulesToMask(a){for(var b=a.collisionLayers.length,c=[],f=0;f<b;f++)c.push(-2),c.push(-2);for(f=0;f<a.rules.length;f++)for(var b=a.rules[f],d=0;d<b.lhs.length;d++)for(var h=b.lhs[d],m=b.rhs[d],l=0;l<h.length;l++){for(var p=h[l],t=c.concat([]),r=0,v=0,w=0,C=0,A=0,s=0;s<p.length;s+=2){var k=p[s];if("..."===k){r=v=ellipsisDirection;2!==p.length?logError("You can't have anything in with an ellipsis. Sorry.",b.lineNumber):(s=m[l],2===s.length&&"..."===s[0]||logError("An ellipsis on the left must be matched by one in the corresponding place on the right.",
b.lineNumber));break}else if("random"===k){logError("'random' cannot be matched on the left-hand side, it can only appear on the right",b.lineNumber);continue}var u=p[s+1],D=a.objects[u],q=D.layer,D=D.id,z=a.layerMasks[q];"no"===k?w|=1<<D:(z=t[2*q+1],-2<z&&(z=a.idDict[z],logError("Rule matches object types that can't overlap: \""+u.toUpperCase()+'" and "'+z.toUpperCase()+'".',b.lineNumber)),t[2*q+0]=k,t[2*q+1]=D,v|=1<<D,"stationary"===k?A|=31<<5*q:(k=dirMasks[k]<<5*q,r|=k,0!==k&&(C|=31<<5*q)))}h[l]=
[r,v,w,C,A];if(0!==b.rhs.length){for(var r=m[l],v=c.concat([]),G=t=p=A=C=w=0,s=0;s<r.length;s+=2){k=r[s];if("..."===k){w=C=ellipsisDirection;break}else if("random"===k){u=r[s+1];u in a.objectMasks?A|=a.objectMasks[u]:logError('You want to spawn a random "'+u.toUpperCase()+"\", but I don't know how to do that",b.lineNumber);break}u=r[s+1];D=a.objects[u];q=D.layer;D=D.id;"no"==k?p|=1<<D:(z=v[2*q+1],-2<z&&(z=a.idDict[z],logError("Rule matches object types that can't overlap: \""+u.toUpperCase()+'" and "'+
z.toUpperCase()+'".',b.lineNumber)),z=a.layerMasks[q],v[2*q+0]=k,v[2*q+1]=D,t|=31<<5*q,C|=1<<D,"stationary"===k?G|=31<<5*q:w|=dirMasks[k]<<5*q,p|=z)}m[l]=[w,C,p,t,G,A]}}}
function collapseRules(a){for(var b=0;b<a.rules.length;b++){for(var c=a.rules[b],f=[0,[],[],c.lineNumber,c.late],d=[],h=0;h<c.lhs.length;h++)d.push(!1);f[0]=dirMasks[c.direction];for(h=0;h<c.lhs.length;h++){for(var m=c.lhs[h],l=c.rhs[h],p=[],t=[],r=0;r<m.length;r++){var v=m[r];v[0]===ellipsisDirection&&(d[h]&&logError("You can't use two ellipses in a single cell match pattern.  If you really want to, please implement it yourself and send me a patch :) ",c.lineNumber),d[h]=!0);p[6*r]=v[0];p[6*r+1]=
v[1];p[6*r+2]=v[2];p[6*r+3]=v[3];p[6*r+4]=v[4];p[6*r+5]=0;0<c.rhs.length&&(v=l[r],t[6*r]=v[0],t[6*r+1]=v[1],t[6*r+2]=v[2],t[6*r+3]=v[3],t[6*r+4]=v[4],t[6*r+5]=v[5])}f[1][h]=p;f[2][h]=t}f.push(d);f.push(c.groupNumber);f.push(c.rigid);f.push(c.commands);f.push(0===c.rhs.length);a.rules[b]=f}}
function arrangeRulesByGroupNumber(a){for(var b={},c={},f=0;f<a.rules.length;f++){var d=a.rules[f],h=d[6],m=b;d[4]&&(m=c);void 0==m[h]&&(m[h]=[]);m[h].push(d)}f=[];for(h in b)b.hasOwnProperty(h)&&(d=b[h],f.push(d));b=[];for(h in c)c.hasOwnProperty(h)&&(d=c[h],b.push(d));a.rules=f;a.lateRules=b}
function generateRigidGroupList(a){for(var b=[],c=[],f=[],d=[],h=0;h<a.rules.length;h++){for(var m=a.rules[h],l=!1,p=0;p<m.length;p++)m[p][7]&&(l=!0);if(d[h]=l)m=m[0][6],l=b.length,c[h]=l,f[m]=l,b.push(h)}30<b.length&&logError("There can't be more than 30 rigid groups (rule groups containing rigid members).",rules[0][0][3]);a.rigidGroups=d;a.rigidGroupIndex_to_GroupIndex=b;a.groupNumber_to_RigidGroupIndex=f;a.groupIndex_to_RigidGroupIndex=c}
function getMaskFromName(a,b){var c=0;if(b in a.objects)var f=a.objects[b],c=c|1<<f.id;if(b in a.aggregatesDict)for(var d=a.aggregatesDict[b],h=0;h<objects.length;h++)f=d[h],f=a.objects[f],c|=1<<f.id;if(b in a.propertiesDict)for(d=a.propertiesDict[b],h=0;h<d.length;h++)f=d[h],f=a.objects[f],c|=1<<f.id;b in a.synonymsDict&&(f=a.synonymsDict[b],f=a.objects[f],c|=1<<f.id);0==c&&logErrorNoLine("error, didn't find any object called player, either in the objects section, or the legends section. there must be a player!");
return c}
function generatePlayerMask(a){a.playerMask=getMaskFromName(a,"player");for(var b=[],c=a.collisionLayers.length,f=0;f<c;f++){for(var d=0,h=0;h<a.objectCount;h++){var m=a.idDict[h],l=a.objects[m];l.layer==f&&(d|=1<<l.id)}b.push(d)}a.layerMasks=b;b=[];for(m in a.objects)a.objects.hasOwnProperty(m)&&(l=a.objects[m],b[m]=1<<l.id);for(l=0;l<a.legend_synonyms.length;l++)h=a.legend_synonyms[l],b[h[0]]=b[h[1]];for(l=0;l<a.legend_properties.length;l++){c=a.legend_properties[l];f=0;for(h=1;h<c.length;h++)m=c[h],
f|=b[m];b[c[0]]=f}a.objectMasks=b}function checkObjectsAreLayered(a){for(var b in a.objects)if(a.objects.hasOwnProperty(b)){for(var c=!1,f=0;f<a.collisionLayers.length;f++){for(var d=a.collisionLayers[f],h=0;h<d.length;h++)if(d[h]===b){c=!0;break}if(c)break}!1===c&&logError('Object "'+b+'" has been defined, but not assigned to a layer.',a.objects[b].lineNumber)}}
function twiddleMetaData(a){for(var b={},c=0;c<a.metadata.length;c+=2){var f=a.metadata[c+1];b[a.metadata[c]]=f}void 0!==b.flickscreen&&(f=b.flickscreen,c=f.split("x"),c=[parseInt(c[0]),parseInt(c[1])],b.flickscreen=c);void 0!==b.zoomscreen&&(f=b.zoomscreen,c=f.split("x"),c=[parseInt(c[0]),parseInt(c[1])],b.zoomscreen=c);a.metadata=b}
function processWinCondition(a){var b=a.wincondition;if(0!=b.length){var c=0;switch(b[0]){case "no":c=-1;break;case "all":c=1}var f=b[b.length-1],d=b[1],b=5==b.length?b[3]:"background",h=0,m=0;d in a.objectMasks?h=a.objectMasks[d]:logError('unwelcome term "'+d+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',f);b in a.objectMasks?m=a.objectMasks[b]:logError('unwelcome term "'+b+'" found in win condition. Win conditions objects have to be objects or properties (defined using "or", in terms of other properties)',
f);a.wincondition=[c,h,m,f]}}function printCellRow(a){for(var b="[ ",c=0;c<a.length;c++){0<c&&(b+="| ");for(var f=a[c],d=0;d<f.length;d+=2)var h=f[d],m=f[d+1],b="..."===h?b+(h+" "):b+(h+" "+m+" ")}return b+"] "}function printRule(a){var b="("+a.groupNumber+") "+a.direction.toString().toUpperCase()+" ";a.rigid&&(b="RIGID "+b+" ");a.late&&(b="LATE "+b+" ");for(var c=0;c<a.lhs.length;c++)var f=a.lhs[c],b=b+printCellRow(f);b+="-> ";for(c=0;c<a.rhs.length;c++)f=a.rhs[c],b+=printCellRow(f);return b}
function printRules(a){for(var b="Rule Assembly : ("+a.rules.length+" rules )<br>===========<br>",c=0;c<a.rules.length;c++)b+=printRule(a.rules[c])+"<br>";consolePrint(b+"===========")}
function generateLoopPoints(a){var b={},c=!0,f=0,d=0;1===a.loops.length%2&&logErrorNoLine("have to have matching number of  '[[' and ']]' loop points.");for(var h=0;h<a.loops.length;h++)for(var m=a.loops[h],f=0;f<a.rules.length-1;f++){var l=a.rules[f][0][3];if(c){if(l>=m[0]){d=f;c=!1;-1===m[1]&&logErrorNoLine("have to have matching number of  '[[' and ']]' loop points.");break}}else if(l>=m[0]){f-=1;b[f]=d;c=!0;-1===m[1]&&logErrorNoLine("have to have matching number of  '[[' and ']]' loop points.");
break}}!1===c&&(f=a.rules.length,b[f]=d);a.loopPoint=b}var soundEvents="titlescreen startgame endgame startlevel undo restart endlevel showmessage closemessage sfx0 sfx1 sfx2 sfx3 sfx4 sfx5 sfx6 sfx7 sfx8 sfx9 sfx10".split(" "),soundMaskedEvents=["create","destroy","move","cantmove","action"],soundVerbs=soundEvents.concat(soundMaskedEvents);function validSeed(a){return null!==/^\s*\d+\s*$/.exec(a)}
var soundDirectionIndicatorMasks={up:1,down:2,left:4,right:8,horizontal:12,vertical:3,orthogonal:15,___action____:16},soundDirectionIndicators="up down left right horizontal vertical orthogonal ___action____".split(" ");
function generateSoundData(a){for(var b={},c=[],f=[],d=[],h=[],m=0;m<a.sounds.length;m++){var l=a.sounds[m];if(!(1>=l.length)){var p=l[l.length-1];if(0<=soundEvents.indexOf(l[0])){4<l.length&&logError("too much stuff to define a sound event",p);var t=l[1];validSeed(t)?b[l[0]]=l[1]:logError('Expecting sfx data, instead found "'+l[1]+'".',p)}else{var r=l[0].trim(),v=l[1].trim(),w=l.slice(2,l.length-2);0<w.length&&"move"!==v&&"cantmove"!==v&&logError("incorrect sound declaration.",p);"action"===v&&(v=
"move",w=["___action____"]);0==w.length&&(w=["orthogonal"]);t=l[l.length-2];r in a.aggregatesDict?logError('cannot assign sound fevents to aggregate objects (declared with "and"), only to regular objects, or properties, things defined in terms of "or" ("'+r+'").',p):r in a.objectMasks||logError('Object "'+r+'" not found.',p);for(var l=a.objectMasks[r],C=0,A=0;A<w.length;A++){w[A]=w[A].trim();var s=w[A];-1===soundDirectionIndicators.indexOf(s)?logError('Was expecting a direction, instead found "'+
s+'".',p):C|=soundDirectionIndicatorMasks[s]}w=[r];r in a.propertiesDict&&(w=a.propertiesDict[r]);if("move"===v||"cantmove"===v)for(A=0;A<w.length;A++)r={objectMask:l,directionMask:C<<5*a.objects[w[A]].layer,seed:t},"move"===v?d.push(r):h.push(r);validSeed(t)||logError('Expecting sfx data, instead found "'+t+'".',p);switch(v){case "create":r={objectMask:l,seed:t};c.push(r);break;case "destroy":r={objectMask:l,seed:t},f.push(r)}}}}a.sfx_Events=b;a.sfx_CreationMasks=c;a.sfx_DestructionMasks=f;a.sfx_MovementMasks=
d;a.sfx_MovementFailureMasks=h}var MAX_ERRORS=5;
function loadFile(a){window.console.log("loadFile");var b=new codeMirrorFn,c=b.startState();a=a.split("\n");for(var f=0;f<a.length;f++){var d=a[f];c.lineNumber=f+1;d=new CodeMirror.StringStream(d,4);do if(b.token(d,c),errorCount>MAX_ERRORS){consolePrint("too many errors, aborting compilation");return}while(!1==d.eol())}delete c.lineNumber;generateExtraMembers(c);generatePlayerMask(c);levelsToArray(c);rulesToArray(c);debugMode&&printRules(c);rulesToMask(c);collapseRules(c);arrangeRulesByGroupNumber(c);
generateRigidGroupList(c);processWinCondition(c);checkObjectsAreLayered(c);twiddleMetaData(c);generateLoopPoints(c);generateSoundData(c);delete c.commentLevel;delete c.names;delete c.abbrevNames;delete c.objects_candname;delete c.objects_section;delete c.objects_spritematrix;delete c.section;delete c.subsection;delete c.tokenIndex;delete c.visitedSections;delete c.loops;return c};function jumpToLine(a){var b=parent.form1.code.editorreference;b.scrollIntoView(a-1-10);b.scrollIntoView(a-1+10);b.scrollIntoView(a-1);b.setCursor(a-1,0)}function playSound(a){a=generateFromSeed(a);a.sound_vol=SOUND_VOL;a.sample_rate=SAMPLE_RATE;a.sample_size=SAMPLE_SIZE;a=generate(a);var b=new Audio;b.src=a.dataURI;b.play()}function consolePrint(a){var b=document.getElementById("consoletextarea");b.innerHTML=b.innerHTML+"<br>"+a;a=document.getElementById("lowerarea");a.scrollTop=a.scrollHeight}
function clearConsole(){document.getElementById("consoletextarea").innerHTML="";var a=document.getElementById("lowerarea");a.scrollTop=a.scrollHeight}var clearConsoleClick=document.getElementById("clearConsoleClick");clearConsoleClick.addEventListener("click",clearConsole,!1);var audio;function newSound(a){var b=a+100*(1E6*Math.random()|1);document.getElementById("sounddat").value=b;document.getElementById("consoletextarea");consolePrint(generatorNames[a]+' : <span class="cm-SOUND" onclick="playSound('+b.toString()+')">'+b.toString()+"</span>");a=generateFromSeed(b);a.sound_vol=SOUND_VOL;a.sample_rate=SAMPLE_RATE;a.sample_size=SAMPLE_SIZE;a=generate(a);b=new Audio;b.src=a.dataURI;b.play()}
function buttonPress(){var a=document.getElementById("sounddat").value,a=generateFromSeed(a);a.sound_vol=SOUND_VOL;a.sample_rate=SAMPLE_RATE;a.sample_size=SAMPLE_SIZE;var a=generate(a),b=new Audio;b.src=a.dataURI;b.play()};function runClick(){compile(["restart"])}function rebuildClick(){compile(["rebuild"])}function post_to_url(a,b,c){c=c||"post";var f=document.createElement("form");f.setAttribute("method",c);f.setAttribute("action",a);for(var d in b)b.hasOwnProperty(d)&&(a=document.createElement("input"),a.setAttribute("type","hidden"),a.setAttribute("name",d),a.setAttribute("value",b[d]),f.appendChild(a));document.body.appendChild(f);f.submit()}
function exportClick(){editor.getValue();compile("restart");var a=JSON.stringify(state);consolePrint(a);buildStandalone(a)}
function compile(a,b){forceRegenImages=!0;void 0===a&&(a=["restart"]);lastDownTarget=canvas;void 0===b&&(b=window.form1.code.editorreference.getValue());!0===canDump&&(compiledText=b);errorCount=0;compiling=!0;errorStrings=[];consolePrint("=================================");try{var c=loadFile(b)}finally{compiling=!1}if(!(errorCount>MAX_ERRORS)){if(0<errorCount)consolePrint('<span class="systemMessage">Errors detected during compilation, the game will not work correctly.</span>');else{for(var f=0,
d=0;d<c.rules.length;d++)f+=c.rules[d].length;for(d=0;d<c.lateRules.length;d++)f+=c.lateRules[d].length;"restart"==a[0]?consolePrint('<span class="systemMessage">Successful Compilation, generated '+f+" instructions.</span>"):consolePrint('<span class="systemMessage">Successful live recompilation, generated '+f+" instructions.</span>")}setGameState(c,a);!0===canDump&&(inputHistory=[])}};onmousemove="mouseMove(event)";onmouseout="mouseOut()";var el=document.getElementById("gameCanvas");el.addEventListener?(el.addEventListener("mousemove",mouseMove,!1),el.addEventListener("mouseout",mouseOut,!1)):(el.attachEvent("onmousemove",mouseMove),el.attachEvent("onmouseout",mouseOut));for(var i=0;10>i;i++){var idname="newsound"+i,el=document.getElementById(idname);el.addEventListener("click",function(a){return function(){return newSound(a)}}(i),!1)}var soundButtonPress=document.getElementById("soundButtonPress");soundButtonPress.addEventListener("click",buttonPress,!1);var runClickLink=document.getElementById("runClickLink");runClickLink.addEventListener("click",runClick,!1);var rebuildClickLink=document.getElementById("rebuildClickLink");
rebuildClickLink.addEventListener("click",rebuildClick,!1);var exportClickLink=document.getElementById("exportClickLink");exportClickLink.addEventListener("click",exportClick,!1);function makeGIF(){var a=document.createElement("canvas");a.width=screenwidth*cellwidth;a.height=screenheight*cellheight;a.style.width=screenwidth*cellwidth;a.style.height=screenheight*cellheight;var a=a.getContext("2d"),b=inputHistory.concat([]);unitTesting=!0;levelString=compiledText;if(0<errorStrings.length)throw errorStrings[0];var c=new GIFEncoder;c.setRepeat(0);c.setDelay(250);c.start();compile(["loadLevel",0],levelString);canvasResize();redraw();a.drawImage(canvas,-xoffset,-yoffset);c.addFrame(a);
for(var f=0;f<b.length;f++){var d=b[f];"undo"===d?DoUndo():"restart"===d?DoRestart():processInput(d);redraw();a.drawImage(canvas,-xoffset,-yoffset);c.addFrame(a)}c.finish();a="data:image/gif;base64,"+encode64(c.stream().getData());window.open(a)};
