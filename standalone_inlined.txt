<!DOCTYPE html> <html> <head> <title>__GAMETITLE__</title> <style> body{ background-color:black; font-family:"Courier New", Courier, monospace }#gameCanvas{ position:absolute;top:0px;left:0px;width:100%;height:100%;bottom:0px;right:0px;border:0px;background-color:black; }h1{ color:lightblue;font-weight:normal;}a{ color:lightblue;}.title{ background-color:none;text-align:center;font-size:100%;float:center;color:gray;position:absolute;left:10%;right:10%;top:0%;height:10%;}.footer{ background-color:none;text-align:center;float:center;color:white;position:absolute;margin-top:10px;left:10%;right:10%;top:90%;bottom:10%;}.gameContainer{ background-color:none;position:absolute;left:10%;right:10%;top:70px;bottom:70px;}</style> </head> <body> <div class="title"><h1>__GAMETITLE__</h1></div> <div class="gameContainer"> <canvas id="gameCanvas" onmousemove="mouseMove(event)" onmouseout="mouseOut()" onkeydown="keyDown()"></canvas> </div> <div class="footer"> <span id="errormessage" style="color:red;"></span> <a href="http://__HOMEPAGE__">__HOMEPAGE__</a> </div> <script>var unitTesting=!1,curlevel=0,levelEditorOpened=!1;try{!window.localStorage||localStorage[document.URL]!==undefined&&(curlevel=localStorage[document.URL])}catch(ex){}var verbose_logging=!1,cache_console_messages=!1,quittingTitleScreen=!1,quittingMessageScreen=!1,deltatime=17,timer=0,repeatinterval=150,autotick=0,autotickinterval=0,winning=!1,againing=!1,againinterval=150,oldflickscreendat=[],keybuffer=[],messageselected=!1,textImages={},initLevel={width:5,height:5,layerCount:2,dat:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],movementMask:[1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2,3,2,1,3,2,1,3,2,1,3,1,3,3,1,1,2,2,3,3,1,2,1,2,2,3,3,1,1,2,2],rigidGroupIndexMask:[],rigidMovementAppliedMask:[],bannedGroup:[],colCellContents:[],rowCellContents:[]},level=initLevel </script> <script>function stripTags(a){var b=document.createElement("div");b.innerHTML=a;var c=b.textContent||b.innerText||"";return c}function consolePrint(a){}function consoleCacheDump(a){}function consoleError(a,b){var c=document.getElementById("errormessage");a=stripTags(a),c.innerHTML+=a+"<br>"}function logErrorNoLine(a){var b=document.getElementById("errormessage");a=stripTags(a),b.innerHTML+=a+"<br>"}function logBetaMessage(a){var b=document.getElementById("errormessage");a=stripTags(a),b.innerHTML+=a+"<br>"}var canSetHTMLColors=!0,canDump=!1,canOpenEditor=!1,canYoutube=!0,IDE=!1 </script> <script>var font={a:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0]],b:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[0,1,1,0,0]],c:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[0,1,1,1,0]],d:[[0,0,0,1,0],[0,0,0,1,0],[0,1,1,1,0],[1,0,0,1,0],[0,1,1,0,0]],e:[[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0],[0,1,1,0,0]],f:[[0,0,0,0,0],[0,0,1,1,0],[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0]],g:[[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[0,1,1,0,0]],h:[[1,0,0,0,0],[1,0,0,0,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],i:[[0,0,1,0,0],[0,0,0,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,1,1,1,0]],j:[[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[1,0,1,0,0],[0,1,0,0,0]],k:[[1,0,0,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0]],l:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0]],m:[[0,0,0,0,0],[0,1,0,1,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],n:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0]],o:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,0,0,1,0],[0,1,1,0,0]],p:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[1,1,1,0,0],[1,0,0,0,0]],q:[[0,0,0,0,0],[0,1,1,0,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0]],r:[[0,0,0,0,0],[0,1,1,1,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0]],s:[[0,1,1,1,0],[1,0,0,0,0],[0,1,1,0,0],[0,0,0,1,0],[1,1,1,0,0]],t:[[0,1,0,0,0],[1,1,1,0,0],[0,1,0,0,0],[0,1,0,0,1],[0,0,1,1,0]],u:[[0,0,0,0,0],[1,0,0,1,0],[1,0,0,1,0],[1,0,0,1,0],[1,1,1,0,0]],v:[[0,0,0,0,0],[1,0,0,1,0],[1,0,1,0,0],[1,1,0,0,0],[1,0,0,0,0]],w:[[0,0,0,0,0],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],x:[[0,0,0,0,0],[1,0,0,1,0],[0,1,1,0,0],[0,1,1,0,0],[1,0,0,1,0]],y:[[1,0,0,1,0],[1,0,0,1,0],[0,1,1,1,0],[0,0,0,1,0],[1,1,1,0,0]],z:[[0,0,0,0,0],[1,1,1,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,0]],A:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],B:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0]],C:[[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],D:[[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,0]],E:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],F:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],G:[[0,1,1,1,1],[1,0,0,0,0],[1,0,0,1,1],[1,0,0,0,1],[0,1,1,1,1]],H:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1]],I:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],J:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,0,0]],K:[[1,0,0,0,1],[1,0,1,1,0],[1,1,0,0,0],[1,0,1,1,0],[1,0,0,0,1]],L:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,0,0,0,0],[1,1,1,1,1]],M:[[1,1,1,1,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1]],N:[[1,0,0,0,1],[1,1,0,0,1],[1,0,1,0,1],[1,0,0,1,1],[1,0,0,0,1]],O:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],P:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,0,0,0,0]],Q:[[1,1,1,1,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,0,0,1],[0,0,0,0,1]],R:[[1,1,1,1,0],[1,0,0,0,1],[1,1,1,1,0],[1,0,0,0,1],[1,0,0,0,1]],S:[[0,1,1,1,1],[1,0,0,0,0],[0,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],T:[[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],U:[[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]],V:[[1,0,0,0,1],[0,1,0,1,0],[0,1,0,1,0],[0,0,1,0,0],[0,0,1,0,0]],W:[[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[1,0,1,0,1],[0,1,0,1,0]],X:[[1,0,0,0,1],[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[1,0,0,0,1]],Y:[[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],Z:[[1,1,1,1,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],0:[[1,1,1,1,1],[1,0,0,1,1],[1,0,1,0,1],[1,1,0,0,1],[1,1,1,1,1]],1:[[1,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1]],2:[[1,1,1,1,1],[0,0,0,0,1],[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,1]],3:[[1,1,1,1,0],[0,0,0,0,1],[0,0,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],4:[[1,0,0,0,0],[1,0,0,0,0],[1,0,0,1,0],[1,1,1,1,1],[0,0,0,1,0]],5:[[1,1,1,1,1],[1,0,0,0,0],[1,1,1,1,0],[0,0,0,0,1],[1,1,1,1,0]],6:[[0,1,1,1,0],[1,0,0,0,0],[1,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],7:[[1,1,1,1,1],[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],8:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,0]],9:[[0,1,1,1,0],[1,0,0,0,1],[0,1,1,1,1],[0,0,0,0,1],[0,1,1,1,0]],".":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0]],",":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],";":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,1,1,0,0]],":":[[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0],[0,0,0,0,0]],"?":[[0,1,1,1,0],[1,0,0,0,1],[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0]],"!":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,1,0,0]],"@":[[0,1,1,1,0],[1,0,0,0,1],[1,0,1,1,1],[1,0,0,0,0],[0,1,1,1,0]],"Â£":[[0,1,1,1,0],[0,1,0,0,1],[1,1,1,0,0],[0,1,0,0,0],[1,1,1,1,1]],$:[[0,1,1,1,1],[1,0,1,0,0],[0,1,1,1,0],[0,0,1,0,1],[1,1,1,1,0]],"%":[[1,1,0,0,1],[1,1,0,1,0],[0,0,1,0,0],[0,1,0,1,1],[1,0,0,1,1]],"^":[[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"&":[[0,1,1,0,0],[1,0,0,0,0],[0,1,0,1,1],[1,0,0,1,0],[0,1,1,0,0]],"*":[[0,1,0,1,0],[0,0,1,0,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0]],"(":[[0,0,0,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,0,1,0]],")":[[0,1,0,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,0,0,0]],"+":[[0,0,1,0,0],[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,0,1,0,0]],"-":[[0,0,0,0,0],[0,0,0,0,0],[0,1,1,1,0],[0,0,0,0,0],[0,0,0,0,0]],_:[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[1,1,1,1,1]],"=":[[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0],[1,1,1,1,1],[0,0,0,0,0]]," ":[[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"{":[[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"}":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,1,0],[0,0,1,0,0],[0,1,1,0,0]],"[":[[0,0,1,1,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,1,0]],"]":[[0,1,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,1,1,0,0]],"'":[[0,0,1,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],'"':[[0,1,0,1,0],[0,1,0,1,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"/":[[0,0,0,0,1],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[1,0,0,0,0]],"\\":[[1,0,0,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,0,0,1]],"|":[[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0],[0,0,1,0,0]],"<":[[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0]],">":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,1,0],[0,0,1,0,0],[0,1,0,0,0]],"~":[[0,0,0,0,0],[0,1,0,0,0],[1,0,1,0,1],[0,0,0,1,0],[0,0,0,0,0]],"`":[[0,1,0,0,0],[0,0,1,0,0],[0,0,0,0,0],[0,0,0,0,0],[0,0,0,0,0]],"#":[[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0],[1,1,1,1,1],[0,1,0,1,0]]} </script> <script>function RC4(a){this.s=new Array(256),this.i=0,this.j=0;for(var b=0;b<256;b++)this.s[b]=b;a&&this.mix(a)}function RNG(a){a==null?a=(Math.random()+Date.now()).toString():typeof a=="function"?(this.uniform=a,this.nextByte=function(){return~~(this.uniform()*256)},a=null):Object.prototype.toString.call(a)!=="[object String]"&&(a=JSON.stringify(a)),this._normal=null,a?this._state=new RC4(a):this._state=null}String.prototype.getBytes=function(){var a=[];for(var b=0;b<this.length;b++){var c=this.charCodeAt(b),d=[];do d.push(c&255),c>>=8;while(c>0);a=a.concat(d.reverse())}return a},RC4.prototype._swap=function(a,b){var c=this.s[a];this.s[a]=this.s[b],this.s[b]=c},RC4.prototype.mix=function(a){var b=a.getBytes(),c=0;for(var d=0;d<this.s.length;d++)c+=this.s[d]+b[d%b.length],c%=256,this._swap(d,c)},RC4.prototype.next=function(){return this.i=(this.i+1)%256,this.j=(this.j+this.s[this.i])%256,this._swap(this.i,this.j),this.s[(this.s[this.i]+this.s[this.j])%256]},RNG.prototype.nextByte=function(){return this._state.next()},RNG.prototype.uniform=function(){var a=7,b=0;for(var c=0;c<a;c++)b*=256,b+=this.nextByte();return b/(Math.pow(2,a*8)-1)},RNG.prototype.random=function(a,b){return a==null?this.uniform():(b==null&&(b=a,a=0),a+Math.floor(this.uniform()*(b-a)))},RNG.prototype.normal=function(){if(this._normal!==null){var a=this._normal;return this._normal=null,a}var b=this.uniform()||Math.pow(2,-53),c=this.uniform();return this._normal=Math.sqrt(-2*Math.log(b))*Math.sin(2*Math.PI*c),Math.sqrt(-2*Math.log(b))*Math.cos(2*Math.PI*c)},RNG.prototype.exponential=function(){return-Math.log(this.uniform()||Math.pow(2,-53))},RNG.prototype.poisson=function(a){var b=Math.exp(-(a||1)),c=0,d=1;do c++,d*=this.uniform();while(d>b);return c-1},RNG.prototype.gamma=function(a){var b=(a<1?1+a:a)-1/3,c=1/Math.sqrt(9*b);do{do var d=this.normal(),e=Math.pow(c*d+1,3);while(e<=0);var f=this.uniform(),g=Math.pow(d,2)}while(f>=1-.0331*g*g&&Math.log(f)>=.5*g+b*(1-e+Math.log(e)));return a<1?b*e*Math.exp(this.exponential()/-a):b*e},RNG.roller=function(a,b){var c=a.split(/(\d+)?d(\d+)([+-]\d+)?/).slice(1),d=parseFloat(c[0])||1,e=parseFloat(c[1]),f=parseFloat(c[2])||0;return b=b||new RNG,function(){var a=d+f;for(var c=0;c<d;c++)a+=b.random(e);return a}},RNG.$=new RNG </script> <script>function FastBase64_Init(){for(var a=0;a<4096;a++)FastBase64_encLookup[a]=FastBase64_chars[a>>6]+FastBase64_chars[a&63]}function FastBase64_Encode(a){var b=a.length,c="",d=0;while(b>2)n=a[d]<<16|a[d+1]<<8|a[d+2],c+=FastBase64_encLookup[n>>12]+FastBase64_encLookup[n&4095],b-=3,d+=3;if(b>0){var e=(a[d]&252)>>2,f=(a[d]&3)<<4;b>1&&(f|=(a[++d]&240)>>4),c+=FastBase64_chars[e],c+=FastBase64_chars[f];if(b==2){var g=(a[d++]&15)<<2;g|=(a[d]&192)>>6,c+=FastBase64_chars[g]}b==1&&(c+="="),c+="="}return c}function u32ToArray(a){return[a&255,a>>8&255,a>>16&255,a>>24&255]}function u16ToArray(a){return[a&255,a>>8&255]}function MakeRiff(a,b,c){var d=[],e=[],f=[],g={chunkId:[82,73,70,70],chunkSize:0,format:[87,65,86,69],subChunk1Id:[102,109,116,32],subChunk1Size:16,audioFormat:1,numChannels:1,sampleRate:a,byteRate:0,blockAlign:0,bitsPerSample:b,subChunk2Id:[100,97,116,97],subChunk2Size:0};g.byteRate=g.sampleRate*g.numChannels*g.bitsPerSample>>3,g.blockAlign=g.numChannels*g.bitsPerSample>>3,g.subChunk2Size=c.length,g.chunkSize=36+g.subChunk2Size,e=g.chunkId.concat(u32ToArray(g.chunkSize),g.format,g.subChunk1Id,u32ToArray(g.subChunk1Size),u16ToArray(g.audioFormat),u16ToArray(g.numChannels),u32ToArray(g.sampleRate),u32ToArray(g.byteRate),u16ToArray(g.blockAlign),u16ToArray(g.bitsPerSample),g.subChunk2Id,u32ToArray(g.subChunk2Size),c),f="data:audio/wav;base64,"+FastBase64_Encode(e);var h={dat:d,wav:e,header:g,dataURI:f};return h}var FastBase64_chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",FastBase64_encLookup=[];FastBase64_Init(),typeof exports!="undefined"&&(exports.RIFFWAVE=RIFFWAVE) </script> <script>function Params(){var a={};return a.wave_type=SQUARE,a.p_env_attack=0,a.p_env_sustain=.3,a.p_env_punch=0,a.p_env_decay=.4,a.p_base_freq=.3,a.p_freq_limit=0,a.p_freq_ramp=0,a.p_freq_dramp=0,a.p_vib_strength=0,a.p_vib_speed=0,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=0,a.p_duty_ramp=0,a.p_repeat_speed=0,a.p_pha_offset=0,a.p_pha_ramp=0,a.p_lpf_freq=1,a.p_lpf_ramp=0,a.p_lpf_resonance=0,a.p_hpf_freq=0,a.p_hpf_ramp=0,a.sound_vol=.5,a.sample_rate=44100,a.sample_size=8,a}function frnd(a){return seeded?rng.uniform()*a:Math.random()*a}function rnd(a){return seeded?Math.floor(rng.uniform()*(a+1)):Math.floor(Math.random()*(a+1))}function cacheSeed(a){if(a in sfxCache)return;var b=generateFromSeed(a);b.sound_vol=SOUND_VOL,b.sample_rate=SAMPLE_RATE,b.sample_size=SAMPLE_SIZE;var c=generate(b),d=new Audio;d.src=c.dataURI,sfxCache[a]=d,cachedSeeds.push(a);while(cachedSeeds.length>CACHE_MAX){var e=cachedSeeds[0];cachedSeeds=cachedSeeds.slice(1),delete sfxCache[e]}}function playSeed(a){if(unitTesting)return;cacheSeed(a);var b=sfxCache[a];b.cloneNode().play()}var SOUND_VOL=.25,SAMPLE_RATE=5512,SAMPLE_SIZE=8,SQUARE=0,SAWTOOTH=1,SINE=2,NOISE=3,TRIANGLE=4,BREAKER=5,SHAPES=["square","sawtooth","sine","noise","triangle","breaker"],masterVolume=1,rng,seeded=!1;pickupCoin=function(){var a=Params();a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=0),a.p_base_freq=.4+frnd(.5),a.p_env_attack=0,a.p_env_sustain=frnd(.1),a.p_env_decay=.1+frnd(.4),a.p_env_punch=.3+frnd(.3);if(rnd(1)){a.p_arp_speed=.5+frnd(.2);var b=(frnd(7)|1)+1,c=b+(frnd(7)|1)+2;a.p_arp_mod=+b/+c}return a},laserShoot=function(){var a=Params();return a.wave_type=rnd(2),a.wave_type===SINE&&rnd(1)&&(a.wave_type=rnd(1)),a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_base_freq=.5+frnd(.5),a.p_freq_limit=a.p_base_freq-.2-frnd(.6),a.p_freq_limit<.2&&(a.p_freq_limit=.2),a.p_freq_ramp=-0.15-frnd(.2),rnd(2)===0&&(a.p_base_freq=.3+frnd(.6),a.p_freq_limit=frnd(.1),a.p_freq_ramp=-0.35-frnd(.3)),rnd(1)?(a.p_duty=frnd(.5),a.p_duty_ramp=frnd(.2)):(a.p_duty=.4+frnd(.5),a.p_duty_ramp=-frnd(.7)),a.p_env_attack=0,a.p_env_sustain=.1+frnd(.2),a.p_env_decay=frnd(.4),rnd(1)&&(a.p_env_punch=frnd(.3)),rnd(2)===0&&(a.p_pha_offset=frnd(.2),a.p_pha_ramp=-frnd(.2)),rnd(1)&&(a.p_hpf_freq=frnd(.3)),a},explosion=function(){var a=Params();return rnd(1)?(a.p_base_freq=.1+frnd(.4),a.p_freq_ramp=-0.1+frnd(.4)):(a.p_base_freq=.2+frnd(.7),a.p_freq_ramp=-0.2-frnd(.2)),a.p_base_freq*=a.p_base_freq,rnd(4)===0&&(a.p_freq_ramp=0),rnd(2)===0&&(a.p_repeat_speed=.3+frnd(.5)),a.p_env_attack=0,a.p_env_sustain=.1+frnd(.3),a.p_env_decay=frnd(.5),rnd(1)===0&&(a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3)),a.p_env_punch=.2+frnd(.6),rnd(1)&&(a.p_vib_strength=frnd(.7),a.p_vib_speed=frnd(.6)),rnd(2)===0&&(a.p_arp_speed=.6+frnd(.3),a.p_arp_mod=.8-frnd(1.6)),a},birdSound=function(){var a=Params();if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.4304400932967592+frnd(.2)-.1,a.p_env_sustain=.15739346034252394+frnd(.2)-.1,a.p_env_punch=.004488201744871758+frnd(.2)-.1,a.p_env_decay=.07478075528212291+frnd(.2)-.1,a.p_base_freq=.9865265720147687+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.2995018224359539+frnd(.2)-.1,frnd(1)<.5&&(a.p_freq_ramp=.1+frnd(.15)),a.p_freq_dramp=.004598608156964473+frnd(.1)-.05,a.p_vib_strength=-0.2202799497929496+frnd(.2)-.1,a.p_vib_speed=.8084998703158364+frnd(.2)-.1,a.p_arp_mod=0,a.p_arp_speed=0,a.p_duty=-0.9031808754347107+frnd(.2)-.1,a.p_duty_ramp=-0.8128699999808343+frnd(.2)-.1,a.p_repeat_speed=.601486018931999+frnd(.2)-.1,a.p_pha_offset=-0.9424902314367765+frnd(.2)-.1,a.p_pha_ramp=-0.1055482222272056+frnd(.2)-.1,a.p_lpf_freq=.9989765717851521+frnd(.2)-.1,a.p_lpf_ramp=-0.25051720626043017+frnd(.2)-.1,a.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,a.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,a.p_hpf_ramp=-0.002375673204842568+frnd(.2)-.1,a;if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.5277795946672003+frnd(.2)-.1,a.p_env_sustain=.18243733568468432+frnd(.2)-.1,a.p_env_punch=-0.020159754546840117+frnd(.2)-.1,a.p_env_decay=.1561353422051903+frnd(.2)-.1,a.p_base_freq=.9028855606533718+frnd(.2)-.1,a.p_freq_limit=-0.008842787837148716,a.p_freq_ramp=-0.1,a.p_freq_dramp=-0.012891241489551925,a.p_vib_strength=-0.17923136138403065+frnd(.2)-.1,a.p_vib_speed=.908263385610142+frnd(.2)-.1,a.p_arp_mod=.41690153355414894+frnd(.2)-.1,a.p_arp_speed=.0010766233195860704+frnd(.2)-.1,a.p_duty=-0.8735363011184684+frnd(.2)-.1,a.p_duty_ramp=-0.7397985366747507+frnd(.2)-.1,a.p_repeat_speed=.0591789344172107+frnd(.2)-.1,a.p_pha_offset=-0.9961184222777699+frnd(.2)-.1,a.p_pha_ramp=-0.08234769395850523+frnd(.2)-.1,a.p_lpf_freq=.9412475115697335+frnd(.2)-.1,a.p_lpf_ramp=-0.18261358925834958+frnd(.2)-.1,a.p_lpf_resonance=.24541438107389477+frnd(.2)-.1,a.p_hpf_freq=-0.01831940280978611+frnd(.2)-.1,a.p_hpf_ramp=-0.03857383633171346+frnd(.2)-.1,a;if(frnd(10)<1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),a.p_env_attack=.4304400932967592+frnd(.2)-.1,a.p_env_sustain=.15739346034252394+frnd(.2)-.1,a.p_env_punch=.004488201744871758+frnd(.2)-.1,a.p_env_decay=.07478075528212291+frnd(.2)-.1,a.p_base_freq=.9865265720147687+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.2995018224359539+frnd(.2)-.1,a.p_freq_dramp=.004598608156964473+frnd(.2)-.1,a.p_vib_strength=-0.2202799497929496+frnd(.2)-.1,a.p_vib_speed=.8084998703158364+frnd(.2)-.1,a.p_arp_mod=-0.46410459213693644+frnd(.2)-.1,a.p_arp_speed=-0.10955361249587248+frnd(.2)-.1,a.p_duty=-0.9031808754347107+frnd(.2)-.1,a.p_duty_ramp=-0.8128699999808343+frnd(.2)-.1,a.p_repeat_speed=.7014860189319991+frnd(.2)-.1,a.p_pha_offset=-0.9424902314367765+frnd(.2)-.1,a.p_pha_ramp=-0.1055482222272056+frnd(.2)-.1,a.p_lpf_freq=.9989765717851521+frnd(.2)-.1,a.p_lpf_ramp=-0.25051720626043017+frnd(.2)-.1,a.p_lpf_resonance=.32777871505494693+frnd(.2)-.1,a.p_hpf_freq=.0023548750981756753+frnd(.2)-.1,a.p_hpf_ramp=-0.002375673204842568+frnd(.2)-.1,a;if(frnd(5)>1)return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),rnd(1)?(a.p_arp_mod=.2697849293151393+frnd(.2)-.1,a.p_arp_speed=-0.3131172257760948+frnd(.2)-.1,a.p_base_freq=.8090588299313949+frnd(.2)-.1,a.p_duty=-0.6210022920964955+frnd(.2)-.1,a.p_duty_ramp=-0.00043441813553182567+frnd(.2)-.1,a.p_env_attack=.004321877246874195+frnd(.2)-.1,a.p_env_decay=.1+frnd(.2)-.1,a.p_env_punch=.061737781504416146+frnd(.2)-.1,a.p_env_sustain=.4987252564798832+frnd(.2)-.1,a.p_freq_dramp=.31700340314222614+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.163380391341416+frnd(.2)-.1,a.p_hpf_freq=.4709005021145149+frnd(.2)-.1,a.p_hpf_ramp=.6924667290539194+frnd(.2)-.1,a.p_lpf_freq=.8351398631384511+frnd(.2)-.1,a.p_lpf_ramp=.36616557192873134+frnd(.2)-.1,a.p_lpf_resonance=-0.08685777111664439+frnd(.2)-.1,a.p_pha_offset=-0.036084571580025544+frnd(.2)-.1,a.p_pha_ramp=-0.014806445085568108+frnd(.2)-.1,a.p_repeat_speed=-0.8094368475518489+frnd(.2)-.1,a.p_vib_speed=.4496665457171294+frnd(.2)-.1,a.p_vib_strength=.23413762515532424+frnd(.2)-.1):(a.p_arp_mod=-0.35697118026766184+frnd(.2)-.1,a.p_arp_speed=.3581140690559588+frnd(.2)-.1,a.p_base_freq=1.3260897696157528+frnd(.2)-.1,a.p_duty=-0.30984900436710694+frnd(.2)-.1,a.p_duty_ramp=-0.0014374759133411626+frnd(.2)-.1,a.p_env_attack=.3160357835682254+frnd(.2)-.1,a.p_env_decay=.1+frnd(.2)-.1,a.p_env_punch=.24323114016870148+frnd(.2)-.1,a.p_env_sustain=.4+frnd(.2)-.1,a.p_freq_dramp=.2866475886237244+frnd(.2)-.1,a.p_freq_limit=0+frnd(.2)-.1,a.p_freq_ramp=-0.10956352368742976+frnd(.2)-.1,a.p_hpf_freq=.20772718017889846+frnd(.2)-.1,a.p_hpf_ramp=.1564090637378835+frnd(.2)-.1,a.p_lpf_freq=.6021372770637031+frnd(.2)-.1,a.p_lpf_ramp=.24016227139979027+frnd(.2)-.1,a.p_lpf_resonance=-0.08787383821160144+frnd(.2)-.1,a.p_pha_offset=-0.381597686151701+frnd(.2)-.1,a.p_pha_ramp=-0.0002481687661373495+frnd(.2)-.1,a.p_repeat_speed=.07812112809425686+frnd(.2)-.1,a.p_vib_speed=-0.13648848579133943+frnd(.2)-.1,a.p_vib_strength=.0018874158972302657+frnd(.2)-.1),a;a.wave_type=Math.floor(frnd(SHAPES.length));if(a.wave_type===1||a.wave_type===3)a.wave_type=2;return a.p_base_freq=.85+frnd(.15),a.p_freq_ramp=.3+frnd(.15),a.p_env_attack=0+frnd(.09),a.p_env_sustain=.2+frnd(.3),a.p_env_decay=0+frnd(.1),a.p_duty=frnd(2)-1,a.p_duty_ramp=Math.pow(frnd(2)-1,3),a.p_repeat_speed=.5+frnd(.1),a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3),a.p_arp_speed=.4+frnd(.6),a.p_arp_mod=.8+frnd(.1),a.p_lpf_resonance=frnd(2)-1,a.p_lpf_freq=1-Math.pow(frnd(1),3),a.p_lpf_ramp=Math.pow(frnd(2)-1,3),a.p_lpf_freq<.1&&a.p_lpf_ramp<-0.05&&(a.p_lpf_ramp=-a.p_lpf_ramp),a.p_hpf_freq=Math.pow(frnd(1),5),a.p_hpf_ramp=Math.pow(frnd(2)-1,5),a},pushSound=function(){var a=Params();return a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===2&&a.wave_type++,a.wave_type===0&&(a.wave_type=NOISE),a.p_base_freq=.1+frnd(.4),a.p_freq_ramp=.05+frnd(.2),a.p_env_attack=.01+frnd(.09),a.p_env_sustain=.01+frnd(.09),a.p_env_decay=.01+frnd(.09),a.p_repeat_speed=.3+frnd(.5),a.p_pha_offset=-0.3+frnd(.9),a.p_pha_ramp=-frnd(.3),a.p_arp_speed=.6+frnd(.3),a.p_arp_mod=.8-frnd(1.6),a},powerUp=function(){var a=Params();return rnd(1)?a.wave_type=SAWTOOTH:a.p_duty=frnd(.6),a.wave_type=Math.floor(frnd(SHAPES.length)),a.wave_type===3&&(a.wave_type=SQUARE),rnd(1)?(a.p_base_freq=.2+frnd(.3),a.p_freq_ramp=.1+frnd(.4),a.p_repeat_speed=.4+frnd(.4)):(a.p_base_freq=.2+frnd(.3),a.p_freq_ramp=.05+frnd(.2),rnd(1)&&(a.p_vib_strength=frnd(.7),a.p_vib_speed=frnd(.6))),a.p_env_attack=0,a.p_env_sustain=frnd(.4),a.p_env_decay=.1+frnd(.4),a},hitHurt=function(){return result=Params(),result.wave_type=rnd(2),result.wave_type===SINE&&(result.wave_type=NOISE),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=.2+frnd(.6),result.p_freq_ramp=-0.3-frnd(.4),result.p_env_attack=0,result.p_env_sustain=frnd(.1),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),result},jump=function(){return result=Params(),result.wave_type=SQUARE,result.wave_type=Math.floor(frnd(SHAPES.length)),result.wave_type===3&&(result.wave_type=SQUARE),result.p_duty=frnd(.6),result.p_base_freq=.3+frnd(.3),result.p_freq_ramp=.1+frnd(.2),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.3),result.p_env_decay=.1+frnd(.2),rnd(1)&&(result.p_hpf_freq=frnd(.3)),rnd(1)&&(result.p_lpf_freq=1-frnd(.6)),result},blipSelect=function(){return result=Params(),result.wave_type=rnd(1),result.wave_type=Math.floor(frnd(SHAPES.length)),result.wave_type===3&&(result.wave_type=rnd(1)),result.wave_type===SQUARE&&(result.p_duty=frnd(.6)),result.p_base_freq=.2+frnd(.4),result.p_env_attack=0,result.p_env_sustain=.1+frnd(.1),result.p_env_decay=frnd(.2),result.p_hpf_freq=.1,result},random=function(){return result=Params(),result.wave_type=Math.floor(frnd(SHAPES.length)),result.p_base_freq=Math.pow(frnd(2)-1,2),rnd(1)&&(result.p_base_freq=Math.pow(frnd(2)-1,3)+.5),result.p_freq_limit=0,result.p_freq_ramp=Math.pow(frnd(2)-1,5),result.p_base_freq>.7&&result.p_freq_ramp>.2&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_base_freq<.2&&result.p_freq_ramp<-0.05&&(result.p_freq_ramp=-result.p_freq_ramp),result.p_freq_dramp=Math.pow(frnd(2)-1,3),result.p_duty=frnd(2)-1,result.p_duty_ramp=Math.pow(frnd(2)-1,3),result.p_vib_strength=Math.pow(frnd(2)-1,3),result.p_vib_speed=frnd(2)-1,result.p_env_attack=Math.pow(frnd(2)-1,3),result.p_env_sustain=Math.pow(frnd(2)-1,2),result.p_env_decay=frnd(2)-1,result.p_env_punch=Math.pow(frnd(.8),2),result.p_env_attack+result.p_env_sustain+result.p_env_decay<.2&&(result.p_env_sustain+=.2+frnd(.3),result.p_env_decay+=.2+frnd(.3)),result.p_lpf_resonance=frnd(2)-1,result.p_lpf_freq=1-Math.pow(frnd(1),3),result.p_lpf_ramp=Math.pow(frnd(2)-1,3),result.p_lpf_freq<.1&&result.p_lpf_ramp<-0.05&&(result.p_lpf_ramp=-result.p_lpf_ramp),result.p_hpf_freq=Math.pow(frnd(1),5),result.p_hpf_ramp=Math.pow(frnd(2)-1,5),result.p_pha_offset=Math.pow(frnd(2)-1,3),result.p_pha_ramp=Math.pow(frnd(2)-1,3),result.p_repeat_speed=frnd(2)-1,result.p_arp_speed=frnd(2)-1,result.p_arp_mod=frnd(2)-1,result};var generators=[pickupCoin,laserShoot,explosion,powerUp,hitHurt,jump,blipSelect,pushSound,random,birdSound],generatorNames=["pickupCoin","laserShoot","explosion","powerUp","hitHurt","jump","blipSelect","pushSound","random","birdSound"];generateFromSeed=function(a){rng=new RNG(a/100|0);var b=a%100,c=generators[b%generators.length];seeded=!0;var d=c();return d.seed=a,seeded=!1,d};var generate=function(a){function b(){c=0,d=100/(a.p_base_freq*a.p_base_freq+.001),e=Math.floor(d),f=100/(a.p_freq_limit*a.p_freq_limit+.001),g=1-Math.pow(a.p_freq_ramp,3)*.01,h=-Math.pow(a.p_freq_dramp,3)*1e-6,i=.5-a.p_duty*.5,j=-a.p_duty_ramp*5e-5,a.p_arp_mod>=0?k=1-Math.pow(a.p_arp_mod,2)*.9:k=1+Math.pow(a.p_arp_mod,2)*10,l=0,m=Math.floor(Math.pow(1-a.p_arp_speed,2)*2e4+32),a.p_arp_speed==1&&(m=0)}var c,d,e,f,g,h,i,j,k,l,m;b();var n=0,o=0,p=Math.pow(a.p_lpf_freq,3)*.1,q=1+a.p_lpf_ramp*1e-4,r=5/(1+Math.pow(a.p_lpf_resonance,2)*20)*(.01+p);r>.8&&(r=.8);var s=0,t=Math.pow(a.p_hpf_freq,2)*.1,u=1+a.p_hpf_ramp*3e-4,v=0,w=Math.pow(a.p_vib_speed,2)*.01,x=a.p_vib_strength*.5,y=0,z=0,A=0,B=[Math.floor(a.p_env_attack*a.p_env_attack*1e5),Math.floor(a.p_env_sustain*a.p_env_sustain*1e5),Math.floor(a.p_env_decay*a.p_env_decay*1e5)],C=0,D=Math.pow(a.p_pha_offset,2)*1020;a.p_pha_offset<0&&(D=-D);var E=Math.pow(a.p_pha_ramp,2)*1;a.p_pha_ramp<0&&(E=-E);var F=Math.abs(Math.floor(D)),G=0,H=[];for(var I=0;I<1024;++I)H[I]=0;var J=[];for(var I=0;I<32;++I)J[I]=Math.random()*2-1;var K=Math.floor(Math.pow(1-a.p_repeat_speed,2)*2e4+32);a.p_repeat_speed==0&&(K=0);var L=2*a.sound_vol,L=Math.exp(a.sound_vol)-1,M=0,N=[],O=0,P=0,Q=Math.floor(44100/a.sample_rate);for(var R=0;;++R){K!=0&&++c>=K&&b(),m!=0&&R>=m&&(m=0,d*=k),g+=h,d*=g;if(d>f){d=f;if(a.p_freq_limit>0)break}var S=d;x>0&&(v+=w,S=d*(1+Math.sin(v)*x)),e=Math.floor(S),e<8&&(e=8),i+=j,i<0&&(i=0),i>.5&&(i=.5),A++;if(A>B[z]){A=0,z++;if(z===3)break}z===0?y=A/B[0]:z===1?y=1+Math.pow(1-A/B[1],1)*2*a.p_env_punch:y=1-A/B[2],D+=E,F=Math.abs(Math.floor(D)),F>1023&&(F=1023),u!=0&&(t*=u,t<1e-5&&(t=1e-5),t>.1&&(t=.1));var T=0;for(var U=0;U<8;++U){var V=0;C++;if(C>=e){C%=e;if(a.wave_type===NOISE)for(var I=0;I<32;++I)J[I]=Math.random()*2-1}var W=C/e;if(a.wave_type===SQUARE)W<i?V=.5:V=-0.5;else if(a.wave_type===SAWTOOTH)V=1-W*2;else if(a.wave_type===SINE)V=Math.sin(W*2*Math.PI);else if(a.wave_type===NOISE)V=J[Math.floor(C*32/e)];else if(a.wave_type===TRIANGLE)V=Math.abs(1-W*2)-1;else if(a.wave_type===BREAKER)V=Math.abs(1-W*W*2)-1;else throw new Exception("bad wave type! "+a.wave_type);var X=n;p*=q,p<0&&(p=0),p>.1&&(p=.1),a.p_lpf_freq!=1?(o+=(V-n)*p,o-=o*r):(n=V,o=0),n+=o,s+=n-X,s-=s*t,V=s,H[G&1023]=V,V+=H[G-F+1024&1023],G=G+1&1023,T+=V*y}O+=T;if(++P>=Q)P=0,T=O/Q,O=0;else continue;T=T/8*masterVolume,T*=L,a.sample_size===8?(T=Math.floor((T+1)*128),T>255?(T=255,++M):T<0&&(T=0,++M),N.push(T)):(T=Math.floor(T*32768),T>=32768?(T=32767,++M):T<-32768&&(T=-32768,++M),N.push(T&255),N.push(T>>8&255))}var Y=MakeRiff(a.sample_rate,a.sample_size,N);return Y.clipping=M,Y};if(typeof exports!="undefined"){var RIFFWAVE=require("./riffwave").RIFFWAVE;exports.Params=Params,exports.generate=generate}var sfxCache={},cachedSeeds=[],CACHE_MAX=50 </script> <script>colorPalettes={mastersystem:{black:"#000000",white:"#FFFFFF",grey:"#555555",darkgrey:"#555500",lightgrey:"#AAAAAA",gray:"#555555",darkgray:"#555500",lightgray:"#AAAAAA",red:"#FF0000",darkred:"#AA0000",lightred:"#FF5555",brown:"#AA5500",darkbrown:"#550000",lightbrown:"#FFAA00",orange:"#FF5500",yellow:"#FFFF55",green:"#55AA00",darkgreen:"#005500",lightgreen:"#AAFF00",blue:"#5555AA",lightblue:"#AAFFFF",darkblue:"#000055",purple:"#550055",pink:"#FFAAFF"},gameboycolour:{black:"#000000",white:"#FFFFFF",grey:"#7F7F7C",darkgrey:"#3E3E44",lightgrey:"#BAA7A7",gray:"#7F7F7C",darkgray:"#3E3E44",lightgray:"#BAA7A7",red:"#A7120C",darkred:"#880606",lightred:"#BA381F",brown:"#57381F",darkbrown:"#3E2519",lightbrown:"#8E634B",orange:"#BA4B32",yellow:"#C0BA6F",green:"#517525",darkgreen:"#385D12",lightgreen:"#6F8E44",blue:"#5D6FA7",lightblue:"#8EA7A7",darkblue:"#4B575D",purple:"#3E3E44",pink:"#BA381F"},amiga:{black:"#000000",white:"#FFFFFF",grey:"#BBBBBB",darkgrey:"#333333",lightgrey:"#FFEEDD",gray:"#BBBBBB",darkgray:"#333333",lightgray:"#FFEEDD",red:"#DD1111",darkred:"#990000",lightred:"#FF4422",brown:"#663311",darkbrown:"#331100",lightbrown:"#AA6644",orange:"#FF6644",yellow:"#FFDD66",green:"#448811",darkgreen:"#335500",lightgreen:"#88BB77",blue:"#8899DD",lightblue:"#BBDDEE",darkblue:"#666688",purple:"#665555",pink:"#997788"},arnecolors:{black:"#000000",white:"#FFFFFF",grey:"#9d9d9d",darkgrey:"#697175",lightgrey:"#cccccc",gray:"#9d9d9d",darkgray:"#697175",lightgray:"#cccccc",red:"#be2633",darkred:"#732930",lightred:"#e06f8b",brown:"#a46422",darkbrown:"#493c2b",lightbrown:"#eeb62f",orange:"#eb8931",yellow:"#f7e26b",green:"#44891a",darkgreen:"#2f484e",lightgreen:"#a3ce27",blue:"#1d57f7",lightblue:"#B2DCEF",darkblue:"#1B2632",purple:"#342a97",pink:"#de65e2"},famicom:{black:"#000000",white:"#ffffff",grey:"#7c7c7c",darkgrey:"#080808",lightgrey:"#bcbcbc",gray:"#7c7c7c",darkgray:"#080808",lightgray:"#bcbcbc",red:"#f83800",darkred:"#881400",lightred:"#f87858",brown:"#AC7C00",darkbrown:"#503000",lightbrown:"#FCE0A8",orange:"#FCA044",yellow:"#F8B800",green:"#00B800",darkgreen:"#005800",lightgreen:"#B8F8B8",blue:"#0058F8",lightblue:"#3CBCFC",darkblue:"#0000BC",purple:"#6644FC",pink:"#F878F8"},atari:{black:"#000000",white:"#FFFFFF",grey:"#909090",darkgrey:"#404040",lightgrey:"#b0b0b0",gray:"#909090",darkgray:"#404040",lightgray:"#b0b0b0",red:"#A03C50",darkred:"#700014",lightred:"#DC849C",brown:"#805020",darkbrown:"#703400",lightbrown:"#CB9870",orange:"#CCAC70",yellow:"#ECD09C",green:"#58B06C",darkgreen:"#006414",lightgreen:"#70C484",blue:"#1C3C88",lightblue:"#6888C8",darkblue:"#000088",purple:"#3C0080",pink:"#B484DC"},pastel:{black:"#000000",white:"#FFFFFF",grey:"#3e3e3e",darkgrey:"#313131",lightgrey:"#9cbcbc",gray:"#3e3e3e",darkgray:"#313131",lightgray:"#9cbcbc",red:"#f56ca2",darkred:"#a63577",lightred:"#ffa9cf",brown:"#b58c53",darkbrown:"#787562",lightbrown:"#B58C53",orange:"#EB792D",yellow:"#FFe15F",green:"#00FF4F",darkgreen:"#2b732c",lightgreen:"#97c04f",blue:"#0f88d3",lightblue:"#00fffe",darkblue:"#293a7b",purple:"#ff6554",pink:"#eb792d"},ega:{black:"#000000",white:"#ffffff",grey:"#555555",darkgrey:"#555555",lightgrey:"#aaaaaa",gray:"#555555",darkgray:"#555555",lightgray:"#aaaaaa",red:"#ff5555",darkred:"#aa0000",lightred:"#ff55ff",brown:"#aa5500",darkbrown:"#aa5500",lightbrown:"#ffff55",orange:"#ff5555",yellow:"#ffff55",green:"#00aa00",darkgreen:"#00aaaa",lightgreen:"#55ff55",blue:"#5555ff",lightblue:"#55ffff",darkblue:"#0000aa",purple:"#aa00aa",pink:"#ff55ff"},proteus_mellow:{black:"#3d2d2e",white:"#ddf1fc",grey:"#9fb2d4",darkgrey:"#7b8272",lightgrey:"#a4bfda",gray:"#9fb2d4",darkgray:"#7b8272",lightgray:"#a4bfda",red:"#9d5443",darkred:"#8c5b4a",lightred:"#94614c",brown:"#89a78d",darkbrown:"#829e88",lightbrown:"#aaae97",orange:"#d1ba86",yellow:"#d6cda2",green:"#75ac8d",darkgreen:"#8fa67f",lightgreen:"#8eb682",blue:"#88a3ce",lightblue:"#a5adb0",darkblue:"#5c6b8c",purple:"#d39fac",pink:"#c8ac9e"},proteus_night:{black:"#010912",white:"#fdeeec",grey:"#051d40",darkgrey:"#091842",lightgrey:"#062151",gray:"#051d40",darkgray:"#091842",lightgray:"#062151",red:"#ad4576",darkred:"#934765",lightred:"#ab6290",brown:"#61646b",darkbrown:"#3d2d2d",lightbrown:"#8393a0",orange:"#0a2227",yellow:"#0a2541",green:"#75ac8d",darkgreen:"#0a2434",lightgreen:"#061f2e",blue:"#0b2c79",lightblue:"#809ccb",darkblue:"#08153b",purple:"#666a87",pink:"#754b4d"},proteus_rich:{black:"#6f686f",white:"#d1b1e2",grey:"#b9aac1",darkgrey:"#8e8b84",lightgrey:"#c7b5cd",gray:"#b9aac1",darkgray:"#8e8b84",lightgray:"#c7b5cd",red:"#a11f4f",darkred:"#934765",lightred:"#c998ad",brown:"#89867d",darkbrown:"#797f75",lightbrown:"#ab9997",orange:"#ce8c5c",yellow:"#f0d959",green:"#75bc54",darkgreen:"#599d79",lightgreen:"#90cf5c",blue:"#8fd0ec",lightblue:"#bcdce7",darkblue:"#0b2c70",purple:"#9b377f",pink:"#cd88e5"},amstrad:{black:"#000000",white:"#ffffff",grey:"#7f7f7f",darkgrey:"#636363",lightgrey:"#afafaf",gray:"#7f7f7f",darkgray:"#636363",lightgray:"#afafaf",red:"#ff0000",darkred:"#7f0000",lightred:"#ff7f7f",brown:"#ff7f00",darkbrown:"#7f7f00",lightbrown:"#ffff00",orange:"#ff007f",yellow:"#ffff7f",green:"#01ff00",darkgreen:"#007f00",lightgreen:"#7fff7f",blue:"#0000ff",lightblue:"#7f7fff",darkblue:"#00007f",purple:"#7f007f",pink:"#ff7fff"},c64:{black:"#000000",white:"#ffffff",grey:"#6C6C6C",darkgrey:"#444444",lightgrey:"#959595",gray:"#6C6C6C",darkgray:"#444444",lightgray:"#959595",red:"#68372B",darkred:"#3f1e17",lightred:"#9A6759",brown:"#433900",darkbrown:"#221c02",lightbrown:"#6d5c0d",orange:"#6F4F25",yellow:"#B8C76F",green:"#588D43",darkgreen:"#345129",lightgreen:"#9AD284",blue:"#6C5EB5",lightblue:"#70A4B2",darkblue:"#352879",purple:"#6F3D86",pink:"#b044ac"},whitingjp:{black:"#202527",white:"#eff8fd",grey:"#7b7680",darkgrey:"#3c3b44",lightgrey:"#bed0d7",gray:"#7b7680",darkgray:"#3c3b44",lightgray:"#bed0d7",red:"#bd194b",darkred:"#6b1334",lightred:"#ef2358",brown:"#b52e1c",darkbrown:"#681c12",lightbrown:"#e87b45",orange:"#ff8c10",yellow:"#fbd524",green:"#36bc3c",darkgreen:"#317610",lightgreen:"#8ce062",blue:"#3f62c6",lightblue:"#57bbe0",darkblue:"#2c2fa0",purple:"#7037d9",pink:"#ec2b8f"}};var reg_color_names=/(black|white|darkgray|lightgray|gray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink)\s*/,reg_color=/(black|white|gray|darkgray|lightgray|grey|darkgrey|lightgrey|red|darkred|lightred|brown|darkbrown|lightbrown|orange|yellow|green|darkgreen|lightgreen|blue|lightblue|darkblue|purple|pink|#(?:[0-9a-f]{3}){1,2})\s*/ </script> <script>function createSprite(a,b,c){b===undefined&&(b=[state.bgcolor,state.fgcolor]);var d=makeSpriteCanvas(),e=d.getContext("2d");e.clearRect(0,0,cellwidth,cellheight);var f=a[0].length,g=a.length,h=~~(cellwidth/(f+(c|0))),i=~~(cellheight/(g+(c|0))),j=i;"scanline"in state.metadata&&(j=Math.ceil(i/2)),e.fillStyle=state.fgcolor;for(var k=0;k<f;k++)for(var l=0;l<g;l++){var m=a[k][l];if(m>=0){var n=k*h|0,o=l*i|0;e.fillStyle=b[m],e.fillRect(o,n,h,j)}}return d}function regenText(a,b){textImages={};for(var c in font)font.hasOwnProperty(c)&&(textImages[c]=createSprite(font[c],undefined,1))}function regenSpriteImages(){regenText();if(state.levels.length===0)return;spriteimages=[];for(var a=0;a<sprites.length;a++){if(sprites[a]==undefined)continue;spriteimages[a]=createSprite(sprites[a].dat,sprites[a].colors)}canOpenEditor&&generateGlyphImages()}function makeSpriteCanvas(){var a=document.createElement("canvas");return a.width=cellwidth,a.height=cellheight,a}function generateGlyphImages(){glyphImagesCorrespondance=[],glyphImages=[];for(var a in state.glyphDict)if(a.length==1&&state.glyphDict.hasOwnProperty(a)){var b=state.glyphDict[a],c=makeSpriteCanvas(),d=c.getContext("2d");glyphImagesCorrespondance.push(a);for(var e=0;e<b.length;e++){var f=b[e];if(f===-1)continue;d.drawImage(spriteimages[f],0,0)}glyphImages.push(c)}glyphHighlight=makeSpriteCanvas();var d=glyphHighlight.getContext("2d");d.fillStyle="#FFFFFF",d.fillRect(0,0,cellwidth,1),d.fillRect(0,0,1,cellheight),d.fillRect(0,cellheight-1,cellwidth,1),d.fillRect(cellwidth-1,0,1,cellheight),glyphPrintButton=textImages.s,glyphHighlightResize=makeSpriteCanvas();var d=glyphHighlightResize.getContext("2d");d.fillStyle="#FFFFFF";var g=cellwidth/2-1|0,h=cellwidth-g-1-g,i=cellheight/2-1|0,j=cellheight-i-1-g;d.fillRect(g,0,h,cellheight),d.fillRect(0,i,cellwidth,j),glyphMouseOver=makeSpriteCanvas();var d=glyphMouseOver.getContext("2d");d.fillStyle="yellow",d.fillRect(0,0,cellwidth,2),d.fillRect(0,0,2,cellheight),d.fillRect(0,cellheight-2,cellwidth,2),d.fillRect(cellwidth-2,0,2,cellheight)}function glyphCount(){var a=0;for(var b in state.glyphDict)b.length==1&&state.glyphDict.hasOwnProperty(b)&&a++;return a}function redraw(){spriteimages===undefined&&regenSpriteImages();if(textMode){ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);for(var a=0;a<titleWidth;a++)for(var b=0;b<titleHeight;b++){var c=titleImage[b].charAt(a);if(c in textImages){var d=textImages[c];ctx.drawImage(d,xoffset+a*cellwidth,yoffset+b*cellheight)}}return}ctx.fillStyle=state.bgcolor,ctx.fillRect(0,0,canvas.width,canvas.height);var e=0,f=screenwidth,g=0,h=screenheight;if(levelEditorOpened){var i=glyphCount();editorRowCount=Math.ceil(i/(screenwidth-1)),f-=2,h-=2+editorRowCount}else if(flickscreen){var j=getPlayerPositions();if(j.length>0){var k=j[0],l=k/level.height|0,m=k%level.height|0,n=l/screenwidth|0,o=m/screenheight|0;e=n*screenwidth,g=o*screenheight,f=Math.min(e+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[e,g,f,h]}else oldflickscreendat.length>0&&(e=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3])}else if(zoomscreen){var j=getPlayerPositions();if(j.length>0){var k=j[0],l=k/level.height|0,m=k%level.height|0;e=Math.max(l-(screenwidth/2|0),0),g=Math.max(m-(screenheight/2|0),0),f=Math.min(e+screenwidth,level.width),h=Math.min(g+screenheight,level.height),oldflickscreendat=[e,g,f,h]}else oldflickscreendat.length>0&&(e=oldflickscreendat[0],g=oldflickscreendat[1],f=oldflickscreendat[2],h=oldflickscreendat[3])}for(var a=e;a<f;a++)for(var b=g;b<h;b++){var p=b+a*level.height,q=level.getCell(p);for(var r=0;r<state.objectCount;r++)if(q.get(r)!=0){var d=spriteimages[r];ctx.drawImage(d,xoffset+(a-e)*cellwidth,yoffset+(b-g)*cellheight)}}levelEditorOpened&&drawEditorIcons()}function drawEditorIcons(){var a=glyphImages.length,b=0,c=glyphImages.length,d=c-b;ctx.drawImage(glyphPrintButton,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount)),mouseCoordY===-1-editorRowCount&&mouseCoordX===-1&&ctx.drawImage(glyphMouseOver,xoffset-cellwidth,yoffset-cellheight*(1+editorRowCount));var e=editorRowCount-(-mouseCoordY-2)-1,f=mouseCoordX+(screenwidth-1)*e;for(var g=0;g<d;g++){var h=b+g,i=glyphImages[h],j=g%(screenwidth-1),e=g/(screenwidth-1)|0;ctx.drawImage(i,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),mouseCoordX>=0&&mouseCoordX<screenwidth-1&&f===g&&ctx.drawImage(glyphMouseOver,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount)),g===glyphSelectedIndex&&ctx.drawImage(glyphHighlight,xoffset+j*cellwidth,yoffset+e*cellheight-cellheight*(1+editorRowCount))}mouseCoordX>=-1&&mouseCoordY>=-1&&mouseCoordX<screenwidth-1&&mouseCoordY<screenheight-1-editorRowCount&&(mouseCoordX==-1||mouseCoordY==-1||mouseCoordX==screenwidth-2||mouseCoordY===screenheight-2-editorRowCount?ctx.drawImage(glyphHighlightResize,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight):ctx.drawImage(glyphHighlight,xoffset+mouseCoordX*cellwidth,yoffset+mouseCoordY*cellheight))}function canvasResize(){canvas.style.width=canvas.parentNode.clientWidth,canvas.style.height=canvas.parentNode.clientHeight,canvas.width=canvas.parentNode.clientWidth,canvas.height=canvas.parentNode.clientHeight,screenwidth=level.width,screenheight=level.height;if(state!==undefined){flickscreen=state.metadata.flickscreen!==undefined,zoomscreen=state.metadata.zoomscreen!==undefined;if(levelEditorOpened){screenwidth+=2;var a=glyphCount();editorRowCount=Math.ceil(a/(screenwidth-1)),screenheight+=2+editorRowCount}else flickscreen?(screenwidth=state.metadata.flickscreen[0],screenheight=state.metadata.flickscreen[1]):zoomscreen&&(screenwidth=state.metadata.zoomscreen[0],screenheight=state.metadata.zoomscreen[1])}textMode&&(levelEditorOpened=!1,screenwidth=titleWidth,screenheight=titleHeight),cellwidth=canvas.width/screenwidth,cellheight=canvas.height/screenheight;var b=5,c=5;textMode&&(b=6,c=6),cellwidth=b*~~(cellwidth/b),cellheight=c*~~(cellheight/c),xoffset=0,yoffset=0,cellwidth>cellheight?(cellwidth=cellheight,xoffset=(canvas.width-cellwidth*screenwidth)/2,yoffset=(canvas.height-cellheight*screenheight)/2):(cellheight=cellwidth,yoffset=(canvas.height-cellheight*screenheight)/2,xoffset=(canvas.width-cellwidth*screenwidth)/2),magnification=cellwidth/b*5|0,levelEditorOpened&&(xoffset+=cellwidth,yoffset+=cellheight*(1+editorRowCount)),cellwidth|=0,cellheight|=0,xoffset|=0,yoffset|=0;if(oldcellwidth!=cellwidth||oldcellheight!=cellheight||oldtextmode!=textMode||oldfgcolor!=state.fgcolor||forceRegenImages)forceRegenImages=!1,regenSpriteImages();oldcellheight=cellheight,oldcellwidth=cellwidth,oldtextmode=textMode,oldfgcolor=state.fgcolor,redraw()}var spriteimages,glyphImagesCorrespondance,glyphImages,glyphHighlight,glyphHighlightResize,glyphPrintButton,glyphMouseOver,glyphSelectedIndex=0,editorRowCount=1,canvas,ctx,x,y,cellwidth,cellheight,magnification,xoffset,yoffset;window.addEventListener("resize",canvasResize,!1),canvas=document.getElementById("gameCanvas"),ctx=canvas.getContext("2d"),x=0,y=0;var lastDownTarget,oldcellwidth=0,oldcellheight=0,oldtextmode=-1,oldfgcolor=-1,forceRegenImages=!1 </script> <script>function recalcLevelBounds(){}function arrCopy(a,b,c,d,e){while(e--)c[d++]=a[b]++}function adjustLevel(a,b,c){var d=a.clone();a.width+=b,a.height+=c,a.n_tiles=a.width*a.height,a.objects=new Int32Array(a.n_tiles*STRIDE);var e=new BitVec(STRIDE);e.ibitset(state.backgroundid);for(var f=0;f<a.n_tiles;++f)a.setCell(f,e);return a.movements=new Int32Array(a.objects.length),columnAdded=!0,d}function addLeftColumn(){var a=adjustLevel(level,1,0);for(var b=1;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-level.height))}}function addRightColumn(){var a=adjustLevel(level,1,0);for(var b=0;b<level.width-1;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}}function addTopRow(){var a=adjustLevel(level,0,1);for(var b=0;b<level.width;++b)for(var c=1;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b-1))}}function addBottomRow(){var a=adjustLevel(level,0,1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height-1;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d-b))}}function removeLeftColumn(){if(level.width<=1)return;var a=adjustLevel(level,-1,0);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+level.height))}}function removeRightColumn(){if(level.width<=1)return;var a=adjustLevel(level,-1,0);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d))}}function removeTopRow(){if(level.height<=1)return;var a=adjustLevel(level,0,-1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b+1))}}function removeBottomRow(){if(level.height<=1)return;var a=adjustLevel(level,0,-1);for(var b=0;b<level.width;++b)for(var c=0;c<level.height;++c){var d=b*level.height+c;level.setCell(d,a.getCell(d+b))}}function matchGlyph(a,b){var c=-1,d;for(var e=0;e<b.length;++e){var f=b[e][0],g=b[e][1];if(g.bitsSetInArray(a.data)){var h=0;for(var i=0;i<32*STRIDE;++i)g.get(i)&&a.get(i)&&h++;h>c&&(c=h,d=f)}}return c>0?d:(logErrorNoLine("Wasn't able to approximate a glyph value for some tiles, using '.' as a placeholder.",!0),".")}function printLevel(){var a=[];for(var b in state.glyphDict)if(state.glyphDict.hasOwnProperty(b)&&b.length===1){var c=state.glyphDict[b],d=new BitVec(STRIDE);for(var e=0;e<c.length;e++){var f=c[e];f>=0&&d.ibitset(f)}a.push([b,d.clone()]);var g=state.layerMasks[state.backgroundlayer];d.iclear(g),a.push([b,d.clone()]);for(var e=0;e<32;e++){var h=1<<e;g.get(e)&&(d.ibitset(e),a.push([b,d.clone()]),d.ibitclear(e))}}var i="Printing level contents:<br><br>";for(var j=0;j<level.height;j++){for(var e=0;e<level.width;e++){var k=j+e*level.height,l=level.getCell(k),c=matchGlyph(l,a);c in htmlEntityMap&&(c=htmlEntityMap[c]),i+=c}i+="<br>"}consolePrint(i)}function levelEditorClick(a,b){if(mouseCoordY<=-2){var c=editorRowCount-(-mouseCoordY-2)-1,d=mouseCoordX+(screenwidth-1)*c;mouseCoordX===-1?printLevel():mouseCoordX>=0&&d<glyphImages.length&&(glyphSelectedIndex=d,redraw())}else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var e=glyphImagesCorrespondance[glyphSelectedIndex],f=state.glyphDict[e],g=new BitVec(STRIDE);for(var h=0;h<f.length;h++){var i=f[h];i>=0&&g.ibitset(i)}var j=state.layerMasks[state.backgroundlayer];g.bitsClearInArray(j)&&g.ibitset(state.backgroundid);var k=mouseCoordY+mouseCoordX*level.height;level.setCell(k,g),redraw()}else b&&(mouseCoordX===-1?(addLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(addRightColumn(),canvasResize()),mouseCoordY===-1?(addTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(addBottomRow(),canvasResize()))}function levelEditorRightClick(a,b){if(mouseCoordY===-2)mouseCoordX<=glyphImages.length&&(glyphSelectedIndex=mouseCoordX,redraw());else if(mouseCoordX>-1&&mouseCoordY>-1&&mouseCoordX<screenwidth-2&&mouseCoordY<screenheight-2-editorRowCount){var c=mouseCoordY+mouseCoordX*level.height,d=new BitVec(STRIDE);d.ibitset(state.backgroundid),level.setCell(c,d),redraw()}else b&&(mouseCoordX===-1?(removeLeftColumn(),canvasResize()):mouseCoordX===screenwidth-2&&(removeRightColumn(),canvasResize()),mouseCoordY===-1?(removeTopRow(),canvasResize()):mouseCoordY===screenheight-2-editorRowCount&&(removeBottomRow(),canvasResize()))}function onMouseDown(a){if(a.button===0&&!a.ctrlKey&&!a.metaKey){lastDownTarget=a.target,keybuffer=[];if(a.target===canvas){setMouseCoord(a),dragging=!0,rightdragging=!1;if(levelEditorOpened)return levelEditorClick(a,!0)}dragging=!1,rightdragging=!1}else if(a.button===2||a.button===0&&(a.ctrlKey||a.metaKey)){dragging=!1,rightdragging=!0;if(levelEditorOpened)return levelEditorRightClick(a,!0)}}function rightClickCanvas(a){return prevent(a)}function onMouseUp(a){dragging=!1,rightdragging=!1}function onKeyDown(a){a=a||window.event,!IDE&&[32,37,38,39,40].indexOf(a.keyCode)>-1&&prevent(a);if(keybuffer.indexOf(a.keyCode)>=0)return;lastDownTarget===canvas&&keybuffer.indexOf(a.keyCode)===-1&&(keybuffer.splice(keyRepeatIndex,0,a.keyCode),keyRepeatTimer=0,checkKey(a,!0)),canDump===!0&&(a.keyCode===74&&(a.ctrlKey||a.metaKey)?(dumpTestCase(),prevent(a)):a.keyCode===75&&(a.ctrlKey||a.metaKey)&&(makeGIF(),prevent(a)))}function relMouseCoords(a){var b=0,c=0,d=0,e=0,f=this;do b+=f.offsetLeft-f.scrollLeft,c+=f.offsetTop-f.scrollTop;while(f=f.offsetParent);return d=a.pageX-b,e=a.pageY-c,{x:d,y:e}}function onKeyUp(a){a=a||window.event;var b=keybuffer.indexOf(a.keyCode);b>=0&&(keybuffer.splice(b,1),keyRepeatIndex>=b&&keyRepeatIndex--)}function onMyFocus(a){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function onMyBlur(a){keybuffer=[],keyRepeatIndex=0,keyRepeatTimer=0}function setMouseCoord(a){var b=canvas.relMouseCoords(a);mouseCoordX=b.x-xoffset,mouseCoordY=b.y-yoffset,mouseCoordX=Math.floor(mouseCoordX/cellwidth),mouseCoordY=Math.floor(mouseCoordY/cellheight)}function mouseMove(a){levelEditorOpened&&(setMouseCoord(a),dragging?levelEditorClick(a,!1):rightdragging&&levelEditorRightClick(a,!1),redraw())}function mouseOut(){}function prevent(a){return a.preventDefault&&a.preventDefault(),a.stopImmediatePropagation&&a.stopImmediatePropagation(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1,!1}function checkKey(a,b){if(winning)return;var c=-1;switch(a.keyCode){case 65:case 37:c=1;break;case 38:case 87:c=0;break;case 68:case 39:c=3;break;case 83:case 40:c=2;break;case 13:case 32:case 67:case 88:c=4;break;case 85:case 90:if(textMode===!1)return canDump===!0&&inputHistory.push("undo"),DoUndo(),canvasResize(),prevent(a);break;case 82:if(textMode===!1)return canDump===!0&&inputHistory.push("restart"),DoRestart(),canvasResize(),prevent(a);break;case 27:if(titleScreen===!1)return goToTitleScreen(),tryPlayTitleSound(),canvasResize(),prevent(a);break;case 69:if(canOpenEditor)return levelEditorOpened=!levelEditorOpened,canvasResize(),prevent(a);break;case 48:case 49:case 50:case 51:case 52:case 53:case 54:case 55:case 56:case 57:if(levelEditorOpened&&b){var d=9;return a.keyCode>=49&&(d=a.keyCode-49),d<glyphImages.length?glyphSelectedIndex=d:consolePrint("Trying to select tile outside of range in level editor."),canvasResize(),prevent(a)}}if(textMode){if(state.levels.length!==0)if(titleScreen){if(titleMode===0)c===4&&b&&titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),canvasResize());else if(c==4&&b)titleSelected===!1&&(tryPlayStartGameSound(),titleSelected=!0,messageselected=!1,timer=0,quittingTitleScreen=!0,generateTitleScreen(),redraw());else if(c===0||c===2)titleSelection=1-titleSelection,generateTitleScreen(),redraw()}else if(c==4&&b){if(unitTesting){nextLevel();return}messageselected===!1&&(messageselected=!0,timer=0,quittingMessageScreen=!0,tryPlayCloseMessageSound(),titleScreen=!1,drawMessageScreen())}}else if(!againing&&c>=0)return canDump===!0&&inputHistory.push(c),c===4&&"noaction"in state.metadata||processInput(c)&&redraw(),prevent(a)}function update(){timer+=deltatime,quittingTitleScreen&&timer/1e3>.3&&(quittingTitleScreen=!1,nextLevel()),againing&&timer>againinterval&&processInput(-1)&&redraw(),quittingMessageScreen&&timer/1e3>.15&&(quittingMessageScreen=!1,messagetext===""?nextLevel():(messagetext="",textMode=!1,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelected=!1,titleSelection=0,canvasResize(),checkWin())),winning&&timer/1e3>.5&&(winning=!1,nextLevel());if(keybuffer.length>0){keyRepeatTimer+=deltatime;if(keyRepeatTimer>repeatinterval/Math.sqrt(keybuffer.length)){keyRepeatTimer=0,keyRepeatIndex=(keyRepeatIndex+1)%keybuffer.length;var a=keybuffer[keyRepeatIndex];checkKey({keyCode:a},!1)}}autotickinterval>0&&!textMode&&(autotick+=deltatime,autotick>autotickinterval&&(autotick=0,processInput(-1)&&redraw()))}var keyRepeatTimer=0,keyRepeatIndex=0,dragging=!1,rightdragging=!1,columnAdded=!1,htmlEntityMap={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};HTMLCanvasElement.prototype.relMouseCoords=relMouseCoords;var mouseCoordX=0,mouseCoordY=0;document.addEventListener("mousedown",onMouseDown,!1),document.addEventListener("mouseup",onMouseUp,!1),document.addEventListener("keydown",onKeyDown,!1),document.addEventListener("keyup",onKeyUp,!1),window.addEventListener("focus",onMyFocus,!1),window.addEventListener("blur",onMyBlur,!1),setInterval(function(){update()},deltatime) </script> <script>function Animatable(a,b,c){function f(){var a;return d+=b,d>=1&&(a=!0,d=1),c(d),a}function g(){var a;return d-=b,d<=0&&(a=!0,d=0),c(d),a}var d,e;return e={animateUp:function(){Animator.getInstance().animate(a,f)},animateDown:function(){Animator.getInstance().animate(a,g)}},d=0,e}window.Mobile={},Mobile.hasTouch=function(){return document.documentElement&&document.documentElement.hasOwnProperty("ontouchstart")},Mobile.enable=function(a){if(a||Mobile.hasTouch()&&!Mobile._instance)Mobile._instance=new Mobile.GestureHandler,Mobile._instance.bindEvents(),Mobile._instance.bootstrap();return Mobile._instance},window.Mobile.GestureHandler=function(){this.initialize.apply(this,arguments)},Mobile.log=function(a){var b;b=document.getElementsByTagName("h1")[0],b.innerHTML=""+Math.random().toString().substring(4,1)+"-"+a},Mobile.debugDot=function(a){var b,c,d;d="border-radius: 50px;width: 5px;height: 5px;background: red;position: absolute;left: "+a.touches[0].clientX+"px;"+"top: "+a.touches[0].clientY+"px;",b=document.createElement("div"),b.setAttribute("style",d),console.log(d),c=document.getElementsByTagName("body")[0],c.appendChild(b)},function(a){"use strict";var b=10,c=50,d=1e3,e=150,f={action:88,left:37,right:39,up:38,down:40,undo:85,restart:82,quit:27},g=['<div class="tab">',' <div class="tab-affordance"></div>',' <div class="tab-icon">',' <div class="slice"></div>',' <div class="slice"></div>'," </div>","</div>"].join("\n");a.initialize=function(){this.firstPos={x:0,y:0},this.setTabAnimationRatio=this.setTabAnimationRatio.bind(this),this.setMenuAnimationRatio=this.setMenuAnimationRatio.bind(this),this.repeatTick=this.repeatTick.bind(this)},a.bindEvents=function(){window.addEventListener("touchstart",this.onTouchStart.bind(this)),window.addEventListener("touchend",this.onTouchEnd.bind(this)),window.addEventListener("touchmove",this.onTouchMove.bind(this))},a.bootstrap=function(){this.showTab(),this.isAudioSupported()||this.disableAudio(),this.disableSelection()},a.onTouchStart=function(a){if(this.isTouching)return;this.isTouching=!0,this.mayBeSwiping=!0,this.gestured=!1,this.swipeDirection=undefined,this.swipeDistance=0,this.startTime=(new Date).getTime(),this.firstPos.x=a.touches[0].clientX,this.firstPos.y=a.touches[0].clientY},a.onTouchEnd=function(a){if(!this.isTouching)return;this.gestured||a.touches.length===0&&this.handleTap(),a.touches.length===0&&(this.isTouching=!1,this.endRepeatWatcher())},a.onTouchMove=function(a){return this.isSuccessfulSwipe()?(this.handleSwipe(this.swipeDirection,this.touchCount),this.gestured=!0,this.mayBeSwiping=!1,this.beginRepeatWatcher(a)):this.mayBeSwiping?this.swipeStep(a):this.isRepeating&&this.repeatStep(a),prevent(a),!1},a.beginRepeatWatcher=function(a){var b;if(this.repeatInterval)return;this.isRepeating=!0,b=state.metadata.key_repeat_interval*1e3;if(isNaN(b)||!b)b=e;this.repeatInterval=setInterval(this.repeatTick,b),this.recenter(a)},a.endRepeatWatcher=function(){this.repeatInterval&&(clearInterval(this.repeatInterval),delete this.repeatInterval,this.isRepeating=!1)},a.repeatTick=function(){this.isTouching&&this.handleSwipe(this.direction,this.touchCount)},a.recenter=function(a){this.firstPos.x=a.touches[0].clientX,this.firstPos.y=a.touches[0].clientY},a.isSuccessfulSwipe=function(){var a;return this.mayBeSwiping&&this.swipeDirection!==undefined&&this.swipeDistance>=c&&(a=!0),a},a.swipeStep=function(a){var e,f,g,h;if(!this.mayBeSwiping)return;e={x:a.touches[0].clientX,y:a.touches[0].clientY},g=(new Date).getTime(),h=a.touches.length,this.swipeDistance=this.cardinalDistance(this.firstPos,e),this.swipeDirection?f<c?(direction=this.dominantDirection(this.firstPos,e),direction!==this.swipeDirection&&(this.mayBeSwiping=!1),h<this.touchCount&&(this.mayBeSwiping=!1)):g-this.startTime>d&&(this.mayBeSwiping=!1):this.swipeDistance>b&&(this.swipeDirection=this.dominantDirection(this.firstPos,e),this.touchCount=h)},a.repeatStep=function(a){var b,d,e,f,g;b={x:a.touches[0].clientX,y:a.touches[0].clientY},f=this.cardinalDistance(this.firstPos,b),f>=c&&(this.swipeDirection=this.dominantDirection(this.firstPos,b),this.recenter(a))},a.cardinalDistance=function(a,b){var c,d;return c=Math.abs(a.x-b.x),d=Math.abs(a.y-b.y),Math.max(c,d)},a.dominantDirection=function(a,b){var c,d,e,f;return c=b.x-a.x,d=b.y-a.y,e="x",Math.abs(d)>Math.abs(c)&&(e="y"),e==="x"?c>0?f="right":f="left":d>0?f="down":f="up",f},a.handleSwipe=function(a,b){b===1?this.emitKeydown(this.swipeDirection):b>1&&this.toggleMenu()},a.handleTap=function(){this.emitKeydown("action")},a.emitKeydown=function(a){var b;b={keyCode:f[a]},this.fakeCanvasFocus(),onKeyDown(b),onKeyUp(b)},a.fakeCanvasFocus=function(){var a;a=document.getElementById("gameCanvas"),onMouseDown({button:0,target:a})},a.toggleMenu=function(){this.isMenuVisible?this.hideMenu():this.showMenu()},a.showMenu=function(){this.menuElem||this.buildMenu(),this.getAnimatables().menu.animateUp(),this.isMenuVisible=!0,this.hideTab()},a.hideMenu=function(){this.menuElem&&this.getAnimatables().menu.animateDown(),this.isMenuVisible=!1,this.showTab()},a.getAnimatables=function(){var a=this;return this._animatables||(this._animatables={tab:Animatable("tab",.1,a.setTabAnimationRatio),menu:Animatable("menu",.1,a.setMenuAnimationRatio)}),this._animatables},a.showTab=function(){this.tabElem||this.buildTab(),this.getAnimatables().tab.animateDown()},a.hideTab=function(){this.tabElem&&this.tabElem.setAttribute("style","display: none;"),this.getAnimatables().tab.animateUp()},a.buildTab=function(){var a=this,b,c,d,e,f;b=document.createElement("div"),b.innerHTML=g,f=b.children[0],d=function(b){b.stopPropagation(),a.showMenu()},this.tabAffordance=f.getElementsByClassName("tab-affordance")[0],this.tabElem=f.getElementsByClassName("tab-icon")[0],this.tabAffordance.addEventListener("touchstart",d),this.tabElem.addEventListener("touchstart",d),c=document.getElementsByTagName("body")[0],c.appendChild(f)},a.buildMenu=function(){var a=this,b,c,d,e,f,g,h;b=document.createElement("div"),b.innerHTML=this.buildMenuString(state),this.menuElem=b.children[0],this.closeElem=this.menuElem.getElementsByClassName("close")[0],h=function(b){b.stopPropagation(),a.hideMenu()},this.closeAffordance=this.menuElem.getElementsByClassName("close-affordance")[0],g=this.menuElem.getElementsByClassName("close")[0],this.closeAffordance.addEventListener("touchstart",h),g.addEventListener("touchstart",h),d=this.menuElem.getElementsByClassName("undo")[0],d&&d.addEventListener("touchstart",function(b){b.stopPropagation(),a.emitKeydown("undo")}),e=this.menuElem.getElementsByClassName("restart")[0],e&&e.addEventListener("touchstart",function(b){b.stopPropagation(),a.emitKeydown("restart")}),f=this.menuElem.getElementsByClassName("quit")[0],f.addEventListener("touchstart",function(b){b.stopPropagation(),a.emitKeydown("quit")}),c=document.getElementsByTagName("body")[0],c.appendChild(this.menuElem)},a.buildMenuString=function(a){var b,c,d,e;return d=a.metadata.noundo,e=a.metadata.norestart,b=3,d&&(b-=1),e&&(b-=1),c=['<div class="mobile-menu item-count-'+b+'">',' <div class="close-affordance"></div>',' <div class="close">',' <div class="slice"></div>',' <div class="slice"></div>'," </div>"],d||c.push(' <div class="undo button">Undo</div>'),e||c.push(' <div class="restart button">Restart</div>'),c=c.concat([' <div class="quit button">Quit to Menu</div>',' <div class="clear"></div>',"</div>"]),c.join("\n")},a.setTabAnimationRatio=function(a){var b=18,c=66,d,e,f;a=Math.round(a*1e3)/1e3,a>=.999?this.tabAffordance.setAttribute("style","display: none;"):this.tabAffordance.setAttribute("style","display: block;"),d=c*a+b*(1-a),e="opacity: "+(1-a)+";",f=e+" "+"width: "+d+"px;",this.tabElem.setAttribute("style",f)},a.setMenuAnimationRatio=function(a){var b=-66,c=-18,d,e,f;a=Math.round(a*1e3)/1e3,a<=.001?this.closeAffordance.setAttribute("style","display: none;"):this.closeAffordance.setAttribute("style","display: block;"),d=c*a+b*(1-a),e="opacity: "+a+";",f="left: "+(d-4)+"px; "+e+" "+"width: "+ -d+"px;",this.closeElem.setAttribute("style",f),this.menuElem.setAttribute("style",e)},a.disableAudio=function(){window.playSeed=function(){}},a.isAudioSupported=function(){var a=!0;return webkitAudioContext&&(a=!1),a},a.disableSelection=function(){var a;a=document.getElementsByTagName("body")[0],a.setAttribute("class",a.getAttribute("class")+" disable-select")}}(window.Mobile.GestureHandler.prototype),window.Animator=function(){this.initialize.apply(this,arguments)},function(a){a.initialize=function(){this._animations={},this.tick=this.tick.bind(this)},a.animate=function(a,b){this._animations[a]=b,this.wakeup()},a.wakeup=function(){if(this._isAnimating)return;this._isAnimating=!0,this.tick()},a.tick=function(){var a,b,c,d,e;d=[],c=!0;for(a in this._animations){if(!this._animations.hasOwnProperty(a))return;b=this._animations[a](),b?d.push(a):c=!1}if(!c)requestAnimationFrame(this.tick);else{for(e=0;e<d.length;d++)delete this._isAnimating[d[e]];this._isAnimating=!1}}}(window.Animator.prototype),window.Animator.getInstance=function(){return window.Animator._instance||(window.Animator._instance=new window.Animator),window.Animator._instance},function(){"use strict";var a=["ms","moz","webkit","o"],b,c;for(b=0;b<a.length&&!window.requestAnimationFrame;b++)window.requestAnimationFrame=window[a[b]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[a[b]+"CancelAnimationFrame"],window.cancelAnimationFrame||(window.cancelAnimationFrame=window[a[b]+"CancelRequestAnimationFrame"]);window.requestAnimationFrame||(c=0,window.requestAnimationFrame=function(a,b){var d,e,f;return d=(new Date).getTime(),e=Math.max(0,16-(d-c)),f=window.setTimeout(function(){a(d+e)},e),c=d+e,f}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}() </script> <script>function unloadGame(){state=introstate,level=new Level(0,5,5,2,null),level.objects=new Int32Array(0),generateTitleScreen(),canvasResize(),redraw()}function generateTitleScreen(){titleMode=curlevel>0?1:0;if(state.levels.length===0){titleImage=intro_template;return}var a="PuzzleScript Game";state.metadata.title!==undefined&&(a=state.metadata.title),titleMode===0?titleSelected?titleImage=deepClone(titletemplate_firstgo_selected):titleImage=deepClone(titletemplate_firstgo):titleSelection===0?titleSelected?titleImage=deepClone(titletemplate_select0_selected):titleImage=deepClone(titletemplate_select0):titleSelected?titleImage=deepClone(titletemplate_select1_selected):titleImage=deepClone(titletemplate_select1);var b="noaction"in state.metadata,c="noundo"in state.metadata,d="norestart"in state.metadata;c&&d?titleImage[11]="..................................":c?titleImage[11]=".R to restart.....................":d&&(titleImage[11]=".Z to undo....................."),b&&(titleImage[10]="..................................");for(var e=0;e<titleImage.length;e++)titleImage[e]=titleImage[e].replace(/\./g," ");var f=titleImage[0].length,g=wordwrap(a,titleImage[0].length);for(var e=0;e<g.length;e++){var h=g[e],i=h.length,j=(f-i)/2|0,k=f-i-j,l=titleImage[1+e];titleImage[1+e]=l.slice(0,j)+h+l.slice(j+h.length)}if(state.metadata.author!==undefined){var m="by "+state.metadata.author,n=wordwrap(m,titleImage[0].length);for(var e=0;e<n.length;e++){var o=n[e],l=titleImage[3+e];titleImage[3+e]=l.slice(0,f-o.length-1)+o+l[l.length-1]}}}function deepClone(a){if(!a)return a;var b=[Number,String,Boolean],c;b.forEach(function(b){a instanceof b&&(c=b(a))});if(typeof c=="undefined")if(Object.prototype.toString.call(a)==="[object Array]")c=[],a.forEach(function(a,b,d){c[b]=deepClone(a)});else if(typeof a=="object")if(a.nodeType&&typeof a.cloneNode=="function")var c=a.cloneNode(!0);else if(!a.prototype)if(a instanceof Date)c=new Date(a);else{c={};for(var d in a)c[d]=deepClone(a[d])}else c=a;else c=a;return c}function wordwrap(a,b){b=b||75;var c=!0;if(!a)return a;var d=".{1,"+b+"}(\\s|$)"+(c?"|.{"+b+"}|.+$":"|\\S+?(\\s|$)");return a.match(RegExp(d,"g"))}function drawMessageScreen(){titleMode=0,textMode=!0,titleImage=deepClone(messagecontainer_template);for(var a=0;a<titleImage.length;a++)titleImage[a]=titleImage[a].replace(/\./g," ");var b=titleImage[0].length,c;if(messagetext===""){var d=state.levels[curlevel];c=d.message.trim()}else c=messagetext;splitMessage=wordwrap(c,titleImage[0].length);for(var a=0;a<splitMessage.length;a++){var e=splitMessage[a],f=5-(splitMessage.length/2|0)+a,g=e.length,h=(b-g)/2|0,i=b-g-h,j=titleImage[f];titleImage[f]=j.slice(0,h)+e+j.slice(h+e.length)}quittingMessageScreen&&(titleImage[10]=titleImage[9]),canvasResize()}function loadLevelFromState(a,b){forceRegenImages=!0,titleScreen=!1,titleMode=curlevel>0?1:0,titleSelection=curlevel>0?1:0,titleSelected=!1,curlevel=b,againing=!1;var c=a.levels[b];if(c===undefined){consolePrint("Trying to access a level that doesn't exist.");return}if(c.message===undefined){titleMode=0,textMode=!1,level=c.clone(),level.movements=new Int32Array(level.objects.length),level.rigidMovementAppliedMask=[],level.rigidGroupIndexMask=[],level.rowCellContents=[],level.colCellContents=[],level.mapCellContents=0;for(var d=0;d<level.height;d++)level.rowCellContents[d]=0;for(var d=0;d<level.width;d++)level.colCellContents[d]=0;for(var d=0;d<level.n_tiles;d++)level.movements[d]=0,level.rigidMovementAppliedMask[d]=0,level.rigidGroupIndexMask[d]=0;backups=[],restartTarget=backupLevel(),"run_rules_on_level_start"in a.metadata&&processInput(-1,!0),b===0?tryPlayStartLevelSound():tryPlayStartLevelSound()}else tryPlayShowMessageSound(),drawMessageScreen(),canvasResize();canDump===!0&&(inputHistory=[])}function tryPlaySimpleSound(a){if(state.sfx_Events[a]!==undefined){var b=state.sfx_Events[a];playSeed(b)}}function tryPlayTitleSound(){tryPlaySimpleSound("titlescreen")}function tryPlayStartGameSound(){tryPlaySimpleSound("startgame")}function tryPlayEndGameSound(){tryPlaySimpleSound("endgame")}function tryPlayStartLevelSound(){tryPlaySimpleSound("startlevel")}function tryPlayEndLevelSound(){tryPlaySimpleSound("endlevel")}function tryPlayUndoSound(){tryPlaySimpleSound("undo")}function tryPlayRestartSound(){tryPlaySimpleSound("restart")}function tryPlayShowMessageSound(){tryPlaySimpleSound("showmessage")}function tryPlayCloseMessageSound(){tryPlaySimpleSound("closemessage")}function backupLevel(){var a=new Int32Array(level.objects);return a.width=level.width,a.height=level.height,a}function setGameState(a,b){oldflickscreendat=[],timer=0,autotick=0,winning=!1,againing=!1,messageselected=!1,b===undefined&&(b=["restart"]),state.levels.length===0&&b.length>0&&b[0]==="rebuild"&&(b=["restart"]),state=a,window.console.log("setting game state :D "),backups=[],sprites=[];for(var c in state.objects)if(state.objects.hasOwnProperty(c)){var d=state.objects[c],e={colors:d.colors,dat:d.spritematrix};sprites[d.id]=e}state.metadata.realtime_interval!==undefined?(autotick=0,autotickinterval=state.metadata.realtime_interval*1e3,logBetaMessage("realtime_interval is a beta feature, its behaviour may change before it ends up in launch. I would advise against circulating this game for wider distribution before then.",!0)):(autotick=0,autotickinterval=0),state.metadata.key_repeat_interval!==undefined?repeatinterval=state.metadata.key_repeat_interval*1e3:repeatinterval=150,state.metadata.again_interval!==undefined?againinterval=state.metadata.again_interval*1e3:againinterval=150;switch(b[0]){case"restart":winning=!1,timer=0,titleScreen=!0,tryPlayTitleSound(),textMode=!0,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,curlevel>0&&(titleMode=1),generateTitleScreen();break;case"rebuild":break;case"loadLevel":var f=b[1];curlevel=h,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,f);break;case"levelline":var g=b[1];for(var h=state.levels.length-1;h>=0;h--){var i=state.levels[h];if(i.lineNumber<=g+1){curlevel=h,winning=!1,timer=0,titleScreen=!1,textMode=!1,titleSelection=curlevel>0?1:0,titleSelected=!1,quittingMessageScreen=!1,quittingTitleScreen=!1,messageselected=!1,titleMode=0,loadLevelFromState(state,h);break}}}canDump===!0&&(inputHistory=[]),canvasResize();if(canYoutube&&"youtube"in state.metadata){var j=state.metadata.youtube,k="https://youtube.googleapis.com/v/"+j+"?autoplay=1&loop=1&playlist="+j;ifrm=document.createElement("IFRAME"),ifrm.setAttribute("src",k),ifrm.style.visibility="hidden",ifrm.style.width="500px",ifrm.style.height="500px",ifrm.style.position="absolute",ifrm.style.top="-1000px",ifrm.style.left="-1000px",document.body.appendChild(ifrm)}}function restoreLevel(a){oldflickscreendat=[],level.objects=new Int32Array(a);if(level.width!==a.width||level.height!==a.height)level.width=a.width,level.height=a.height,level.n_tiles=a.width*a.height,level.movements=new Int32Array(level.objects.length);for(var b=0;b<level.n_tiles;b++)level.movements[b]=0,level.rigidMovementAppliedMask[b]=0,level.rigidGroupIndexMask[b]=0;for(var b=0;b<level.height;b++)level.rowCellContents[b]=0;for(var b=0;b<level.width;b++)level.colCellContents[b]=0;againing=!1,messagetext="",level.commandQueue=[]}function DoRestart(a){if(a!==!0&&"norestart"in state.metadata)return;a===!1&&backups.push(backupLevel()),verbose_logging&&consolePrint("--- restarting ---"),restoreLevel(restartTarget),tryPlayRestartSound(),"run_rules_on_level_start"in state.metadata&&processInput(-1,!0),level.commandQueue=[]}function DoUndo(a){if("noundo"in state.metadata&&a!==!0)return;verbose_logging&&consolePrint("--- undoing ---");if(backups.length>0){var b=backups[backups.length-1];restoreLevel(b),backups=backups.splice(0,backups.length-1),tryPlayUndoSound()}}function getPlayerPositions(){var a=[],b=state.playerMask;for(i=0;i<level.n_tiles;i++){var c=level.getCell(i);b.anyBitsInCommon(c)&&a.push(i)}return a}function getLayersOfMask(a){var b=[];for(var c=0;c<state.objectCount;c++)if(a.get(c)){var d=state.idDict[c],e=state.objects[d];b.push(e.layer)}return b}function moveEntitiesAtIndex(a,b,c){var d=level.getCell(a);d.iand(b);var e=getLayersOfMask(d),f=level.getMovements(a);for(var g=0;g<e.length;g++)f.ishiftor(c,5*e[g]);level.setMovements(a,f)}function startMovement(a){var b=!1,c=getPlayerPositions();for(var d=0;d<c.length;d++){var e=c[d];moveEntitiesAtIndex(e,state.playerMask,a)}return c}function repositionEntitiesOnLayer(a,b,c){var d=dirMasksDelta[c],e=d[0],f=d[1],g=a/level.height|0,h=a%level.height|0,i=level.width-1,j=level.height-1;if(g===0&&e<0||g===i&&e>0||h===0&&f<0||h===j&&f>0)return!1;var k=(a+d[1]+d[0]*level.height)%level.n_tiles,l=state.layerMasks[b],m=level.getCell(k),n=level.getCell(a);if(l.anyBitsInCommon(m)&&c!=16)return!1;var o=n.clone();n.iclear(l),o.iand(l),m.ior(o),level.setCell(a,n),level.setCell(k,m);var p=k/level.height|0,q=k%level.height;level.colCellContents[p].ior(o),level.rowCellContents[q].ior(o),level.mapCellContents.ior(l);for(var r=0;r<state.sfx_MovementMasks.length;r++){var s=state.sfx_MovementMasks[r],t=s.objectMask;if(t.anyBitsInCommon(n)){var u=level.movementMask[a],v=s.directionMask;u.anyBitsInCommon(v)&&seedsToPlay_CanMove.indexOf(s.seed)===-1&&seedsToPlay_CanMove.push(s.seed)}}return!0}function repositionEntitiesAtCell(a){var b=level.getMovements(a);if(b.iszero())return!1;var c=!1;for(var d=0;d<level.layerCount;d++){var e=b.getshiftor(31,5*d);if(e!==0){var f=repositionEntitiesOnLayer(a,d,e);f&&(b.ishiftclear(e,5*d),c=!0)}}return level.setMovements(a,b),c}function Level(a,b,c,d,e){this.lineNumber=a,this.width=b,this.height=c,this.n_tiles=b*c,this.objects=e,this.layerCount=d}function BitVec(a){return this.data=new Int32Array(a),this}function Rule(a){this.direction=a[0],this.patterns=a[1],this.hasReplacements=a[2],this.lineNumber=a[3],this.isEllipsis=a[4],this.groupNumber=a[5],this.isRigid=a[6],this.commands=a[7],this.isRandom=a[8],this.cellRowMasks=a[9]}function CellPattern(a){this.objectsPresent=a[0],this.objectsMissing=a[1],this.movementsPresent=a[2],this.movementsMissing=a[3],this.matches=this.generateMatchFunction(),this.replacement=a[4]}function CellReplacement(a){this.objectsClear=a[0],this.objectsSet=a[1],this.movementsClear=a[2],this.movementsSet=a[3],this.movementsLayerMask=a[4],this.randomEntityMask=a[5],this.randomDirMask=a[6]}function cellRowMatchesWildCard(a,b,c,d,e){e===undefined&&(e=0);var f=b[0],g=dirMasksDelta[a],h=[];if(f.matches(c)){var i=c;for(var j=1;j<b.length;j+=1){i=(i+g[1]+g[0]*level.height)%level.n_tiles;var f=b[j];if(f===ellipsisPattern){for(var k=e;k<d;k++){var l=i;l=(l+g[1]*k+g[0]*k*level.height+level.n_tiles)%level.n_tiles;for(var m=j+1;m<b.length;m++){f=b[m];if(!f.matches(l))break;l=(l+g[1]+g[0]*level.height)%level.n_tiles}m>=b.length&&h.push([c,k])}break}if(!f.matches(i))break}}return h}function cellRowMatches(a,b,c,d){var e=b[0],f=dirMasksDelta[a];if(e.matches(c)){var g=c;for(var h=1;h<b.length;h++){g=(g+f[1]+f[0]*level.height)%level.n_tiles,e=b[h],e===ellipsisPattern&&(g=(g+f[1]*d+f[0]*d*level.height)%level.n_tiles);if(!e.matches(g))break}if(h>=b.length)return!0}return!1}function matchCellRow(a,b,c){var d=[];if(!c.bitsSetInArray(level.mapCellContents.data))return d;var e=0,f=level.width,g=0,h=level.height,i=b.length|0;switch(a){case 1:g+=i-1;break;case 2:h-=i-1;break;case 4:e+=i-1;break;case 8:f-=i-1;break;default:window.console.log("EEEP "+a)}var j=a>2;if(j)for(var k=g;k<h;k++){if(!c.bitsSetInArray(level.rowCellContents[k].data))continue;for(var l=e;l<f;l++){var m=l*level.height+k;cellRowMatches(a,b,m)&&d.push(m)}}else for(var l=e;l<f;l++){if(!c.bitsSetInArray(level.colCellContents[l].data))continue;for(var k=g;k<h;k++){var m=l*level.height+k;cellRowMatches(a,b,m)&&d.push(m)}}return d}function matchCellRowWildCard(a,b,c){var d=[];if(!c.bitsSetInArray(level.mapCellContents.data))return d;var e=0,f=level.width,g=0,h=level.height,i=(b.length|0)-1;switch(a){case 1:g+=i-1;break;case 2:h-=i-1;break;case 4:e+=i-1;break;case 8:f-=i-1;break;default:window.console.log("EEEP2 "+a)}var j=a>2;if(j)for(var k=g;k<h;k++){if(!c.bitsSetInArray(level.rowCellContents[k].data))continue;for(var l=e;l<f;l++){var m=l*level.height+k,n;a===4?n=l-i+2:a===8?n=level.width-(l+i)+1:window.console.log("EEEP2 "+a),d.push.apply(d,cellRowMatchesWildCard(a,b,m,n))}}else for(var l=e;l<f;l++){if(!c.bitsSetInArray(level.colCellContents[l].data))continue;for(var k=g;k<h;k++){var m=l*level.height+k,n;a===2?n=level.height-(k+i)+1:a===1?n=k-i+2:window.console.log("EEEP2 "+a),d.push.apply(d,cellRowMatchesWildCard(a,b,m,n))}}return d}function generateTuples(a){var b=[[]];for(var c=0;c<a.length;c++){var d=a[c],e=[];for(var f=0;f<d.length;f++){var g=d[f];for(var h=0;h<b.length;h++){var i=b[h],j=i.concat([g]);e.push(j)}}b=e}return b}function commitPreservationState(a){var b={ruleGroupIndex:a,objects:new Int32Array(level.objects),movements:new Int32Array(level.movements),rigidGroupIndexMask:level.rigidGroupIndexMask.concat([]),rigidMovementAppliedMask:level.rigidMovementAppliedMask.concat([]),bannedGroup:level.bannedGroup.concat([])};return rigidBackups[a]=b,b}function restorePreservationState(a){level.objects=new Int32Array(a.objects),level.movements=new Int32Array(a.movements),level.rigidGroupIndexMask=a.rigidGroupIndexMask.concat([]),level.rigidMovementAppliedMask=a.rigidMovementAppliedMask.concat([]),sfxCreateMask=new BitVec(STRIDE),sfxDestroyMask=new BitVec(STRIDE)}function showTempMessage(){keybuffer=[],textMode=!0,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,tryPlayShowMessageSound(),drawMessageScreen(),canvasResize()}function applyRandomRuleGroup(a){var b=!1,c=[];for(var d=0;d<a.length;d++){var e=a[d],f=e.findMatches();if(f.length>0){var g=generateTuples(f);for(var h=0;h<g.length;h++){var i=g[h];c.push([d,i])}}}if(c.length===0)return!1;var j=c[Math.floor(Math.random()*c.length)],d=j[0],e=a[d],k=dirMasksDelta[e.direction],i=j[1],l=!1,m=e.applyAt(k,i,l);return e.queueCommands(),m}function applyRuleGroup(a){if(a[0].isRandom)return applyRandomRuleGroup(a);var b=!1,c=!0,d=0;while(c){d++;if(d>200){logError("Got caught looping lots in a rule group :O",a[0].lineNumber,!0);break}c=!1;for(var e=0;e<a.length;e++){var f=a[e];c=f.tryApply()||c}c&&(b=!0)}return b}function propagateMovements(a,b,c){var d=c>0,e=0;for(var f=c;f<a.length;){if(!level.bannedGroup[f]){var g=a[f];d=applyRuleGroup(g)||d}if(d&&b[f]!==undefined){f=b[f],d=!1,e++;if(e>200){var g=a[f];logError("got caught in an endless startloop...endloop vortex, escaping!",g[0].lineNumber,!0);break}}else{f++;if(f===a.length&&d&&b[f]!==undefined){f=b[f],d=!1,e++;if(e>200){var g=a[f];logError("got caught in an endless startloop...endloop vortex, escaping!",g[0].lineNumber,!0);break}}}}}function resolveMovements(a){var b=!0;while(b){b=!1;for(var c=0;c<level.n_tiles;c++)b=repositionEntitiesAtCell(c)||b}var d=!1;for(var c=0;c<level.n_tiles;c++){var e=level.getCell(c),f=level.getMovements(c);if(!f.iszero()){var g=level.rigidMovementAppliedMask[c];if(g!==0){f.iand(g);if(!f.iszero())for(var h=0;h<level.layerCount;h++){var i=f.getshiftor(31,5*h);if(i!==0){var j=level.rigidGroupIndexMask[c],k=j.getshiftor(31,5*h);k--;var l=state.rigidGroupIndex_to_GroupIndex[k];level.bannedGroup[l]=!0,d=!0;break}}}for(var h=0;h<state.sfx_MovementFailureMasks.length;h++){var m=state.sfx_MovementFailureMasks[h],n=m.objectMask;if(n.anyBitsInCommon(e)){var o=m.directionMask;f.anyBitsInCommon(o)&&seedsToPlay_CantMove.indexOf(m.seed)===-1&&seedsToPlay_CantMove.push(m.seed)}}}level.setMovements(c,new BitVec(STRIDE)),level.rigidGroupIndexMask[c]=0,level.rigidMovementAppliedMask[c]=0}return d}function calculateRowColMasks(){level.mapCellContents=new BitVec(STRIDE);for(var a=0;a<level.width;a++)level.colCellContents[a]=new BitVec(STRIDE);for(var b=0;b<level.height;b++)level.rowCellContents[b]=new BitVec(STRIDE);for(var a=0;a<level.width;a++)for(var b=0;b<level.height;b++){var c=b+a*level.height,d=level.getCell(c);level.mapCellContents.ior(d),level.rowCellContents[b].ior(d),level.colCellContents[a].ior(d)}}function processInput(a,b,c){againing=!1,verbose_logging&&(cache_log_messages=!0,a===-1?consolePrint("Turn starts with no input."):(consolePrint("======================="),consolePrint("Turn starts with input of "+["up","left","down","right","action"][a]+".")));var d=backupLevel(),e=[];if(a<=4){if(a>=0){switch(a){case 0:a=parseInt("00001",2);break;case 1:a=parseInt("00100",2);break;case 2:a=parseInt("00010",2);break;case 3:a=parseInt("01000",2);break;case 4:a=parseInt("10000",2)}e=startMovement(a)}var f=0,g=!0;level.bannedGroup=[],rigidBackups=[],level.commandQueue=[];var h=0,i=!1,j=commitPreservationState();messagetext="",sfxCreateMask=new BitVec(STRIDE),sfxDestroyMask=new BitVec(STRIDE),seedsToPlay_CanMove=[],seedsToPlay_CantMove=[],calculateRowColMasks();while(g||i){g=!1,i=!1,f++,verbose_logging&&consolePrint("applying rules"),propagateMovements(state.rules,state.loopPoint,h);var k=resolveMovements();k?(i=!0,restorePreservationState(j),h=0):(verbose_logging&&consolePrint("applying late rules"),propagateMovements(state.lateRules,state.lateLoopPoint,0),h=0)}f>=50&&window.console.log("looped through 50 times, gave up. too many loops!");if(e.length>0&&state.metadata.require_player_movement!==undefined){var l=!1;for(var f=0;f<e.length;f++){var m=e[f],n=level.getCell(m);if(state.playerMask.bitsClearInArray(n.data)){l=!0;break}}if(l===!1)return consolePrint("require_player_movement set, but no player movement detected, so cancelling turn."),backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!1}if(level.commandQueue.indexOf("cancel")>=0)return verbose_logging&&consolePrint("CANCEL command executed, cancelling turn."),backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!1;if(level.commandQueue.indexOf("restart")>=0)return verbose_logging&&consolePrint("RESTART command executed, reverting to restart state."),backups.push(d),DoRestart(!0),verbose_logging&&consoleCacheDump(),!0;var o=!1;for(var f=0;f<level.objects.length;f++)if(level.objects[f]!==d[f]){if(c)return backups.push(d),DoUndo(!0),verbose_logging&&consoleCacheDump(),!0;a!==-1&&backups.push(d),o=!0;break}if(c)return verbose_logging&&consoleCacheDump(),!1;for(var f=0;f<seedsToPlay_CantMove.length;f++)playSeed(seedsToPlay_CantMove[f]);for(var f=0;f<seedsToPlay_CanMove.length;f++)playSeed(seedsToPlay_CanMove[f]);for(var f=0;f<state.sfx_CreationMasks.length;f++){var p=state.sfx_CreationMasks[f];sfxCreateMask.anyBitsInCommon(p.objectMask)&&playSeed(p.seed)}for(var f=0;f<state.sfx_DestructionMasks.length;f++){var p=state.sfx_DestructionMasks[f];sfxDestroyMask.anyBitsInCommon(p.objectMask)&&playSeed(p.seed)}for(var f=0;f<level.commandQueue.length;f++){var q=level.commandQueue[f];q.charAt(1)==="f"&&tryPlaySimpleSound(q),unitTesting===!1&&q==="message"&&showTempMessage()}if(level.commandQueue.indexOf("again")>=0&&o){var r=verbose_logging;processInput(-1,!0,!0)&&(verbose_logging&&consolePrint("AGAIN command executed, with changes detected: will execute another turn."),againing=!0,timer=0),verbose_logging=r}level.commandQueue.indexOf("checkpoint")>=0&&(verbose_logging&&consolePrint("CHECKPOINT command executed, saving current state to the restart state."),restartTarget=backupLevel()),textMode===!1&&(b===undefined||b===!1)&&(verbose_logging&&consolePrint("Checking win condition."),checkWin()),level.commandQueue=[]}return verbose_logging&&consoleCacheDump(),o}function checkWin(){if(levelEditorOpened)return;if(level.commandQueue.indexOf("win")>=0){consolePrint("Win Condition Satisfied"),DoWin();return}var a=!1;if(state.winconditions.length>0){var b=!0;for(var c=0;c<state.winconditions.length;c++){var d=state.winconditions[c],e=d[1],f=d[2],g=!0;switch(d[0]){case-1:for(var h=0;h<level.n_tiles;h++){var i=level.getCell(h);if(!e.bitsClearInArray(i.data)&&!f.bitsClearInArray(i.data)){g=!1;break}}break;case 0:var j=!1;for(var h=0;h<level.n_tiles;h++){var i=level.getCell(h);if(!e.bitsClearInArray(i.data)&&!f.bitsClearInArray(i.data)){j=!0;break}}j===!1&&(g=!1);break;case 1:for(var h=0;h<level.n_tiles;h++){var i=level.getCell(h);if(!e.bitsClearInArray(i.data)&&f.bitsClearInArray(i.data)){g=!1;break}}}g===!1&&(b=!1)}a=b}a&&(consolePrint("Win Condition Satisfied"),DoWin())}function DoWin(){if(winning)return;againing=!1,tryPlayEndLevelSound();if(unitTesting){nextLevel();return}winning=!0,timer=0}function anyMovements(){for(var a=0;a<level.movementMask.length;a++)if(level.movementMask[a]!==0)return!0;return!1}function nextLevel(){keybuffer=[],againing=!1,messagetext="",titleScreen?(titleSelection===0&&(curlevel=0),loadLevelFromState(state,curlevel)):curlevel<state.levels.length-1?(curlevel++,textMode=!1,titleScreen=!1,quittingMessageScreen=!1,messageselected=!1,loadLevelFromState(state,curlevel)):(curlevel=0,goToTitleScreen(),tryPlayEndGameSound());try{!window.localStorage||(localStorage[document.URL]=curlevel)}catch(a){}canvasResize(),canDump===!0&&(inputHistory=[])}function goToTitleScreen(){againing=!1,messagetext="",titleScreen=!0,textMode=!0,titleSelection=curlevel>0?1:0,generateTitleScreen()}var intro_template=["..................................","..................................","..................................","......Puzzle Script Terminal......","..............v 1.0...............","..................................","..................................","..................................",".........insert cartridge.........","..................................","..................................","..................................",".................................."],messagecontainer_template=["..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..................................","..........X to continue...........","..................................",".................................."],titletemplate_firstgo=["..................................","..................................","..................................","..................................","..................................","..................................","..........#.start game.#..........","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0=["..................................","..................................","..................................","..................................","..................................","...........#.new game.#...........","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","...........#.continue.#...........","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_firstgo_selected=["..................................","..................................","..................................","..................................","..................................","..................................","###########.start game.###########","..................................","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select0_selected=["..................................","..................................","..................................","..................................","..................................","############.new game.############","..................................",".............continue.............","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titletemplate_select1_selected=["..................................","..................................","..................................","..................................","..................................",".............new game.............","..................................","############.continue.############","..................................",".arrow keys to move...............",".X to action......................",".Z to undo, R to restart..........",".................................."],titleImage=[],titleWidth=titletemplate_select1[0].length,titleHeight=titletemplate_select1.length,textMode=!0,titleScreen=!0,titleMode=0,titleSelection=0,titleSelected=!1,introstate={title:"2D Whale World",attribution:"increpare",objectCount:2,metadata:[],levels:[],bgcolor:"#000000",fgcolor:"#FFFFFF"},state=introstate,splitMessage=[],sprites=[{color:"#423563",dat:[[1,1,1,1,1],[1,0,0,0,1],[1,0,0,0,1],[1,0,0,0,1],[1,1,1,1,1]]},{color:"#252342",dat:[[0,0,1,0,0],[1,1,1,1,1],[0,0,1,0,0],[0,1,1,1,0],[0,1,0,1,0]]}];generateTitleScreen(),canvasResize();var backups=[],restartTarget,messagetext="",zoomscreen=!1,flickscreen=!1,screenwidth=0,screenheight=0,dirMasksDelta={1:[0,-1],2:[0,1],4:[-1,0],8:[1,0],15:[0,0],16:[0,0],3:[0,0]},dirMaskName={1:"up",2:"down",4:"left",8:"right",15:"?",16:"action",3:"no"},seedsToPlay_CanMove=[],seedsToPlay_CantMove=[];Level.prototype.clone=function(){var a=new Level(this.lineNumber,this.width,this.height,this.layerCount,null);return a.objects=new Int32Array(this.objects),a},Level.prototype.getCell=function(a){return new BitVec(this.objects.subarray(a*STRIDE,a*STRIDE+STRIDE))},Level.prototype.setCell=function(a,b){for(var c=0;c<b.data.length;++c)this.objects[a*STRIDE+c]=b.data[c]},Level.prototype.getMovements=function(a){return new BitVec(this.movements.subarray(a*STRIDE,a*STRIDE+STRIDE))},Level.prototype.setMovements=function(a,b){for(var c=0;c<b.data.length;++c)this.movements[a*STRIDE+c]=b.data[c]};var ellipsisPattern=["ellipsis"];BitVec.prototype.clone=function(){return new BitVec(this.data)},BitVec.prototype.iand=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=a.data[b]},BitVec.prototype.ior=function(a){for(var b=0;b<this.data.length;++b)this.data[b]|=a.data[b]},BitVec.prototype.iclear=function(a){for(var b=0;b<this.data.length;++b)this.data[b]&=~a.data[b]},BitVec.prototype.ibitset=function(a){this.data[a>>5]|=1<<(a&31)},BitVec.prototype.ibitclear=function(a){this.data[a>>5]&=~(1<<(a&31))},BitVec.prototype.get=function(a){return(this.data[a>>5]&1<<(a&31))!==0},BitVec.prototype.getshiftor=function(a,b){var c=this.data[b>>5]>>>(b&31);return b&31&&(c|=this.data[(b>>5)+1]<<32-(b&31)),c&a},BitVec.prototype.ishiftor=function(a,b){var c=a<<(b&31),d=a>>32-(b&31);this.data[b>>5]|=c,d&&(this.data[(b>>5)+1]|=d)},BitVec.prototype.ishiftclear=function(a,b){var c=a<<(b&31),d=a>>32-(b&31);this.data[b>>5]&=~c,d&&(this.data[(b>>5)+1]&=~d)},BitVec.prototype.equals=function(a){if(this.data.length!==a.data.length)return!1;for(var b=0;b<this.data.length;++b)if(this.data[b]!==a.data[b])return!1;return!0},BitVec.prototype.iszero=function(){for(var a=0;a<this.data.length;++a)if(this.data[a])return!1;return!0},BitVec.prototype.bitsSetInArray=function(a){for(var b=0;b<this.data.length;++b)if((this.data[b]&a[b])!==this.data[b])return!1;return!0},BitVec.prototype.bitsClearInArray=function(a){for(var b=0;b<this.data.length;++b)if(this.data[b]&a[b])return!1;return!0},BitVec.prototype.anyBitsInCommon=function(a){return!this.bitsClearInArray(a.data)},Rule.prototype.toJSON=function(){return[this.direction,this.patterns,this.hasReplacements,this.lineNumber,this.isEllipsis,this.groupNumber,this.isRigid,this.commands,this.isRandom,this.cellRowMasks]};var STRIDE=1;CellPattern.prototype.matches=function(a){var b=level.getCell(a),c=level.getMovements(a);return this.objectsPresent.bitsSetInArray(b.data)&&this.objectsMissing.bitsClearInArray(b.data)&&this.movementsPresent.bitsSetInArray(c.data)&&this.movementsMissing.bitsClearInArray(c.data)};var matchCache={};CellPattern.prototype.generateMatchFunction=function(){var i,fn="(function(i) {\n\ti=i|0;\n",mul=STRIDE===1?"":"*"+STRIDE;for(var i=0;i<STRIDE;++i)fn+="\tvar cellObjects"+i+" = level.objects[i"+mul+(i?"+"+i:"")+"]|0;\n",fn+="\tvar cellMovements"+i+" = level.movements[i"+mul+(i?"+"+i:"")+"]|0;\n";fn+="\t return (true \n";for(var i=0;i<STRIDE;++i){var co="cellObjects"+i,cm="cellMovements"+i,op=this.objectsPresent.data[i],om=this.objectsMissing.data[i],mp=this.movementsPresent.data[i],mm=this.movementsMissing.data[i];op&&(op&op-1?fn+="\t\t&& (("+co+"&"+op+")==="+op+")\n":fn+="\t\t&& ("+co+"&"+op+")\n"),om&&(fn+="\t\t&& !("+co+"&"+om+")\n"),mp&&(mp&mp-1?fn+="\t\t&& (("+cm+"&"+mp+")==="+mp+")\n":fn+="\t\t&& ("+cm+"&"+mp+")\n"),mm&&(fn+="\t\t&& !("+cm+"&"+mm+")\n")}return fn+="\t);\n})",fn in matchCache?matchCache[fn]:matchCache[fn]=eval(fn)},CellPattern.prototype.toJSON=function(){return[this.movementMask,this.cellMask,this.nonExistenceMask,this.moveNonExistenceMask,this.moveStationaryMask,this.randomDirOrEntityMask,this.movementsToRemove]},CellPattern.prototype.replace=function(a,b){var c=this.replacement;if(c===null)return!1;var d=c.randomEntityMask,e=c.randomDirMask,f=c.objectsSet.clone(),g=c.objectsClear.clone(),h=c.movementsSet.clone(),i=c.movementsClear.clone();i.ior(c.movementsLayerMask);if(!d.iszero()){var j=[];for(var k=0;k<32*STRIDE;k++)d.get(k)&&j.push(k);var l=j[Math.floor(Math.random()*j.length)],m=state.idDict[l],n=state.objects[m];f.ibitset(l),g.ior(state.layerMasks[n.layer]),i.ishiftor(31,5*n.layer)}if(!e.iszero())for(var o=0;o<level.layerCount;o++)if(e.get(5*o)){var p=Math.floor(Math.random()*4);h.ibitset(p+5*o)}var q=level.getCell(b),r=level.getMovements(b),s=q.clone(),t=r.clone();q.iclear(g),q.ior(f),r.iclear(i),r.ior(h);var u=!1,v=0,w=0;if(a.isRigid){rigidCommitted=!0;var x=state.groupNumber_to_RigidGroupIndex[a.groupNumber];x++;var y=new BitVec(STRIDE);for(var z=0;z<level.layerCount;z++)y.ishiftor(x,z*5);y.iand(c.movementsLayerMask),v=level.rigidGroupIndexMask[b]||new BitVec(STRIDE),w=level.rigidMovementAppliedMask[b]||new BitVec(STRIDE);if(!y.bitsSetInArray(v.data)||!c.movementsLayerMask.bitsSetInArray(w.data))v.ior(y),w.ior(c.movementsLayerMask),u=!0}var A=!1;if(!s.equals(q)||!t.equals(r)||u){A=!0,u&&(level.rigidGroupIndexMask[b]=v,level.rigidMovementAppliedMask[b]=w);var B=q.clone();B.iclear(s),sfxCreateMask.ior(B);var C=s.clone();C.iclear(q),sfxDestroyMask.ior(C),level.setCell(b,q),level.setMovements(b,r);var D=b/level.height|0,E=b%level.height;level.colCellContents[D].ior(q),level.rowCellContents[E].ior(q),level.mapCellContents.ior(q)}return A};var rigidBackups=[];Rule.prototype.findMatches=function(){var a=[],b=this.cellRowMasks;for(var c=0;c<this.patterns.length;c++){var d=this.patterns[c];if(this.isEllipsis[c])var e=matchCellRowWildCard(this.direction,d,b[c]);else var e=matchCellRow(this.direction,d,b[c]);if(e.length===0)return[];a.push(e)}return a},Rule.prototype.applyAt=function(a,b,c){var d=this;if(c){var e=!0;for(var f=0;f<d.patterns.length;f++)if(d.isEllipsis[f]){if(cellRowMatchesWildCard(d.direction,d.patterns[f],b[f][0],b[f][1]+1,b[f][1]).length===0){e=!1;break}}else if(cellRowMatches(d.direction,d.patterns[f],b[f]).length===0){e=!1;break}if(e===!1)return!1}var g=!1,h=!1;for(var f=0;f<d.patterns.length;f++){var i=d.patterns[f],j=d.isEllipsis[f]?b[f][0]:b[f];for(var k=0;k<i.length;k++){var l=i[k];if(l===ellipsisPattern){var m=b[f][1];j=(j+a[1]*m+a[0]*m*level.height)%level.n_tiles;continue}g=l.replace(d,j)||g,j=(j+a[1]+a[0]*level.height)%level.n_tiles}}if(verbose_logging&&g){var n=dirMaskName[d.direction],o='<font color="green">Rule <a onclick="jumpToLine('+d.lineNumber+');" href="javascript:void(0);">'+d.lineNumber+"</a>"+n+" applied.</font>";consolePrint(o)}return g},Rule.prototype.tryApply=function(){var a=dirMasksDelta[this.direction],b=this.findMatches();if(b.length===0)return!1;var c=!1;if(this.hasReplacements){var d=generateTuples(b);for(var e=0;e<d.length;e++){var f=d[e],g=e>0;c=this.applyAt(a,f,g)||c}}return b.length>0&&this.queueCommands(),c},Rule.prototype.queueCommands=function(){var a=this.commands;for(var b=0;b<a.length;b++){var c=a[b],d=!1;if(level.commandQueue.indexOf(c[0])>=0)continue;level.commandQueue.push(c[0]);if(verbose_logging){var e=this.lineNumber,f=dirMaskName[this.direction],g='<font color="green">Rule <a onclick="jumpToLine('+e.toString()+');" href="javascript:void(0);">'+e.toString()+"</a> triggers command "+c[0]+".</font>";consolePrint(g)}c[0]==="message"&&(messagetext=c[1])}};var sfxCreateMask=0,sfxDestroyMask=0 </script> <script>onmousemove="mouseMove(event)",onmouseout="mouseOut()";var el=document.getElementById("gameCanvas");el.addEventListener?(el.addEventListener("contextmenu",rightClickCanvas,!1),el.addEventListener("mousemove",mouseMove,!1),el.addEventListener("mouseout",mouseOut,!1)):(el.attachEvent("oncontextmenu",rightClickCanvas),el.attachEvent("onmousemove",mouseMove),el.attachEvent("onmouseout",mouseOut)) </script> <script>var loadableGameDat=__GAMEDAT__;setGameState(loadableGameDat) </script> </body> </html> 